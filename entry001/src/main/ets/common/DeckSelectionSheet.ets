import { DECK_LIST, DeckTheme, OBS_ROOT_URL } from '../model/TarotData';
import { promptAction } from '@kit.ArkUI';
import { IAPManager } from './IAPManager';
import common from '@ohos.app.ability.common';
import preferences from '@ohos.data.preferences';

/**
 * ç‰Œç»„é€‰æ‹©/è´­ä¹°ç»„ä»¶
 * åŠŸèƒ½ï¼šå±•ç¤ºå¯ç”¨ç‰Œç»„åˆ—è¡¨ï¼Œæ”¯æŒé¢„è§ˆã€åŽä¸º IAP è´­ä¹°è§£é”å’Œåˆ‡æ¢å½“å‰ä½¿ç”¨çš„ç‰Œç»„
 */
@Component
export struct DeckSelectionSheet {
  // ðŸ”— ä¸Ž AppStorage åŒå‘ç»‘å®šï¼Œè‡ªåŠ¨åŒæ­¥å½“å‰é€‰ä¸­çš„ç‰Œç»„æ–‡ä»¶å¤¹
  @StorageLink('CurrentDeckFolder') currentDeckFolder: string = DECK_LIST[0].folder;
  
  // ðŸ”— æŽ§åˆ¶å¼¹çª—æ˜¾ç¤ºçš„ç»‘å®šå˜é‡
  @Link isOpen: boolean;
  
  // ðŸ’¾ å·²æ‹¥æœ‰çš„ç‰Œç»„ ID åˆ—è¡¨
  @State ownedDecks: string[] = ['default']; 
  
  private context = getContext(this) as common.UIAbilityContext;
  private iapManager = IAPManager.getInstance();

  async aboutToAppear() {
    this.iapManager.init(this.context);
    await this.loadOwnedDecks();
  }

  // åŠ è½½å·²è´­ä¹°çš„ç‰Œç»„
  async loadOwnedDecks() {
    try {
      const prefs = await preferences.getPreferences(this.context, 'user_preferences');
      const savedDecks = await prefs.get('owned_decks', ['default']) as string[];
      this.ownedDecks = savedDecks;
    } catch (e) {
      console.error('Failed to load owned decks:', e);
    }
  }

  // ä¿å­˜å·²è´­ä¹°çš„ç‰Œç»„
  async saveOwnedDeck(deckId: string) {
    try {
      if (!this.ownedDecks.includes(deckId)) {
        this.ownedDecks.push(deckId);
        const prefs = await preferences.getPreferences(this.context, 'user_preferences');
        await prefs.put('owned_decks', this.ownedDecks);
        await prefs.flush();
      }
    } catch (e) {
      console.error('Failed to save owned deck:', e);
    }
  }

  async handlePurchase(deck: DeckTheme) {
    const success = await this.iapManager.buyProduct(deck.productId);
    if (success) {
      await this.saveOwnedDeck(deck.id);
      this.currentDeckFolder = deck.folder; // è´­ä¹°åŽè‡ªåŠ¨åˆ‡æ¢
      promptAction.showToast({ message: `ðŸŽ‰ è§£é”æˆåŠŸï¼å·²åˆ‡æ¢è‡³ ${deck.name}` });
    } else {
      promptAction.showToast({ message: 'æ”¯ä»˜æœªå®Œæˆ' });
    }
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨æŠŠæ‰‹æ¡ (è§†è§‰æç¤ºå¯æ‹–åŠ¨)
      Row()
        .width(40)
        .height(4)
        .backgroundColor('#E0E0E0')
        .borderRadius(2)
        .margin({ top: 12, bottom: 20 })

      // 2. æ ‡é¢˜
      Text('ðŸ”® ç‰Œç»„å·¥åŠ')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 20 })

      // 3. ç‰Œç»„åˆ—è¡¨
      List({ space: 16 }) {
        ForEach(DECK_LIST, (deck: DeckTheme) => {
          ListItem() {
            Row() {
              // ðŸ–¼ï¸ ç‰Œç»„é¢„è§ˆå›¾ (ç›´æŽ¥æ‹¼æŽ¥è¯¥ç‰Œç»„çš„è·¯å¾„)
              Image(`${OBS_ROOT_URL}${deck.folder}${deck.preview}`)
                .width(60)
                .height(100)
                .borderRadius(8)
                .objectFit(ImageFit.Cover)
                .backgroundColor('#f0f0f0')

              // ðŸ“ ç‰Œç»„ä¿¡æ¯
              Column({ space: 8 }) {
                Text(deck.name)
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                
                Text(deck.desc)
                  .fontSize(12)
                  .fontColor('#999')
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })

                // ðŸ”˜ æ“ä½œæŒ‰é’®åŒºåŸŸ
                Row() {
                  if (this.currentDeckFolder === deck.folder) {
                    // çŠ¶æ€ï¼šä½¿ç”¨ä¸­
                    Text('ä½¿ç”¨ä¸­')
                      .fontSize(12)
                      .fontColor('#4CAF50')
                      .backgroundColor('#E8F5E9')
                      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                      .borderRadius(12)
                  } else {
                     // é€»è¾‘ï¼šåˆ¤æ–­æ˜¯å¦æ‹¥æœ‰ (å…è´¹æˆ–å·²è´­ä¹°)
                     if (deck.price === 0 || this.ownedDecks.includes(deck.id)) {
                        Button('ä½¿ç”¨')
                          .fontSize(12)
                          .height(28)
                          .backgroundColor('#2196F3')
                          .onClick(() => {
                            this.currentDeckFolder = deck.folder; // åˆ‡æ¢å…¨å±€ç‰Œç»„
                            promptAction.showToast({ message: `å·²åˆ‡æ¢è‡³: ${deck.name}` });
                          })
                     } else {
                        // ðŸ’° è´­ä¹°æŒ‰é’® (äººæ°‘å¸)
                        Button(`Â¥ ${deck.price.toFixed(2)} è´­ä¹°`)
                          .fontSize(12)
                          .height(28)
                          .backgroundColor('#FF5252')
                          .onClick(() => {
                            this.handlePurchase(deck);
                          })
                     }
                  }
                }
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Start)
              .margin({ left: 16 })
            }
            .padding(16)
            .backgroundColor('#FAFAFA')
            .borderRadius(16)
            .width('100%')
          }
        })
      }
      .layoutWeight(1)
      .width('100%')
      .padding({ left: 16, right: 16 })

      // 4. å…³é—­æŒ‰é’®
      Button('å…³é—­')
        .width('90%')
        .height(48)
        .margin({ bottom: 16, top: 16 })
        .backgroundColor('#F5F5F5')
        .fontColor('#666')
        .onClick(() => {
          this.isOpen = false;
        })
    }
    .height('65%')
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 24, topRight: 24 })
  }
}