import http from '@ohos.net.http';
import { UserManager } from './UserManager';
import { FortuneManager } from './FortuneManager';

export class CloudService {
  // ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šæ¢æˆä½ çš„åä¸ºäº‘æœåŠ¡å™¨å…¬ç½‘ IP
  private static readonly BASE_URL = 'http://1.94.149.144:3000/api';
  private static readonly SERVER_ROOT = 'http://1.94.149.144:3000';

  static async checkConnection(): Promise<boolean> {
    const httpRequest = http.createHttp();
    try {
      const response = await httpRequest.request(`${CloudService.SERVER_ROOT}/`, {
        method: http.RequestMethod.GET,
        readTimeout: 3000,
        connectTimeout: 3000
      });
      return response.responseCode === 200;
    } catch (err) {
      return false;
    } finally {
      httpRequest.destroy();
    }
  }

  static async backupData(userId: string, token: string, allData: string): Promise<boolean> {
    const httpRequest = http.createHttp();
    try {
      const response = await httpRequest.request(`${CloudService.BASE_URL}/sync/upload`, {
        method: http.RequestMethod.POST,
        header: { 'Content-Type': 'application/json' },
        extraData: { userId: userId, token: token, data: JSON.parse(allData) },
        expectDataType: http.HttpDataType.OBJECT,
      });
      if (response.responseCode === 200) {
        const res = response.result as Record<string, Object>;
        return res['code'] === 200;
      }
      return false;
    } catch (err) {
      return false;
    } finally {
      httpRequest.destroy();
    }
  }

  static async restoreData(userId: string, token: string): Promise<string | null> {
    const httpRequest = http.createHttp();
    try {
      const response = await httpRequest.request(`${CloudService.BASE_URL}/sync/download`, {
        method: http.RequestMethod.POST,
        header: { 'Content-Type': 'application/json' },
        extraData: { userId: userId, token: token },
        expectDataType: http.HttpDataType.OBJECT,
      });
      if (response.responseCode === 200) {
        const res = response.result as Record<string, Object>;
        if (res['code'] === 200 && res['data']) {
          return JSON.stringify(res['data']);
        }
      }
      return null;
    } catch (err) {
      return null;
    } finally {
      httpRequest.destroy();
    }
  }

  // è‡ªåŠ¨é™é»˜å¤‡ä»½
  static async autoSave() {
    const userMgr = UserManager.getInstance();
    const fortuneMgr = FortuneManager.getInstance();

    const user = userMgr.getCurrentUser();
    if (!userMgr.isLoggedIn() || !user) {
      return;
    }

    const allData = await fortuneMgr.exportAllData();

    // ä½¿ç”¨ç±»åè°ƒç”¨
    CloudService.backupData(user.userId, user.token, allData).then((success) => {
      if (success) console.info('âœ… CloudService: è‡ªåŠ¨å¤‡ä»½æˆåŠŸ');
      else console.warn('âš ï¸ CloudService: è‡ªåŠ¨å¤‡ä»½å¤±è´¥');
    });
  }

  // è‡ªåŠ¨é™é»˜æ¢å¤
  static async autoRestore(): Promise<boolean> {
    const userMgr = UserManager.getInstance();
    const fortuneMgr = FortuneManager.getInstance();

    const user = userMgr.getCurrentUser();
    if (!userMgr.isLoggedIn() || !user) return false;

    // ä½¿ç”¨ç±»åè°ƒç”¨
    const jsonStr = await CloudService.restoreData(user.userId, user.token);

    if (jsonStr) {
      await fortuneMgr.importData(jsonStr);
      console.info('âœ… CloudService: æ•°æ®å·²åŒæ­¥è‡³æœ¬åœ°');
      return true;
    }
    return false;
  }
}