import http from '@ohos.net.http';
import { promptAction } from '@kit.ArkUI';

export class CloudService {
  // ğŸ”´ ä½ çš„æœåŠ¡å™¨åœ°å€ (ç¡®ä¿ç«¯å£æ˜¯ 3000)
  private static readonly BASE_URL = 'http://115.190.137.87:3000/api';
  private static readonly SERVER_ROOT = 'http://115.190.137.87:3000';

  /**
   * ğŸ’“ æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€
   * @returns true è¡¨ç¤ºè¿æ¥æ­£å¸¸
   */
  static async checkConnection(): Promise<boolean> {
    const httpRequest = http.createHttp();
    try {
      // è¯·æ±‚æ ¹è·¯å¾„ï¼Œçœ‹æ˜¯å¦è¿”å› "æ­£å¼ç‰ˆæœåŠ¡å™¨è¿è¡Œæ­£å¸¸"
      const response = await httpRequest.request(
        `${CloudService.SERVER_ROOT}/`,
        {
          method: http.RequestMethod.GET,
          readTimeout: 3000,
          connectTimeout: 3000
        }
      );
      return response.responseCode === 200;
    } catch (err) {
      console.error('CloudService: è¿æ¥æ£€æŸ¥å¤±è´¥', JSON.stringify(err));
      return false;
    } finally {
      httpRequest.destroy();
    }
  }

  /**
   * ğŸ“¤ ä¸Šä¼ å¤‡ä»½æ•°æ®
   */
  static async backupData(userId: string, token: string, allData: string): Promise<boolean> {
    const httpRequest = http.createHttp();
    try {
      console.info('CloudService: å¼€å§‹ä¸Šä¼ å¤‡ä»½...');
      const response = await httpRequest.request(
        `${CloudService.BASE_URL}/sync/upload`,
        {
          method: http.RequestMethod.POST,
          header: { 'Content-Type': 'application/json' },
          extraData: {
            userId: userId,
            token: token,
            data: JSON.parse(allData)
          },
          expectDataType: http.HttpDataType.OBJECT,
          readTimeout: 10000,
          connectTimeout: 10000
        }
      );

      if (response.responseCode === 200) {
        const res = response.result as Record<string, Object>;
        return res['code'] === 200;
      }
      return false;
    } catch (err) {
      console.error('CloudService: ä¸Šä¼ å¤±è´¥', JSON.stringify(err));
      promptAction.showToast({ message: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ' });
      return false;
    } finally {
      httpRequest.destroy();
    }
  }

  /**
   * ğŸ“¥ ä»äº‘ç«¯ä¸‹è½½æ¢å¤æ•°æ®
   */
  static async restoreData(userId: string, token: string): Promise<string | null> {
    const httpRequest = http.createHttp();
    try {
      console.info('CloudService: å¼€å§‹ä¸‹è½½å¤‡ä»½...');
      const response = await httpRequest.request(
        `${CloudService.BASE_URL}/sync/download`,
        {
          method: http.RequestMethod.POST,
          header: { 'Content-Type': 'application/json' },
          extraData: {
            userId: userId,
            token: token
          },
          expectDataType: http.HttpDataType.OBJECT,
          readTimeout: 10000,
          connectTimeout: 10000
        }
      );

      if (response.responseCode === 200) {
        const res = response.result as Record<string, Object>;
        if (res['code'] === 200 && res['data']) {
          return JSON.stringify(res['data']);
        }
      }
      return null;
    } catch (err) {
      console.error('CloudService: ä¸‹è½½å¤±è´¥', JSON.stringify(err));
      promptAction.showToast({ message: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ' });
      return null;
    } finally {
      httpRequest.destroy();
    }
  }
}