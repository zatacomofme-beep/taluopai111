// è·¯å¾„: ets/common/ShareHelper.ts
// V3.2 ä¿®å¤ç‰ˆï¼šé€‚é… HarmonyOS NEXT Kit å¯¼å…¥è§„èŒƒï¼Œè§£å†³æ¨¡å—æ‰¾ä¸åˆ°çš„é—®é¢˜

// ğŸ› ï¸ æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ @kit.xxx æ›¿ä»£ @ohos.xxx
import { systemShare } from '@kit.ShareKit';
import { common } from '@kit.AbilityKit';
import { componentSnapshot } from '@kit.ArkUI';
import { image } from '@kit.ImageKit';
import { fileIo as fs, fileUri } from '@kit.CoreFileKit';
import { uniformTypeDescriptor as utd } from '@kit.ArkData';
import { promptAction } from '@kit.ArkUI';
import { BusinessError } from '@kit.BasicServicesKit'; // ç”¨äºé”™è¯¯ç±»å‹æ–­è¨€

export class ShareHelper {
  /**
   * æˆªå–ç»„ä»¶å¹¶è°ƒç”¨ç³»ç»Ÿåˆ†äº«
   * @param context ä¸Šä¸‹æ–‡
   * @param componentId ç»„ä»¶ID
   */
  static async snapshotAndShare(context: common.UIAbilityContext, componentId: string) {
    try {
      promptAction.showToast({ message: 'æ­£åœ¨ç”Ÿæˆåˆ†äº«å¡ç‰‡...', duration: 1000 });

      // 1. ç»„ä»¶æˆªå›¾
      const pixelMap = await componentSnapshot.get(componentId);

      // 2. ä¿å­˜åˆ°æ²™ç®± (Cache ç›®å½•)
      const fileName = `tarot_share_${new Date().getTime()}.jpg`;
      const filePath = `${context.cacheDir}/${fileName}`;

      const imagePacker = image.createImagePacker();
      const packOpts: image.PackingOption = { format: 'image/jpeg', quality: 90 };
      const data = await imagePacker.packing(pixelMap, packOpts);

      const file = fs.openSync(filePath, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE);
      fs.writeSync(file.fd, data);
      fs.closeSync(file);

      // 3. è·å– URI
      // ä½¿ç”¨ Kit å¯¼å…¥åçš„ fileUri
      const uri = fileUri.getUriFromPath(filePath);

      // 4. æ„å»ºåˆ†äº«æ•°æ®
      const utdTypeId = utd.getUniformDataTypeByFilenameExtension('.jpg', utd.UniformDataType.IMAGE);

      const shareData = new systemShare.SharedData({
        utd: utdTypeId,
        uri: uri,
        title: 'æ²»æ„ˆä¹‹ä¹¦ Â· ä»Šæ—¥æŒ‡å¼•',
        description: 'å¿«æ¥çœ‹çœ‹æˆ‘çš„å¡”ç½—ç‰Œè¿åŠ¿å§ï¼',
        thumbnail: new Uint8Array(data)
      });

      // æ·»åŠ è®°å½•
      shareData.addRecord({
        utd: utdTypeId,
        uri: uri
      });

      // 5. å¯åŠ¨ç³»ç»Ÿåˆ†äº«é¢æ¿
      const controller = new systemShare.ShareController(shareData);
      await controller.show(context, {
        selectionMode: systemShare.SelectionMode.SINGLE,
        previewMode: systemShare.SharePreviewMode.DEFAULT
      });

    } catch (err) {
      // ğŸ› ï¸ ä¿®å¤ï¼šæ˜¾å¼æ–­è¨€é”™è¯¯ç±»å‹ï¼Œè§£å†³ Strict Mode æŠ¥é”™
      const error = err as BusinessError;
      console.error(`ShareHelper Error: ${error.code} - ${error.message}`);
      promptAction.showToast({ message: 'åˆ†äº«è°ƒèµ·å¤±è´¥ï¼Œè¯·é‡è¯•', duration: 2000 });
    }
  }
}