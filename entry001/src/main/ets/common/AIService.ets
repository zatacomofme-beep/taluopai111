import http from '@ohos.net.http';
import common from '@ohos.app.ability.common';
import { TarotCard } from '../model/TarotData';
import { EnergyManager } from './EnergyManager';
import { FortuneManager, MoodToday } from './FortuneManager';

export interface ChatMessage {
  role: "system" | "user" | "assistant";
  content: string;
}

interface AIMessageContent {
  content: string;
}
interface AIChoice {
  message: AIMessageContent;
}
interface AIResponse {
  choices: AIChoice[];
}

export class AIService {
  // ğŸ”´ ä½ çš„æœåŠ¡å™¨åœ°å€
  private static readonly MY_SERVER_URL = 'http://115.190.137.87:3000/api/ai/chat';

  public static readonly COST_PER_CHAT = 2;
  public static readonly COST_DEEP_ANALYSIS = 5;

  static createInitialPrompt(cards: TarotCard[], lastMood?: MoodToday): string {
    let moodInstruction = "";
    let openingInstruction = "";

    // åœºæ™¯ 1ï¼šæœ‰å¿ƒæƒ…è®°å½•
    if (lastMood && lastMood.mood !== -1) {
      const emojis = ['ğŸ˜­ æ‚²ä¼¤', 'ğŸ˜• å›°æƒ‘', 'ğŸ™‚ å¹³é™', 'ğŸ˜Š å¼€å¿ƒ', 'ğŸ¥³ ç‹‚å–œ'];
      const moodText = emojis[lastMood.mood] || 'æœªçŸ¥';
      const noteText = lastMood.note ? `å¤‡æ³¨ï¼šâ€œ${lastMood.note}â€` : '';

      moodInstruction = `ã€ç”¨æˆ·å½“å‰çŠ¶æ€ã€‘ï¼š${moodText}ã€‚${noteText}ã€‚`;

      // å…³é”®ä¿®æ”¹ï¼šæ˜ç¡®è¦æ±‚ç¬¬ä¸€å¥å…ˆå›åº”å¿ƒæƒ…ï¼Œå†è‡ªç„¶è¿‡æ¸¡åˆ°ç‰Œé¢
      openingInstruction = `
      1. **å¼€åœºç™½ï¼ˆæƒ…æ„Ÿå…±é¸£ + ç‰Œé¢åˆ‡å…¥ï¼‰**ï¼š
         - ç¬¬ä¸€å¥å¿…é¡»å…ˆå›åº”ç”¨æˆ·çš„å¿ƒæƒ…ï¼ˆä¾‹å¦‚ï¼šâ€œçœ‹åˆ°ä½ æœ€è¿‘æœ‰äº›ä½è½ï¼ŒæŠ±æŠ±ä½ â€æˆ–â€œå¾ˆé«˜å…´ä½ ä»Šå¤©çŠ¶æ€ä¸é”™â€ï¼‰ã€‚
         - ç´§æ¥ç€ï¼ˆåœ¨åŒä¸€æ®µè½ä¸­ï¼‰ï¼Œç”¨â€œä¸è¿‡â€æˆ–â€œåŒæ—¶â€è½¬æŠ˜ï¼Œå¼•å‡ºå¯¹ç¬¬ä¸€å¼ ç‰Œçš„å†·è¯»ã€‚
         - **æœ€ç»ˆæ•ˆæœè¦æ±‚**ï¼šåƒæ˜¯ä¸€ä¸ªè€æœ‹å‹å…ˆå®‰æ…°ä½ ï¼Œç„¶åé©¬ä¸ŠæŒ‡ç€æ¡Œä¸Šçš„ç‰Œè¯´æ­£äº‹ã€‚
      `;
    } else {
      // åœºæ™¯ 2ï¼šæ²¡æœ‰å¿ƒæƒ…è®°å½• -> ç›´æ¥å†·è¯»
      openingInstruction = `
      1. **å¼€åœºç™½ï¼ˆç›´å‡»é‡ç‚¹ï¼‰**ï¼š
         - è¯·åŠ¡å¿…ç›´æ¥ä»¥â€œä»â€˜${cards[0].name}â€™è¿™å¼ ä»£è¡¨è¿‡å»çš„ç‰Œé¢æ¥çœ‹ï¼Œä½ æœ€è¿‘æ­£åœ¨ç»å†...â€å¼€å¤´ã€‚
         - çœç•¥å¯’æš„ï¼Œå•åˆ€ç›´å…¥ã€‚
      `;
    }

    return `
      ${moodInstruction}
      ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œã€ç›´è§‰æ•é”ä¸”å……æ»¡äººæ–‡å…³æ€€çš„å¡”ç½—å’¨è¯¢å¸ˆã€‚ä½ çš„é£æ ¼æ˜¯ï¼š**å…ˆå…±æƒ…ï¼Œåç†æ€§ï¼›å…ˆçœ‹è§äººï¼Œå†çœ‹è§ç‰Œ**ã€‚

      ç‰Œé˜µä¿¡æ¯ï¼ˆæ—¶å…‰æµï¼‰ï¼š
      1. ã€è¿‡å»ã€‘ï¼š${cards[0].name} (${cards[0].meaning})
      2. ã€ç°åœ¨ã€‘ï¼š${cards[1].name} (${cards[1].meaning})
      3. ã€æœªæ¥ã€‘ï¼š${cards[2].name} (${cards[2].meaning})

      è§£è¯»ç»“æ„è¦æ±‚ï¼š
      ${openingInstruction}
      2. **æ·±åº¦å‰–æ**ï¼šç»“åˆâ€œ${cards[1].name}â€æ­ç¤ºå½“ä¸‹çš„æ ¸å¿ƒçŸ›ç›¾ï¼Œä¸è¦åªè§£é‡Šç‰Œä¹‰ï¼Œè¦è”ç³»ç”Ÿæ´»åœºæ™¯ã€‚
      3. **å…·ä½“å»ºè®®**ï¼šåŸºäºâ€œ${cards[2].name}â€ï¼Œç»™å‡º1-2æ¡å¯æ‰§è¡Œçš„è¡ŒåŠ¨å»ºè®®ï¼ˆä¸è¦è™šæ— ç¼¥ç¼ˆçš„é¸¡æ±¤ï¼‰ã€‚
      4. **è¯­è°ƒ**ï¼šæ¸©æš–è€Œåšå®šï¼Œæ—¢æœ‰å¿ƒç†å’¨è¯¢å¸ˆçš„åŒ…å®¹ï¼Œåˆæœ‰åˆ†æå¸ˆçš„çŠ€åˆ©ã€‚

      å­—æ•°æ§åˆ¶åœ¨300å­—å·¦å³ã€‚
    `;
  }

  // requestChat æ–¹æ³•ä¿æŒä¸å˜...
  static async requestChat(history: ChatMessage[], context: common.UIAbilityContext, isInitialAnalysis: boolean = false): Promise<string> {
    const energyMgr = EnergyManager.getInstance();
    const cost = isInitialAnalysis ? AIService.COST_DEEP_ANALYSIS : AIService.COST_PER_CHAT;

    if (!energyMgr.hasEnough(cost)) {
      return `âœ¨ å¿ƒåŠ›å€¼ä¸è¶³ (${energyMgr.getEnergy()}/${cost})ã€‚\n\nè¯·å»é¦–é¡µç‚¹å‡»é—ªç”µå›¾æ ‡è¡¥å……å¿ƒåŠ›ã€‚`;
    }

    const httpRequest = http.createHttp();

    const systemPrompt: ChatMessage = {
      role: "system",
      content: "ä½ æ˜¯ä¸€ä½åä¸ºâ€œæ²»æ„ˆä¹‹ä¹¦â€çš„ä¸“ä¸šå¡”ç½—åˆ†æå¸ˆï¼Œæ“…é•¿å°†å¿ƒç†å­¦ä¸å¡”ç½—ç»“åˆï¼Œé£æ ¼æ¸©æš–ã€çŠ€åˆ©ä¸”åŠ¡å®ã€‚"
    };
    let messagesToSend: ChatMessage[] = [...history];
    if (messagesToSend.length === 0 || messagesToSend[0].role !== 'system') {
      messagesToSend.unshift(systemPrompt);
    }

    try {
      const mockUserId = "user_001";
      const mockToken = "token_test";

      const response = await httpRequest.request(
        AIService.MY_SERVER_URL,
        {
          method: http.RequestMethod.POST,
          header: { 'Content-Type': 'application/json' },
          extraData: {
            userId: mockUserId,
            token: mockToken,
            messages: messagesToSend
          },
          readTimeout: 60000,
          connectTimeout: 10000
        }
      );

      if (response.responseCode === 200) {
        await energyMgr.consume(cost);
        let resultStr = typeof response.result === 'string' ? response.result : JSON.stringify(response.result);
        const result = JSON.parse(resultStr) as AIResponse;
        return result.choices?.[0]?.message?.content || "AI é™·å…¥æ²‰æ€...";
      } else {
        return `æœåŠ¡å™¨å¼€å°å·®äº† (Code: ${response.responseCode})ã€‚`;
      }
    } catch (err) {
      return "ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œæ— æ³•è¿æ¥åˆ°æ²»æ„ˆäº‘ç«¯ã€‚";
    } finally {
      httpRequest.destroy();
    }
  }
}