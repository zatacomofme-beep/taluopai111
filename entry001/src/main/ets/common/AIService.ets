// è·¯å¾„: ets/common/AIService.ts
// V8.0 å•†ä¸šåŒ–ä¿®æ­£ç‰ˆï¼šé›†æˆèƒ½é‡æ¶ˆè€—æ£€æŸ¥ä¸å¿ƒæƒ…ä¸Šä¸‹æ–‡æ³¨å…¥

import http from '@ohos.net.http';
import preferences from '@ohos.data.preferences';
import common from '@ohos.app.ability.common';
import fs from '@ohos.file.fs';
import util from '@ohos.util';
import { BusinessError } from '@kit.BasicServicesKit';
import { TarotCard } from '../model/TarotData';
import { EnergyManager } from './EnergyManager'; // æ–°å¢
import { FortuneManager } from './FortuneManager'; // æ–°å¢

export interface ChatMessage {
  role: "system" | "user" | "assistant";
  content: string;
}

interface AIMessageContent {
  content: string;
}

interface AIChoice {
  message: AIMessageContent;
}

interface AIResponse {
  choices: AIChoice[];
}

export class AIService {
  private static readonly API_URL = 'https://ark.cn-beijing.volces.com/api/v3/chat/completions';
  private static readonly MODEL_ID = 'deepseek-v3-1-terminus';
  private static readonly PREF_NAME = 'healing_book_pref';
  private static readonly KEY_AI_API_KEY = 'ai_api_key';

  // å®šä¹‰æ¶ˆè€—è§„åˆ™
  public static readonly COST_PER_CHAT = 2; // æ™®é€šå¯¹è¯æ¶ˆè€— 2 ç‚¹
  public static readonly COST_DEEP_ANALYSIS = 5; // é¦–æ¬¡æ·±åº¦åˆ†ææ¶ˆè€— 5 ç‚¹

  static async getApiKey(context: common.UIAbilityContext): Promise<string> {
    try {
      const pref = await preferences.getPreferences(context, AIService.PREF_NAME);
      const key = await pref.get(AIService.KEY_AI_API_KEY, '') as string;
      if (key && key.length > 0) return key;
      // å°è¯•ä»æ–‡ä»¶è¯»å– (å¼€å‘è°ƒè¯•ç”¨)
      try {
        const path = `${context.filesDir}/ai_key.txt`;
        if (fs.accessSync(path)) {
          const file = fs.openSync(path, fs.OpenMode.READ_ONLY);
          const stat = fs.statSync(path);
          const buffer = new ArrayBuffer(stat.size);
          fs.readSync(file.fd, buffer);
          fs.closeSync(file);
          const decoder = new util.TextDecoder();
          return decoder.decode(new Uint8Array(buffer)).trim();
        }
      } catch (e) {}
      return '';
    } catch (err) {
      return '';
    }
  }

  static async setApiKey(context: common.UIAbilityContext, key: string): Promise<void> {
    try {
      const pref = await preferences.getPreferences(context, AIService.PREF_NAME);
      await pref.put(AIService.KEY_AI_API_KEY, key);
      await pref.flush();
    } catch (err) {}
  }

  static createInitialPrompt(cards: TarotCard[]): string {
    return `
      æˆ‘æ­£åœ¨è¿›è¡Œå¡”ç½—ç‰Œâ€œæ—¶å…‰æµâ€ç‰Œé˜µå åœã€‚
      ã€è¿‡å»ã€‘ï¼š${cards[0].name} (${cards[0].meaning})
      ã€ç°åœ¨ã€‘ï¼š${cards[1].name} (${cards[1].meaning})
      ã€æœªæ¥ã€‘ï¼š${cards[2].name} (${cards[2].meaning})
      è¯·ç»“åˆè¿™ä¸‰å¼ ç‰Œçš„æµå˜å…³ç³»ï¼Œç»™æˆ‘ä¸€æ®µæ¸©æš–çš„åˆ†æã€‚
      è¦æ±‚ï¼šè¯­æ°”æ¸©æŸ”æ²»æ„ˆï¼Œå­—æ•°300å­—å·¦å³ï¼Œç»“å°¾ç»™ä¸€å¥ç¥ç¦ã€‚
    `;
  }

  /**
   * è·å–å¢å¼ºçš„ç³»ç»Ÿäººè®¾ (åŒ…å«ä»Šæ—¥å¿ƒæƒ…)
   */
  private static async getEnhancedSystemPrompt(): Promise<string> {
    const manager = FortuneManager.getInstance();
    const moodData = await manager.getTodayMood();

    let moodContext = "";
    if (moodData.mood !== -1) {
      const moodEmojis = ['ğŸ˜­ æ‚²ä¼¤', 'ğŸ˜• å›°æƒ‘', 'ğŸ™‚ å¹³é™', 'ğŸ˜Š å¼€å¿ƒ', 'ğŸ¥³ ç‹‚å–œ'];
      moodContext = `\nã€ç”¨æˆ·ä»Šæ—¥çŠ¶æ€ã€‘ï¼šç”¨æˆ·ä»Šå¤©åœ¨æ—¥è®°ä¸­è®°å½•çš„å¿ƒæƒ…æ˜¯â€œ${moodEmojis[moodData.mood]}â€ï¼Œå¤‡æ³¨ä¸ºï¼šâ€œ${moodData.note}â€ã€‚è¯·åœ¨å›ç­”æ—¶ï¼Œå¾®å¦™åœ°ç»“åˆè¿™ä¸ªæƒ…ç»ªçŠ¶æ€ï¼Œå¦‚æœç”¨æˆ·æ‚²ä¼¤ï¼Œè¯·ç»™äºˆæ›´å¤šæŠšæ…°ï¼›å¦‚æœç”¨æˆ·å¼€å¿ƒï¼Œè¯·ä¸€åŒåº†ç¥ã€‚`;
    }

    return `ä½ æ˜¯ä¸€ä½åä¸ºâ€œæ²»æ„ˆä¹‹ä¹¦â€çš„ä¸“ä¸šå¡”ç½—åˆ†æå¸ˆã€‚
åœ¨è¿›è¡Œç‰Œé˜µè§£è¯»æ—¶ï¼Œè¯­è°ƒæ¸©æš–ã€æ²»æ„ˆã€å¯Œæœ‰æ–‡å­¦æ€§ã€‚
åç»­å¯¹è¯è¯·ä¿æŒä¸“ä¸šç†æ€§çš„å’¨è¯¢å¸ˆé£æ ¼ï¼Œé€»è¾‘æ¸…æ™°ï¼Œä¸è¦è¿‡åº¦ç…½æƒ…ã€‚
${moodContext}`;
  }

  static async requestChat(history: ChatMessage[], context: common.UIAbilityContext, isInitialAnalysis: boolean = false): Promise<string> {
    // 1. æ£€æŸ¥èƒ½é‡
    const energyMgr = EnergyManager.getInstance();
    await energyMgr.init(context);
    const cost = isInitialAnalysis ? AIService.COST_DEEP_ANALYSIS : AIService.COST_PER_CHAT;

    if (!energyMgr.hasEnough(cost)) {
      return `âœ¨ å¿ƒåŠ›å€¼ä¸è¶³ (${energyMgr.getEnergy()}/${cost})ã€‚\n\næ·±åº¦çš„ç–—æ„ˆéœ€è¦æ¶ˆè€—å¿ƒåŠ›ï¼Œè¯·æ˜æ—¥å†æ¥ï¼Œæˆ–å»â€œå‘¼å¸å†¥æƒ³â€é¡µé¢ä¼‘æ¯ç‰‡åˆ»ã€‚`;
    }

    const httpRequest = http.createHttp();

    // 2. æ„å»ºå¢å¼ºå‹ Prompt
    const sysContent = await AIService.getEnhancedSystemPrompt();
    const systemPrompt: ChatMessage = { role: "system", content: sysContent };

    let messagesToSend: ChatMessage[] = [...history];
    if (messagesToSend.length === 0 || messagesToSend[0].role !== 'system') {
      messagesToSend.unshift(systemPrompt);
    }

    try {
      const apiKey = await AIService.getApiKey(context);
      if (!apiKey) return 'æœªé…ç½® AI Keyã€‚';

      const response = await httpRequest.request(
        AIService.API_URL,
        {
          method: http.RequestMethod.POST,
          header: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
          extraData: {
            model: AIService.MODEL_ID,
            messages: messagesToSend,
            max_tokens: 4096,
            temperature: 0.7
          },
          readTimeout: 60000
        }
      );

      if (response.responseCode === 200) {
        // 3. æˆåŠŸåæ‰£é™¤èƒ½é‡
        await energyMgr.consume(cost);

        let resultStr = typeof response.result === 'string' ? response.result : JSON.stringify(response.result);
        const result = JSON.parse(resultStr) as AIResponse;
        return result.choices?.[0]?.message?.content || "AI é™·å…¥æ²‰æ€...";
      } else if (response.responseCode === 429) {
        return "âœ¨ å®‡å®™ä¿¡å·å¤ªæ‹¥æŒ¤å•¦ï¼ˆé™æµï¼‰ï¼Œè¯·ç¨åå†è¯•ã€‚";
      } else {
        return `è¿æ¥æ–­å¼€ (Code: ${response.responseCode})ã€‚`;
      }
    } catch (err) {
      return "ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œæ— æ³•è¿æ¥åˆ°æ½œæ„è¯†äº‘ç«¯ã€‚";
    } finally {
      httpRequest.destroy();
    }
  }
}