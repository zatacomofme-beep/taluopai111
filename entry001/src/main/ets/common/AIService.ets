// è·¯å¾„: ets/common/AIService.ts
// V7.2 ä¼˜åŒ–ç‰ˆï¼šè°ƒæ•´ AI äººè®¾ï¼Œåç»­å¯¹è¯å›å½’ç†æ€§ä¸ä¸“ä¸š

import http from '@ohos.net.http';
import preferences from '@ohos.data.preferences';
import common from '@ohos.app.ability.common';
import fs from '@ohos.file.fs';
import util from '@ohos.util';
import { BusinessError } from '@kit.BasicServicesKit';
import { TarotCard } from '../model/TarotData';

// å¯¼å‡ºæ¥å£ä¾›é¡µé¢ä½¿ç”¨
export interface ChatMessage {
  role: "system" | "user" | "assistant";
  content: string;
}

// æ‹†åˆ†åµŒå¥—æ¥å£ï¼Œæ»¡è¶³ ArkTS ä¸¥æ ¼æ£€æŸ¥
interface AIMessageContent {
  content: string;
}

interface AIChoice {
  message: AIMessageContent;
}

interface AIResponse {
  choices: AIChoice[];
}

export class AIService {
  // âš ï¸ DeepSeek API é…ç½®
  private static readonly API_URL = 'https://ark.cn-beijing.volces.com/api/v3/chat/completions';
  private static readonly MODEL_ID = 'deepseek-v3-1-terminus';
  private static readonly PREF_NAME = 'healing_book_pref';
  private static readonly KEY_AI_API_KEY = 'ai_api_key';

  /**
   * è¯»å–ä¿å­˜åœ¨åå¥½ä¸­çš„ API Key
   * @param context UIAbility ä¸Šä¸‹æ–‡
   */
  static async getApiKey(context: common.UIAbilityContext): Promise<string> {
    try {
      const pref = await preferences.getPreferences(context, AIService.PREF_NAME);
      const key = await pref.get(AIService.KEY_AI_API_KEY, '') as string;
      if (key && key.length > 0) {
        return key;
      }
      try {
        const path = `${context.filesDir}/ai_key.txt`;
        const stat = fs.statSync(path);
        const file = fs.openSync(path, fs.OpenMode.READ_ONLY);
        const buffer = new ArrayBuffer(stat.size);
        fs.readSync(file.fd, buffer);
        fs.closeSync(file);
        const decoder = new util.TextDecoder();
        const txt = decoder.decode(new Uint8Array(buffer)).trim();
        return txt || '';
      } catch (e) {
        const _err = e as Error;
      }
      return '';
    } catch (err) {
      const error = err as BusinessError | Error | object;
      console.error('AIService: getApiKey failed', JSON.stringify(error));
      return '';
    }
  }

  /**
   * ä¿å­˜/æ›´æ–° API Key åˆ°åå¥½
   * @param context UIAbility ä¸Šä¸‹æ–‡
   * @param key API Key å­—ç¬¦ä¸²
   */
  static async setApiKey(context: common.UIAbilityContext, key: string): Promise<void> {
    try {
      const pref = await preferences.getPreferences(context, AIService.PREF_NAME);
      await pref.put(AIService.KEY_AI_API_KEY, key);
      await pref.flush();
    } catch (err) {
      const error = err as BusinessError | Error | object;
      console.error('AIService: setApiKey failed', JSON.stringify(error));
    }
  }

  /**
   * ç”Ÿæˆåˆå§‹çš„å¡”ç½—ç‰Œé˜µåˆ†ææç¤ºè¯
   * (è¿™ä¸€æ®µä¿ç•™åä¸½é£æ ¼ï¼Œä½œä¸ºå¼€åœºç™½)
   */
  static createInitialPrompt(cards: TarotCard[]): string {
    return `
      æˆ‘æ­£åœ¨è¿›è¡Œå¡”ç½—ç‰Œâ€œæ—¶å…‰æµâ€ç‰Œé˜µå åœã€‚

      ã€è¿‡å»ã€‘ï¼š${cards[0].name} (${cards[0].meaning})
      ã€ç°åœ¨ã€‘ï¼š${cards[1].name} (${cards[1].meaning})
      ã€æœªæ¥ã€‘ï¼š${cards[2].name} (${cards[2].meaning})

      è¯·ç»“åˆè¿™ä¸‰å¼ ç‰Œçš„æµå˜å…³ç³»ï¼Œç»™æˆ‘ä¸€æ®µæ¸©æš–çš„åˆ†æã€‚
      è¦æ±‚ï¼š
      1. è¯­æ°”è¦åƒè€æœ‹å‹ä¸€æ ·æ¸©æŸ”ï¼Œå¸¦æœ‰æ²»æ„ˆæ„Ÿã€‚
      2. ä¸è¦ç”Ÿç¡¬åœ°è§£é‡Šç‰Œä¹‰ï¼Œè¦ä¸²è”æˆä¸€ä¸ªæ•…äº‹æˆ–å»ºè®®ã€‚
      3. å­—æ•°æ§åˆ¶åœ¨ 300 å­—å·¦å³ã€‚
      4. ç»“å°¾ç»™æˆ‘ä¸€å¥å……æ»¡åŠ›é‡çš„ç®€çŸ­ç¥ç¦ã€‚
    `;
  }

  /**
   * å‘é€å¯¹è¯è¯·æ±‚ï¼ˆæ”¯æŒä¸Šä¸‹æ–‡ï¼‰
   * @param history å¯¹è¯å†å²
   * @param context UIAbility ä¸Šä¸‹æ–‡ï¼ˆç”¨äºè¯»å– API Keyï¼‰
   */
  static async requestChat(history: ChatMessage[], context: common.UIAbilityContext): Promise<string> {
    const httpRequest = http.createHttp();

    // ğŸ› ï¸ æ ¸å¿ƒä¿®æ”¹ï¼šä¼˜åŒ–ç³»ç»Ÿäººè®¾ï¼Œå¼ºåˆ¶ AI åœ¨åç»­å¯¹è¯ä¸­â€œè®²äººè¯â€
    const systemPrompt: ChatMessage = {
      role: "system",
      content: `ä½ æ˜¯ä¸€ä½åä¸ºâ€œæ²»æ„ˆä¹‹ä¹¦â€çš„ä¸“ä¸šå¡”ç½—åˆ†æå¸ˆã€‚
åœ¨è¿›è¡Œåˆæ¬¡ç‰Œé˜µè§£è¯»æ—¶ï¼Œä½ çš„è¯­è°ƒæ˜¯æ¸©æš–ã€æ²»æ„ˆã€å¯Œæœ‰æ–‡å­¦æ€§çš„ã€‚
ä½†åœ¨åç»­çš„å¯¹è¯äº’åŠ¨ä¸­ï¼Œè¯·ä¿æŒã€æ­£å¸¸ã€ä¸“ä¸šã€ç›´æ¥ã€‘çš„æ²Ÿé€šé£æ ¼ã€‚
å›ç­”ç”¨æˆ·åç»­é—®é¢˜æ—¶ï¼Œè¯·åƒä¸€ä½ç†æ€§çš„å¿ƒç†å’¨è¯¢å¸ˆæˆ–åˆ†æå¸ˆï¼Œé€»è¾‘æ¸…æ™°ï¼Œè¯­è¨€å¹³å®ï¼Œä¸è¦ä½¿ç”¨è¿‡å¤šçš„åä¸½è¾è—»ã€æ’æ¯”å¥æˆ–è¿‡åº¦ç…½æƒ…ã€‚
åªåœ¨ç”¨æˆ·æ˜¾éœ²å‡ºæ˜æ˜¾æ‚²ä¼¤æƒ…ç»ªæ—¶ï¼Œæ‰é€‚åº¦ç»™äºˆæƒ…æ„ŸæŠšæ…°ã€‚`
    };

    // ç¡®ä¿ç¬¬ä¸€æ¡æ˜¯ç³»ç»Ÿäººè®¾
    let messagesToSend: ChatMessage[] = [...history];
    if (messagesToSend.length === 0 || messagesToSend[0].role !== 'system') {
      messagesToSend.unshift(systemPrompt);
    }

    try {
      console.info('AIService: å‘é€å¯¹è¯è¯·æ±‚...', JSON.stringify(messagesToSend.length));
      const apiKey = await AIService.getApiKey(context);
      if (!apiKey) {
        return 'æœªé…ç½® AI Keyï¼Œè¯·å…ˆåœ¨åº”ç”¨è®¾ç½®ä¸­å®Œæˆé…ç½®ã€‚';
      }
      const response = await httpRequest.request(
        AIService.API_URL,
        {
          method: http.RequestMethod.POST,
          header: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          extraData: {
            model: AIService.MODEL_ID,
            messages: messagesToSend,
            max_tokens: 4096,
            temperature: 0.7
          },
          readTimeout: 60000,
          connectTimeout: 60000
        }
      );

      if (response.responseCode === 200) {
        let resultStr = "";
        if (typeof response.result === 'string') {
          resultStr = response.result;
        } else {
          resultStr = JSON.stringify(response.result);
        }

        const result = JSON.parse(resultStr) as AIResponse;

        if (result.choices && result.choices.length > 0 && result.choices[0].message) {
          return result.choices[0].message.content;
        }
        return "AI ä¼¼ä¹é™·å…¥äº†æ²‰æ€...";

      } else if (response.responseCode === 429) {
        return "âœ¨ å®‡å®™ä¿¡å·å¤ªæ‹¥æŒ¤å•¦ï¼Œè¯·ç¨ä½œä¼‘æ¯å†é—®æˆ‘å§ã€‚ï¼ˆé™æµä¿æŠ¤ï¼‰";
      } else {
        console.error('AIService Error:', JSON.stringify(response));
        return `è¿æ¥æ–­å¼€ (Code: ${response.responseCode})ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚`;
      }

    } catch (err) {
      const error = err as BusinessError | Error | object;
      console.error('AIService Network Error:', JSON.stringify(error));
      return "ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œæ— æ³•è¿æ¥åˆ°æ½œæ„è¯†äº‘ç«¯ã€‚";
    } finally {
      httpRequest.destroy();
    }
  }
}