import http from '@ohos.net.http';
import common from '@ohos.app.ability.common';
import { TarotCard } from '../model/TarotData';
import { EnergyManager } from './EnergyManager';
import { FortuneManager, MoodToday } from './FortuneManager';

export interface ChatMessage {
  role: "system" | "user" | "assistant";
  content: string;
}

interface AIMessageContent {
  content: string;
}
interface AIChoice {
  message: AIMessageContent;
}
interface AIResponse {
  choices: AIChoice[];
}

export class AIService {
  // ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šæ¢æˆä½ çš„åä¸ºäº‘æœåŠ¡å™¨å…¬ç½‘ IP
  private static readonly MY_SERVER_URL = 'http://1.94.149.144:3000/api/ai/chat';

  public static readonly COST_PER_CHAT = 2;
  public static readonly COST_DEEP_ANALYSIS = 5;

  static createInitialPrompt(cards: TarotCard[], lastMood?: MoodToday, spreadType: string = 'time_flow'): string {
    let moodInstruction = "";
    
    // åœºæ™¯ 1ï¼šæœ‰å¿ƒæƒ…è®°å½•
    if (lastMood && lastMood.mood !== -1) {
      const emojis = ['ğŸ˜­ æ‚²ä¼¤', 'ğŸ˜• å›°æƒ‘', 'ğŸ™‚ å¹³é™', 'ğŸ˜Š å¼€å¿ƒ', 'ğŸ¥³ ç‹‚å–œ'];
      const moodText = emojis[lastMood.mood] || 'æœªçŸ¥';
      const noteText = lastMood.note ? `å¤‡æ³¨ï¼šâ€œ${lastMood.note}â€` : '';
      moodInstruction = `ã€ç”¨æˆ·å½“å‰çŠ¶æ€ã€‘ï¼š${moodText}ã€‚${noteText}ã€‚è¯·åœ¨è§£è¯»ä¸­äºˆä»¥å›åº”ã€‚`;
    }

    let spreadInfo = "";
    let formatInstruction = "";
    
    if (spreadType === 'time_flow') {
        spreadInfo = `
        ç‰Œé˜µï¼šæ—¶å…‰æµï¼ˆPast-Present-Futureï¼‰
        1. ã€è¿‡å»ã€‘ï¼š${cards[0]?.name} (${cards[0]?.meaning})
        2. ã€ç°åœ¨ã€‘ï¼š${cards[1]?.name} (${cards[1]?.meaning})
        3. ã€æœªæ¥ã€‘ï¼š${cards[2]?.name} (${cards[2]?.meaning})
        `;
        formatInstruction = `
        è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼ˆä¸è¦ä¿®æ”¹æ ‡ç­¾ï¼‰ï¼š
        <<<SECTION_0>>>
        (é’ˆå¯¹è¿‡å»çš„è§£è¯»ï¼Œç»“åˆå¼€åœºç™½)
        <<<SECTION_1>>>
        (é’ˆå¯¹ç°åœ¨çš„æ·±åº¦å‰–æ)
        <<<SECTION_2>>>
        (é’ˆå¯¹æœªæ¥çš„é¢„æµ‹)
        <<<SECTION_3>>>
        (ç»¼åˆå»ºè®®)
        `;
    } else if (spreadType === 'celtic_cross') {
        // ç®€åŒ–ç‰ˆå‡¯å°”ç‰¹åå­— (è¿™é‡Œåªå–å‰10å¼ ï¼Œå‡è®¾ cards é•¿åº¦è¶³å¤Ÿ)
        const positions = [
            'æ ¸å¿ƒç°çŠ¶', 'é˜»ç¢/æŒ‘æˆ˜', 'æ½œæ„è¯†/åŸºç¡€', 'è¿‡å»çš„å½±å“', 
            'æ„è¯†ç›®æ ‡/æœ€é«˜æ„¿æ™¯', 'å³å°†å‘ç”Ÿçš„æœªæ¥', 'è‡ªæˆ‘æ€åº¦', 'ç¯å¢ƒå½±å“', 'å¸Œæœ›ä¸ææƒ§', 'æœ€ç»ˆç»“æœ'
        ];
        spreadInfo = "ç‰Œé˜µï¼šå‡¯å°”ç‰¹åå­—\n";
        cards.forEach((c, i) => {
            if (i < 10) spreadInfo += `${i+1}. ã€${positions[i]}ã€‘ï¼š${c.name} (${c.meaning})\n`;
        });
        formatInstruction = `
        è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡º 10 ä¸ªæ®µè½ + 1 ä¸ªæ€»ç»“ï¼š
        <<<SECTION_0>>>
        (æ ¸å¿ƒç°çŠ¶è§£è¯»)
        <<<SECTION_1>>>
        (é˜»ç¢ä¸æŒ‘æˆ˜è§£è¯»)
        ...ä»¥æ­¤ç±»æ¨ç›´åˆ° <<<SECTION_9>>> (æœ€ç»ˆç»“æœ)
        <<<SECTION_10>>>
        (ç»¼åˆæ€»ç»“ä¸å»ºè®®)
        `;
    } else {
        // é€šç”¨å¤„ç†
        spreadInfo = "ç‰Œé˜µï¼šè‡ªç”±ç‰Œé˜µ\n";
        cards.forEach((c, i) => {
            spreadInfo += `${i+1}. ${c.name} (${c.meaning})\n`;
        });
        formatInstruction = `
        è¯·ä¸ºæ¯ä¸€å¼ ç‰Œæä¾›è§£è¯»æ®µè½ï¼Œæ ¼å¼ä¸ºï¼š
        <<<SECTION_0>>>
        (ç¬¬1å¼ ç‰Œè§£è¯»)
        <<<SECTION_1>>>
        (ç¬¬2å¼ ç‰Œè§£è¯»)
        ...
        <<<SECTION_${cards.length}>>>
        (æ€»ç»“å»ºè®®)
        `;
    }

    return `
      ${moodInstruction}
      ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œã€ç›´è§‰æ•é”ä¸”å……æ»¡äººæ–‡å…³æ€€çš„å¡”ç½—å’¨è¯¢å¸ˆã€‚
      
      ${spreadInfo}

      è§£è¯»è¦æ±‚ï¼š
      1. è¯­è¨€æ¸©æš–è€Œåšå®šï¼Œå¯Œæœ‰æ²»æ„ˆæ„Ÿã€‚
      2. ç»“åˆç‰Œé¢å«ä¹‰å’Œä½ç½®å«ä¹‰è¿›è¡Œæ·±åº¦é“¾æ¥ã€‚
      3. æœ€åå¿…é¡»ç»™å‡ºå…·ä½“å¯è¡Œçš„å»ºè®®ã€‚
      
      ${formatInstruction}
    `;
  }

  static async requestChat(history: ChatMessage[], context: common.UIAbilityContext, isInitialAnalysis: boolean = false, isFree: boolean = false): Promise<string> {
    const energyMgr = EnergyManager.getInstance();
    const fortuneMgr = FortuneManager.getInstance(); // è·å–å®ä¾‹ç”¨äºæ ‡è®°å…è´¹æ¬¡æ•°
    const cost = isInitialAnalysis ? AIService.COST_DEEP_ANALYSIS : AIService.COST_PER_CHAT;

    // å¦‚æœä¸æ˜¯å…è´¹ä¸”å¿ƒåŠ›ä¸è¶³
    if (!isFree && !energyMgr.hasEnough(cost)) {
      return `âœ¨ å¿ƒåŠ›å€¼ä¸è¶³ (${energyMgr.getEnergy()}/${cost})ã€‚\n\nè¯·å»é¦–é¡µç‚¹å‡»é—ªç”µå›¾æ ‡è¡¥å……å¿ƒåŠ›ã€‚`;
    }

    const httpRequest = http.createHttp();

    const systemPrompt: ChatMessage = {
      role: "system",
      content: "ä½ æ˜¯ä¸€ä½åä¸ºâ€œæ²»æ„ˆä¹‹ä¹¦â€çš„ä¸“ä¸šå¡”ç½—åˆ†æå¸ˆï¼Œæ“…é•¿å°†å¿ƒç†å­¦ä¸å¡”ç½—ç»“åˆï¼Œé£æ ¼æ¸©æš–ã€çŠ€åˆ©ä¸”åŠ¡å®ã€‚"
    };
    let messagesToSend: ChatMessage[] = [...history];
    if (messagesToSend.length === 0 || messagesToSend[0].role !== 'system') {
      messagesToSend.unshift(systemPrompt);
    }

    try {
      const mockUserId = "user_001";
      const mockToken = "token_test";

      const response = await httpRequest.request(
        AIService.MY_SERVER_URL,
        {
          method: http.RequestMethod.POST,
          header: { 'Content-Type': 'application/json' },
          extraData: {
            userId: mockUserId,
            token: mockToken,
            messages: messagesToSend
          },
          readTimeout: 60000,
          connectTimeout: 10000
        }
      );

      if (response.responseCode === 200) {
        if (!isFree) {
          await energyMgr.consume(cost);
        } else if (isInitialAnalysis) {
           // å¦‚æœæ˜¯å…è´¹ä¸”æ˜¯æ·±åº¦åˆ†æï¼Œæ ‡è®°ä»Šæ—¥å·²ç”¨
           await fortuneMgr.markDailyDeepAnalysisUsed();
        }
        
        let resultStr = typeof response.result === 'string' ? response.result : JSON.stringify(response.result);
        const result = JSON.parse(resultStr) as AIResponse;
        return result.choices?.[0]?.message?.content || "AI é™·å…¥æ²‰æ€...";
      } else {
        return `æœåŠ¡å™¨å¼€å°å·®äº† (Code: ${response.responseCode})ã€‚`;
      }
    } catch (err) {
      return "ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œæ— æ³•è¿æ¥åˆ°æ²»æ„ˆäº‘ç«¯ã€‚";
    } finally {
      httpRequest.destroy();
    }
  }
}