import common from '@ohos.app.ability.common';
import { promptAction, router } from '@kit.ArkUI';
import { BottomNavBar } from '../common/BottomNavBar';
import { FortuneManager, CardRecord } from '../common/FortuneManager';
import { TAROT_DECK } from '../model/TarotData';
import { CloudService } from '../common/CloudService'; // ğŸŸ¢ å¼•å…¥äº‘æœåŠ¡ç”¨äºè‡ªåŠ¨åŒæ­¥

@Entry
@Component
export struct MoodPage {
  @State moodIndex: number = -1;
  @State moodNote: string = '';
  @State goldQuote: string = '';
  @State dailyTask: string = '';
  @State isHistoryOpen: boolean = false;
  @State historyList: CardRecord[] = [];

  private manager = FortuneManager.getInstance();
  private context = getContext(this) as common.UIAbilityContext;

  // ğŸŸ¢ æ ¸å¿ƒï¼šæ™ºèƒ½å¤„ç†å›¾ç‰‡é“¾æ¥ï¼ˆç½‘ç»œæˆ–æœ¬åœ°ï¼‰
  getCardImageSource(url: string): ResourceStr {
    if (url.startsWith('http')) {
      return url;
    }
    return $rawfile(url);
  }

  async aboutToAppear() {
    await this.manager.init(this.context);
    await this.loadData();
  }

  async loadData() {
    const mood = await this.manager.getTodayMood();
    if (mood.mood === -1) {
      this.moodIndex = -1;
      this.moodNote = '';
    } else {
      this.moodIndex = mood.mood;
      this.moodNote = mood.note || '';
    }

    const aff = await this.manager.getTodayAffirmations();
    this.goldQuote = aff.quote;
    this.dailyTask = aff.task;

    this.historyList = await this.manager.getHistory();
  }

  selectMood(index: number) {
    this.moodIndex = index;
  }

  async handleSave() {
    if (this.moodIndex === -1) {
      promptAction.showToast({ message: 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä»£è¡¨ä»Šå¤©å¿ƒæƒ…çš„å›¾æ ‡', duration: 2000 });
      return;
    }
    if (!this.moodNote || this.moodNote.trim().length === 0) {
      promptAction.showToast({ message: 'è¯·å†™ä¸‹æ­¤åˆ»çš„æƒ³æ³•æˆ–è®°å½•', duration: 2000 });
      return;
    }

    await this.manager.setTodayMood(this.moodIndex, this.moodNote);
    promptAction.showToast({ message: 'âœ¨ å¿ƒæƒ…å·²è®°å½•', duration: 1200 });

    // ğŸŸ¢ è‡ªåŠ¨åŒæ­¥ï¼šä¿å­˜åç«‹å³åœ¨åå°å°è¯•åŒæ­¥åˆ°äº‘ç«¯
    CloudService.autoSave();

    this.historyList = await this.manager.getHistory();

    const streak = await this.manager.getMoodStreak();
    const label = this.manager.getAchievementLabelByStreak(streak);
    if (label) {
      AlertDialog.show({ title: 'ğŸ–ï¸ æƒ…ç»ªæˆå°±', message: `${label}\nç»§ç»­ä¿æŒè¿™ä»½æ¸©æŸ”çš„è‡ªæˆ‘ç…§é¡¾ã€‚` });
    }
  }

  formatDateShort(timestamp: number): string {
    const date = new Date(timestamp);
    return `${date.getMonth() + 1}.${date.getDate()}`;
  }

  getCardImage(id: number): string {
    return TAROT_DECK[id]?.image || 'card_back.png';
  }

  getMoodEmoji(index: number | undefined): string {
    const emojis = ['ğŸ˜­', 'ğŸ˜•', 'ğŸ™‚', 'ğŸ˜Š', 'ğŸ¥³'];
    if (index === undefined || index < 0 || index >= emojis.length) return 'ğŸ¤”';
    return emojis[index];
  }

  getFilteredHistory(): CardRecord[] {
    return this.historyList.filter(r => r.moodIndex !== undefined && r.moodIndex !== -1);
  }

  // å†å²è®°å½•ç”»å»Š Sheet
  @Builder HistorySheetBuilder() {
    Column() {
      // é¡¶éƒ¨æŠŠæ‰‹
      Row().width(40).height(5).backgroundColor('#E0E0E0').borderRadius(5).margin({ top: 10, bottom: 15 })

      Row() {
        Column() {
          Text("å¿ƒæƒ…ç”»å»Š").fontSize(22).fontWeight(FontWeight.Bold).fontColor('#333')
          Text("æ¯ä¸€å¼ ç‰Œéƒ½è®°å½•ç€å½“ä¸‹çš„ä½ ").fontSize(12).fontColor('#999').margin({top: 4})
        }.alignItems(HorizontalAlign.Start)

        Blank()

        Text(`${this.getFilteredHistory().length} ç¯‡å›å¿†`).fontSize(12).fontColor('#BBB')
      }.width('100%').padding({ left: 24, right: 24, bottom: 15 })

      // ç”»å»Šç½‘æ ¼
      Grid() {
        ForEach(this.getFilteredHistory(), (record: CardRecord) => {
          GridItem() {
            Column() {
              // å¡ç‰‡ä¸»ä½“
              Stack({ alignContent: Alignment.BottomEnd }) {
                // ğŸŸ¢ ä¿®å¤ï¼šè°ƒç”¨ getCardImageSource åŠ è½½ç½‘ç»œå›¾
                Image(this.getCardImageSource(this.getCardImage(record.cardId)))
                  .width('100%')
                  .aspectRatio(3/4)
                  .objectFit(ImageFit.Cover)
                  .borderRadius({ topLeft: 12, topRight: 12 })
                  .alt($rawfile('card_back.png')) // åŠ è½½å ä½å›¾

                // æ¸å˜é®ç½©
                Row()
                  .width('100%')
                  .height('40%')
                  .linearGradient({
                    direction: GradientDirection.Bottom,
                    colors: [['rgba(0,0,0,0)', 0.0], ['rgba(0,0,0,0.4)', 1.0]]
                  })
                  .borderRadius({ bottomLeft: 0, bottomRight: 0 })

                // å¿ƒæƒ…å°ç« 
                Text(this.getMoodEmoji(record.moodIndex))
                  .fontSize(28)
                  .margin({ right: 8, bottom: 8 })
                  .shadow({ radius: 10, color: 'rgba(0,0,0,0.2)', offsetY: 2 })
              }
              .width('100%')
              .clip(true) // è£å‰ªæº¢å‡ºéƒ¨åˆ†
              .borderRadius({ topLeft: 12, topRight: 12 })

              // åº•éƒ¨æ–‡å­—åŒºåŸŸ
              Column() {
                Row() {
                  Text(this.formatDateShort(record.timestamp))
                    .fontSize(14).fontWeight(FontWeight.Bold).fontColor('#333')
                  Blank()
                  Circle({ width: 4, height: 4 }).fill('#EEE')
                }.width('100%').margin({ bottom: 6 })

                Text(record.moodNote || '...')
                  .fontSize(13)
                  .fontColor('#666')
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .lineHeight(18)
              }
              .width('100%')
              .padding(12)
              .backgroundColor(Color.White)
              .borderRadius({ bottomLeft: 12, bottomRight: 12 })
            }
            .shadow({ radius: 15, color: 'rgba(0,0,0,0.05)', offsetY: 5 })
            .margin(5)
          }
        })
      }
      .columnsTemplate('1fr 1fr')
      .columnsGap(10)
      .rowsGap(15)
      .padding({ left: 15, right: 15, bottom: 20 })
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)

      // ç©ºçŠ¶æ€
      if (this.getFilteredHistory().length === 0) {
        Column() {
          Text('ğŸ–¼ï¸').fontSize(48).opacity(0.5)
          Text('ç”»å»Šç©ºç©ºå¦‚ä¹Ÿ').fontSize(14).fontColor('#999').margin({ top: 12 })
          Text('å»è®°å½•ç¬¬ä¸€ä»½å¿ƒæƒ…å§').fontSize(12).fontColor('#CCC').margin({ top: 4 })
        }.width('100%').height('50%').justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('85%')
    .backgroundColor('#F7F8FA')
    .borderRadius({ topLeft: 24, topRight: 24 })
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      // èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#F7F8FA')

      Scroll() {
        Column({ space: 20 }) {
          // é¡¶éƒ¨æ ‡é¢˜æ 
          Row() {
            Column({ space: 4 }) {
              Text('å¿ƒæƒ…æ—¥è®°')
                .fontSize(28)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333333')
              Text('è®°å½•å½“ä¸‹çš„çœŸå®æ„Ÿå—')
                .fontSize(14)
                .fontColor('#999999')
            }
            .alignItems(HorizontalAlign.Start)

            Blank()

            // å³ä¸Šè§’ï¼šå†å²è®°å½•å…¥å£
            Button({ type: ButtonType.Circle }) {
              Text('ğŸ“…').fontSize(20)
            }
            .width(44).height(44)
            .backgroundColor(Color.White)
            .shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
            .onClick(() => { this.isHistoryOpen = true })
          }
          .width('100%')
          .padding({ left: 24, right: 24, top: 20 })

          // 1. å¿ƒæƒ…é€‰æ‹©å¡ç‰‡
          Column({ space: 16 }) {
            Text('ä»Šå¤©æ„Ÿè§‰å¦‚ä½•ï¼Ÿ')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .width('100%')

            Row() {
              ForEach(['ğŸ˜­', 'ğŸ˜•', 'ğŸ™‚', 'ğŸ˜Š', 'ğŸ¥³'], (emoji: string, index: number) => {
                Column() {
                  Text(emoji).fontSize(32)
                }
                .width(56)
                .height(56)
                .justifyContent(FlexAlign.Center)
                .borderRadius(16)
                .backgroundColor(this.moodIndex === index ? '#FFF0F5' : 'transparent')
                .border(this.moodIndex === index ? { width: 2, color: '#FF69B4' } : { width: 0 })
                .animation({ duration: 200 })
                .onClick(() => this.selectMood(index))
              })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
          }
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(20)
          .shadow({ radius: 20, color: 'rgba(0,0,0,0.03)', offsetY: 5 })
          .margin({ left: 16, right: 16 })

          // 2. è¾“å…¥æ¡†å¡ç‰‡
          Column({ space: 12 }) {
            TextArea({ text: this.moodNote, placeholder: 'å†™ä¸‹æ­¤åˆ»çš„æƒ³æ³•...' })
              .height(120)
              .backgroundColor('#F9F9F9')
              .borderRadius(12)
              .fontSize(15)
              .placeholderColor('#CCCCCC')
              .onChange((v) => { this.moodNote = v; })

            Row() {
              Blank()
              Button('ä¿å­˜è®°å½•')
                .backgroundColor('#333333')
                .fontColor(Color.White)
                .height(36)
                .fontSize(13)
                .borderRadius(18)
                .onClick(() => this.handleSave())
            }
          }
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(20)
          .shadow({ radius: 20, color: 'rgba(0,0,0,0.03)', offsetY: 5 })
          .margin({ left: 16, right: 16 })

          // 3. æ¯æ—¥æŒ‡å¼•å¡ç‰‡ (å¦‚æœ‰)
          if (this.goldQuote || this.dailyTask) {
            Column() {
              Row() {
                Text('âœ¨').fontSize(18).margin({ right: 8 })
                Text('ä»Šæ—¥èƒ½é‡æŒ‡å¼•').fontSize(16).fontWeight(FontWeight.Bold)
              }.width('100%').margin({ bottom: 12 })

              if (this.goldQuote) {
                Text('â€œ ' + this.goldQuote + ' â€')
                  .fontSize(15)
                  .fontColor('#555555')
                  .fontStyle(FontStyle.Italic)
                  .lineHeight(24)
                  .margin({ bottom: 12 })
              }

              if (this.dailyTask) {
                Row() {
                  Checkbox({ name: 'task', group: 'task' }).select(false).width(16).height(16)
                  Text(this.dailyTask).fontSize(14).fontColor('#666666').margin({ left: 8 })
                }
                .backgroundColor('#F5F7FA')
                .padding(12)
                .borderRadius(8)
                .width('100%')
              }
            }
            .padding(20)
            .backgroundColor(Color.White)
            .borderRadius(20)
            .shadow({ radius: 20, color: 'rgba(0,0,0,0.03)', offsetY: 5 })
            .margin({ left: 16, right: 16 })
          }

          Blank().height(100) // åº•éƒ¨å«é«˜
        }
      }
      .width('100%')
      .height('100%')
      .scrollBar(BarState.Off)

      // æ‚¬æµ®å¯¼èˆªæ 
      BottomNavBar({ current: 'mood' })
    }
    .bindSheet($$this.isHistoryOpen, this.HistorySheetBuilder(), {
      height: SheetSize.LARGE,
      backgroundColor: Color.Transparent,
      blurStyle: BlurStyle.Thin,
      showClose: true
    })
  }
}