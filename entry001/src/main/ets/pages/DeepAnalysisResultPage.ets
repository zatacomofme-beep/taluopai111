import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import { AIService, ChatMessage } from '../common/AIService';
import { EnergyManager } from '../common/EnergyManager';
import { MoodToday } from '../common/FortuneManager';
import { TarotCard } from '../model/TarotData';
import curves from '@ohos.curves';

@Entry
@Component
struct DeepAnalysisResultPage {
  @State cards: TarotCard[] = [];
  @State spreadType: string = 'time_flow';
  @State spreadName: string = 'æ·±åº¦è§£è¯»';
  
  @State isAnalyzing: boolean = true;
  @State showButton: boolean = false;
  @State isFree: boolean = false;
  
  // è§£æåçš„æ–‡æœ¬æ®µè½ (å¯¹åº”æ¯å¼ ç‰Œçš„è§£è¯»)
  @State sectionTexts: string[] = [];
  // æ€»ç»“å»ºè®®
  @State summaryText: string = "";
  
  // åŠ¨ç”»æ§åˆ¶ï¼šé€æ­¥æ˜¾ç¤º
  @State visibleSections: boolean[] = [];
  @State showSummary: boolean = false;
  
  private context = getContext(this) as common.UIAbilityContext;
  private energyManager = EnergyManager.getInstance();
  private scroller: Scroller = new Scroller();

  async aboutToAppear() {
    await this.energyManager.init(this.context);
    
    const params = router.getParams() as Record<string, Object>;
    if (params && params['cards']) {
      this.cards = params['cards'] as TarotCard[];
      this.spreadType = params['spreadType'] as string || 'time_flow';
      this.spreadName = params['spreadName'] as string || (this.spreadType === 'time_flow' ? 'æ—¶å…‰æµ' : 'æ·±åº¦è§£è¯»');
      const todayMood = params['todayMood'] as MoodToday;
      this.isFree = params['isFree'] as boolean || false;
      
      // åˆå§‹åŒ–çŠ¶æ€æ•°ç»„
      this.sectionTexts = new Array(this.cards.length).fill('');
      this.visibleSections = new Array(this.cards.length).fill(false);
      
      // å¼€å§‹ AI åˆ†æ
      this.startAnalysis(todayMood);
    }
  }

  async startAnalysis(todayMood: MoodToday) {
    // ä¼ é€’ spreadType ç»™ AIService
    const initialPrompt = AIService.createInitialPrompt(this.cards, todayMood, this.spreadType);
    const userMsg: ChatMessage = { role: 'user', content: initialPrompt };

    try {
      // ä¼ é€’ isFree å‚æ•°
      const fullText = await AIService.requestChat([userMsg], this.context, true, this.isFree);
      this.isAnalyzing = false;
      this.parseAndAnimate(fullText);
    } catch (error) {
      this.isAnalyzing = false;
      this.sectionTexts[0] = "è¿æ¥å®‡å®™ä¿¡å·å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•...";
      this.visibleSections[0] = true;
      this.showButton = true;
    }
  }

  parseAndAnimate(fullText: string) {
    // é€šç”¨è§£æé€»è¾‘ï¼š<<<SECTION_N>>>
    const parts = fullText.split(/<<<(.*?)>>>/);
    
    // split åç»“æ„: ["", "SECTION_0", "content...", "", "SECTION_1", "content...", ...]
    
    let maxSectionIndex = -1;

    for (let i = 1; i < parts.length; i += 2) {
      const tag = parts[i].trim();
      const content = parts[i+1] ? parts[i+1].trim() : "";
      
      if (tag.startsWith('SECTION_')) {
        const index = parseInt(tag.replace('SECTION_', ''));
        if (!isNaN(index)) {
          if (index < this.cards.length) {
            this.sectionTexts[index] = content;
          } else {
            // è¶…å‡ºå¡ç‰Œæ•°é‡çš„éƒ¨åˆ†é€šå¸¸æ˜¯æ€»ç»“
            this.summaryText = content;
          }
          if (index > maxSectionIndex) maxSectionIndex = index;
        }
      }
    }

    // Fallback: å¦‚æœè§£æå¤±è´¥ï¼ŒæŠŠå…¨æ–‡æ”¾åœ¨ç¬¬ä¸€æ®µæˆ–æ€»ç»“
    if (maxSectionIndex === -1) {
      if (this.cards.length > 0) {
        this.sectionTexts[0] = fullText;
      } else {
        this.summaryText = fullText;
      }
    }

    // å¯åŠ¨åºåˆ—åŠ¨ç”»
    this.startSequenceAnimation();
  }

  startSequenceAnimation() {
    let delay = 100;
    
    // é€ä¸ªæ˜¾ç¤ºå¡ç‰Œè§£è¯»
    this.cards.forEach((_, index) => {
      setTimeout(() => {
        animateTo({ duration: 800, curve: Curve.EaseOut }, () => {
          this.visibleSections[index] = true;
        });
        
        // è‡ªåŠ¨æ»šåŠ¨é€»è¾‘ä¼˜åŒ–ï¼šæ¯æ˜¾ç¤ºä¸€æ®µç¨å¾®å¾€ä¸‹æ»šä¸€ç‚¹ï¼Œä½†ä¸è¦å¤ªé¢‘ç¹
        if (index > 0) {
          this.scroller.scrollBy(0, 100);
        }
      }, delay);
      
      // å¢åŠ å»¶è¿Ÿï¼Œé˜…è¯»æ—¶é—´å‡è®¾
      delay += 1500; 
    });

    // æ˜¾ç¤ºæ€»ç»“
    setTimeout(() => {
      animateTo({ duration: 800, curve: Curve.EaseOut }, () => {
        this.showSummary = true;
      });
      this.scroller.scrollEdge(Edge.Bottom);
    }, delay);

    // æ˜¾ç¤ºæŒ‰é’®
    setTimeout(() => {
      animateTo({ duration: 600 }, () => {
        this.showButton = true;
      });
    }, delay + 1000);
  }

  getCardImageSource(url: string): ResourceStr {
    if (url.startsWith('http')) {
      return url;
    }
    return $rawfile(url);
  }

  // è·å–å¡ç‰Œä½ç½®æ ‡é¢˜
  getCardTitle(index: number): string {
    if (this.spreadType === 'time_flow') {
      const titles = ['PAST Â· è¿‡å»', 'PRESENT Â· ç°åœ¨', 'FUTURE Â· æœªæ¥'];
      return titles[index] || `Card ${index + 1}`;
    } else if (this.spreadType === 'celtic_cross') {
      const titles = [
        '1. æ ¸å¿ƒç°çŠ¶', '2. é˜»ç¢/æŒ‘æˆ˜', '3. æ½œæ„è¯†/åŸºç¡€', '4. è¿‡å»çš„å½±å“', 
        '5. æœ€é«˜æ„¿æ™¯', '6. å³å°†å‘ç”Ÿçš„æœªæ¥', '7. è‡ªæˆ‘æ€åº¦', '8. ç¯å¢ƒå½±å“', '9. å¸Œæœ›ä¸ææƒ§', '10. æœ€ç»ˆç»“æœ'
      ];
      return titles[index] || `Card ${index + 1}`;
    } else if (this.spreadType === 'tree_of_life') {
      const titles = [
        '1. ç²¾ç¥æºå¤´', '2. æ™ºæ…§', '3. ç†è§£', '4. æ…ˆæ‚²', '5. åŠ›é‡', 
        '6. ç¾/æ ¸å¿ƒ', '7. èƒœåˆ©', '8. è£è€€', '9. åŸºç¡€', '10. ç‹å›½'
      ];
      return titles[index] || `Card ${index + 1}`;
    }
    return `Card ${index + 1}`;
  }

  @Builder
  AnalysisNode(index: number, card: TarotCard, content: string, show: boolean) {
    Row() {
      if (show) {
        Column() {
          // æ ‡é¢˜
          Text(`${this.getCardTitle(index)} (${card.name})`)
            .fontSize(14)
            .fontColor('#FF69B4')
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 8 })
            .width('100%')
            .textAlign(index % 2 === 0 ? TextAlign.Start : TextAlign.End) // å·¦å³äº¤æ›¿æ ‡é¢˜

          Row() {
            if (index % 2 === 0) {
              // å¶æ•°ç´¢å¼•ï¼šå·¦å›¾å³æ–‡
              Image(this.getCardImageSource(card.image))
                .width(80).aspectRatio(2/3).borderRadius(6)
                .margin({ right: 12 })
                .shadow({ radius: 8, color: 'rgba(0,0,0,0.3)' })
              
              Text(content || "è§£è¯»ç”Ÿæˆä¸­...")
                .fontSize(14)
                .fontColor('#DDD')
                .lineHeight(22)
                .layoutWeight(1)
            } else {
              // å¥‡æ•°ç´¢å¼•ï¼šå·¦æ–‡å³å›¾
              Text(content || "è§£è¯»ç”Ÿæˆä¸­...")
                .fontSize(14)
                .fontColor('#DDD')
                .lineHeight(22)
                .layoutWeight(1)
                .textAlign(TextAlign.End)

              Image(this.getCardImageSource(card.image))
                .width(80).aspectRatio(2/3).borderRadius(6)
                .margin({ left: 12 })
                .shadow({ radius: 8, color: 'rgba(0,0,0,0.3)' })
            }
          }
          .alignItems(VerticalAlign.Top)
          .width('100%')

          // è¿æ¥çº¿ï¼ˆå¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªï¼‰
          if (index < this.cards.length - 1) {
            Column()
              .width(2)
              .height(30)
              .backgroundColor('rgba(255, 105, 180, 0.3)')
              .margin({ top: 10, bottom: 10 })
              .alignSelf(ItemAlign.Center)
          }
        }
        .width('100%')
        .transition({ type: TransitionType.Insert, opacity: 0, translate: { y: 20 } })
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16 })
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      // èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#1A1A2E')
        .linearGradient({
            direction: GradientDirection.Bottom,
            colors: [['#1A1A2E', 0.0], ['#2E1A4E', 1.0]]
        })

      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Button({ type: ButtonType.Normal, stateEffect: true }) {
            Text('<')
              .fontSize(24)
              .fontColor('#FFFFFF')
              .fontWeight(FontWeight.Medium)
          }
          .width(40)
          .height(40)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            router.back();
          })
          
          Text(`${this.spreadName} Â· æ·±åº¦è§£è¯»`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
            .margin({ right: 40 })
        }
        .width('100%')
        .height(50)
        .padding({ left: 10, right: 10 })
        .margin({ top: 10 })

        Scroll(this.scroller) {
          Column() {
            if (this.isAnalyzing) {
              Column() {
                LoadingProgress().width(40).height(40).color('#FF69B4')
                Text('æ­£åœ¨è¿æ¥æ—¶ç©ºé•¿æ²³...')
                  .fontSize(14).fontColor('rgba(255,255,255,0.6)').margin({ top: 10 })
              }
              .height(300)
              .justifyContent(FlexAlign.Center)
            } else {
              Column({ space: 10 }) {
                // 1. å¾ªç¯æ˜¾ç¤ºæ¯å¼ ç‰Œçš„è§£è¯»
                ForEach(this.cards, (card: TarotCard, index: number) => {
                  this.AnalysisNode(index, card, this.sectionTexts[index], this.visibleSections[index])
                })
                
                // 2. æ€»ç»“å»ºè®®
                if (this.showSummary) {
                  Column() {
                    Text('ğŸ’¡ å®‡å®™æŒ‡å¼•')
                      .fontSize(16).fontWeight(FontWeight.Bold).fontColor('#FFD700').margin({ bottom: 10 })
                    Text(this.summaryText || "ç”Ÿæˆæ€»ç»“ä¸­...")
                      .fontSize(15).fontColor('#FFF').lineHeight(26).textAlign(TextAlign.Center)
                  }
                  .width('90%')
                  .padding(20)
                  .backgroundColor('rgba(255,255,255,0.1)')
                  .borderRadius(16)
                  .margin({ top: 20, bottom: 100 })
                  .transition({ type: TransitionType.Insert, opacity: 0, scale: { x: 0.9, y: 0.9 } })
                }
              }
              .width('100%')
              .padding({ top: 20 })
            }
          }
          .width('100%')
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .align(Alignment.Top)
      }
      .width('100%')
      .height('100%')

      // åº•éƒ¨æŒ‰é’®ï¼šå»å€¾è¯‰
      if (this.showButton) {
        Column() {
          Button("âœ¨ å»å€¾è¯‰ (ä¸ AI å¯¹è¯)")
            .backgroundColor('#FF69B4')
            .fontColor(Color.White)
            .width('80%')
            .height(50)
            .borderRadius(25)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .shadow({ radius: 15, color: 'rgba(255, 105, 180, 0.4)', offsetY: 5 })
            .onClick(() => {
              router.pushUrl({
                url: 'pages/AIChatPage',
                params: {
                  fromDeepAnalysis: true
                }
              });
            })
        }
        .width('100%')
        .padding({ bottom: 30 })
        .transition({ type: TransitionType.Insert, opacity: 0, translate: { y: 30 } })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#1A1A2E')
  }
}
