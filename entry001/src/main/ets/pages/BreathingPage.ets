import { router } from '@kit.ArkUI';
import { BottomNavBar } from '../common/BottomNavBar';

@Entry
@Component
export struct BreathingPage {
  @State breathingPhase: string = 'å‡†å¤‡';
  @State breathingRemaining: number = 60;
  private breathingTimerId: number | null = null;

  /**
   * å¼€å§‹å‘¼å¸å¼•å¯¼ï¼ˆå‡½æ•°çº§æ³¨é‡Šï¼‰
   */
  startBreathingGuide(seconds: number) {
    this.breathingRemaining = seconds;
    this.breathingPhase = 'å¸æ°”';
    if (this.breathingTimerId) { clearInterval(this.breathingTimerId); this.breathingTimerId = null; }
    const t = setInterval(() => {
      if (this.breathingRemaining <= 0) { this.stopBreathingGuide(); return; }
      const mod = this.breathingRemaining % 6;
      if (mod >= 4) { this.breathingPhase = 'å¸æ°”'; }
      else if (mod >= 2) { this.breathingPhase = 'åœç•™'; }
      else { this.breathingPhase = 'å‘¼æ°”'; }
      this.breathingRemaining -= 1;
    }, 1000);
    this.breathingTimerId = t as number;
  }

  /**
   * åœæ­¢å‘¼å¸å¼•å¯¼ï¼ˆå‡½æ•°çº§æ³¨é‡Šï¼‰
   */
  stopBreathingGuide() {
    if (this.breathingTimerId) { clearInterval(this.breathingTimerId); this.breathingTimerId = null; }
    this.breathingPhase = 'å®Œæˆ';
  }

  build() {
    Column() {
      Scroll() {
        Column({ space: 16 }) {
          // é¡¶éƒ¨å¯¼èˆªä¸€è‡´æ€§
          Stack({ alignContent: Alignment.Start }) {
            Button({ type: ButtonType.Circle, stateEffect: true }) {
              Text('â®').fontSize(18).fontColor('#666666').fontWeight(FontWeight.Bold)
            }.width(40).height(40).backgroundColor('rgba(0,0,0,0.05)').margin({ left: 20 }).onClick(() => router.replaceUrl({ url: 'pages/Index' }))
            Stack({ alignContent: Alignment.End }) {
              Button({ type: ButtonType.Circle, stateEffect: true }) { Text('ğŸ›ï¸').fontSize(18) }
                .width(40).height(40).backgroundColor('rgba(0,0,0,0.05)').margin({ right: 20 })
                .onClick(() => router.replaceUrl({ url: 'pages/Index' }))
            }.width('100%')
          }.height(50).width('100%').margin({ top: 10, bottom: 5 })

          Text('å‘¼å¸å¼•å¯¼').fontSize(22).fontWeight(FontWeight.Bold).fontColor('#333333').margin({ top: 8 })
          Text(`é˜¶æ®µï¼š${this.breathingPhase}`).fontSize(14).fontColor('#666666')
          Progress({ value: 60 - this.breathingRemaining, total: 60, type: ProgressType.Linear }).width('90%')
          Row({ space: 12 }) {
            Button('å¼€å§‹ 60s').height(42).borderRadius(21).backgroundColor('#E6F2FF').fontColor('#1A73E8').onClick(() => this.startBreathingGuide(60))
            Button('ç»“æŸ').height(42).borderRadius(21).backgroundColor('#F0F0F0').fontColor('#333333').onClick(() => this.stopBreathingGuide())
          }.justifyContent(FlexAlign.Center).width('100%')
          Column({ space: 8 }) {
            Text('æç¤º').fontSize(16).fontWeight(FontWeight.Medium)
            Text('è·ŸéšèŠ‚å¥ï¼šå¸æ°”-åœç•™-å‘¼æ°”ï¼›æ³¨æ„æ”¾æ¾è‚©é¢ˆä¸ä¸‹é¢Œã€‚').fontSize(14).fontColor('#666666')
          }.width('90%')
        }.width('100%').alignItems(HorizontalAlign.Center).padding({ bottom: 100 })
      }.width('100%').layoutWeight(1).align(Alignment.Top)

      BottomNavBar({ current: 'breathing' }).width('100%')
    }
    .width('100%').height('100%').backgroundColor('#FAFAFA').padding({ top: 12, bottom: 12 })
  }
}
