import { router } from '@kit.ArkUI';
import { BottomNavBar } from '../common/BottomNavBar';

@Entry
@Component
export struct BreathingPage {
  @State breathingPhase: string = 'å‡†å¤‡';
  @State breathingRemaining: number = 60;
  // å‘¼å¸åŠ¨ç”»æ§åˆ¶å˜é‡
  @State scaleValue: number = 1;
  @State opacityValue: number = 0.6;
  @State circleColor: string = '#A8D8EA'; // åˆå§‹æ¸…é€è“

  private breathingTimerId: number | null = null;

  /**
   * é‡‡ç”¨ 4-2-6 èˆ’ç¼“å‘¼å¸æ³• (æ€»å‘¨æœŸ 12s)
   * å¸æ°” 4s -> å±æ¯ 2s -> å‘¼æ°” 6s
   * è¿™ç§èŠ‚å¥èƒ½æœ‰æ•ˆæ¿€æ´»å‰¯äº¤æ„Ÿç¥ç»ï¼Œå¸®åŠ©æ”¾æ¾ã€‚
   */
  startBreathingGuide(seconds: number) {
    this.breathingRemaining = seconds;
    this.breathingPhase = 'å¸æ°”';
    if (this.breathingTimerId) { clearInterval(this.breathingTimerId); this.breathingTimerId = null; }

    // ç«‹å³å¼€å§‹ç¬¬ä¸€æ¬¡å¸æ°” (4s)
    this.animateBreath('in', 4000);

    const t = setInterval(() => {
      if (this.breathingRemaining <= 0) { this.stopBreathingGuide(); return; }

      // è®¡ç®—å½“å‰å‘¨æœŸå†…çš„å‰©ä½™æ—¶é—´ç‚¹
      // å€’è®¡æ—¶é€»è¾‘ï¼š60 -> 59 -> ...
      // å‘¨æœŸ 12s:
      // 12, 0  -> å¼€å§‹å¸æ°” (æŒç»­4s: 12,11,10,9)
      // 8      -> å¼€å§‹å±æ¯ (æŒç»­2s: 8,7)
      // 6      -> å¼€å§‹å‘¼æ°” (æŒç»­6s: 6,5,4,3,2,1)

      const mod = this.breathingRemaining % 12;

      if (mod === 8) {
        // å‰©ä½™ 8s æ—¶ï¼ˆå³å¸æ°” 4s ç»“æŸï¼‰ï¼Œè¿›å…¥å±æ¯
        if (this.breathingPhase !== 'å±æ¯') {
          this.breathingPhase = 'å±æ¯';
          this.animateBreath('hold', 2000);
        }
      } else if (mod === 6) {
        // å‰©ä½™ 6s æ—¶ï¼ˆå³å±æ¯ 2s ç»“æŸï¼‰ï¼Œè¿›å…¥å‘¼æ°”
        if (this.breathingPhase !== 'å‘¼æ°”') {
          this.breathingPhase = 'å‘¼æ°”';
          this.animateBreath('out', 6000);
        }
      } else if (mod === 0) {
        // å‰©ä½™ 0s (å³ 12sï¼Œå‘¼æ°” 6s ç»“æŸ)ï¼Œæ–°å¾ªç¯å¼€å§‹å¸æ°”
        // é˜²æ­¢åœ¨æœ€å 0s é‡å¤è§¦å‘
        if (this.breathingRemaining !== 0 && this.breathingPhase !== 'å¸æ°”') {
          this.breathingPhase = 'å¸æ°”';
          this.animateBreath('in', 4000);
        }
      }

      this.breathingRemaining -= 1;
    }, 1000);
    this.breathingTimerId = t as number;
  }

  animateBreath(type: 'in' | 'out' | 'hold', duration: number) {
    if (type === 'in') {
      // å¸æ°”ï¼šå˜å¤§ï¼Œå˜äº®ï¼Œæš–è‰²
      animateTo({ duration: duration, curve: Curve.EaseInOut }, () => {
        this.scaleValue = 1.5;
        this.opacityValue = 1.0;
        this.circleColor = '#FFB6C1'; // æ¨±èŠ±ç²‰
      });
    } else if (type === 'hold') {
      // å±æ¯ï¼šä¿æŒçŠ¶æ€ (ä½¿ç”¨ Linear ç¡®ä¿å¹³æ»‘è¿‡æ¸¡)
      animateTo({ duration: duration, curve: Curve.Linear }, () => {
        this.scaleValue = 1.55; // å¾®å¾®å†å¤§ä¸€ç‚¹ç‚¹ï¼Œæ¨¡æ‹Ÿå……æ»¡æ°”çš„æ„Ÿè§‰
        this.opacityValue = 1.0;
        this.circleColor = '#FFD700'; // æ¸©æš–é‡‘ (æç¤ºä¿æŒ)
      });
    } else if (type === 'out') {
      // å‘¼æ°”ï¼šå›ç¼©ï¼Œå˜æ·¡ï¼Œå†·è‰²
      animateTo({ duration: duration, curve: Curve.EaseInOut }, () => {
        this.scaleValue = 1.0;
        this.opacityValue = 0.6;
        this.circleColor = '#A8D8EA'; // æ¸…é€è“
      });
    }
  }

  stopBreathingGuide() {
    if (this.breathingTimerId) { clearInterval(this.breathingTimerId); this.breathingTimerId = null; }
    this.breathingPhase = 'å®Œæˆ';
    animateTo({ duration: 1000 }, () => { this.scaleValue = 1; this.opacityValue = 0.6; this.circleColor = '#A8D8EA'; });
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      // å…¨å±€èƒŒæ™¯ï¼šæŸ”å’Œæ¸å˜
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Top,
          colors: [['#FDFBFB', 0.0], ['#EBEDEE', 1.0]]
        })

      Column() {
        // é¡¶éƒ¨æ ‡é¢˜åŒº
        Row() {
          Text('å‘¼å¸å¼•å¯¼')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')

          Blank()

          Button({ type: ButtonType.Circle }) {
            Text('âœ•').fontSize(16).fontColor('#999999')
          }
          .width(36).height(36).backgroundColor('rgba(0,0,0,0.05)')
          // ğŸ› ï¸ ä¿®å¤ï¼šç‚¹å‡»å…³é—­æŒ‰é’®æ”¹ä¸ºè¿”å›ä¸Šä¸€é¡µï¼Œè€Œä¸æ˜¯å¼ºåˆ¶è·³å›ä¸»é¡µ
          // å¦‚æœä½ éœ€è¦å¼ºåˆ¶å›ä¸»é¡µï¼Œä¿ç•™ replaceUrl('pages/Index') ä¹Ÿå¯ä»¥ï¼Œ
          // ä½† router.back() é€šå¸¸ä½“éªŒæ›´å¥½ã€‚
          .onClick(() => router.back())
        }
        .width('100%')
        .padding({ left: 24, right: 24, top: 20 })

        // æ ¸å¿ƒåŠ¨ç”»åŒº
        Stack() {
          // å¤–å±‚å…‰æ™•
          Circle({ width: 220, height: 220 })
            .fill(this.circleColor)
            .opacity(this.opacityValue * 0.3)
            .scale({ x: this.scaleValue * 1.2, y: this.scaleValue * 1.2 })
            .animation({ duration: 1000 }) // è·Ÿéšä¸»åœ†ç¨æ…¢

          // ä¸»å‘¼å¸åœ†
          Circle({ width: 220, height: 220 })
            .fill(this.circleColor)
            .opacity(this.opacityValue)
            .scale({ x: this.scaleValue, y: this.scaleValue })
            .shadow({ radius: 30, color: this.circleColor, offsetY: 0 })

          // æ–‡å­—æç¤º
          Column() {
            Text(this.breathingPhase)
              .fontSize(32)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
              .shadow({ radius: 5, color: 'rgba(0,0,0,0.2)' })

            if(this.breathingRemaining < 60 && this.breathingPhase !== 'å®Œæˆ') {
              Text(`${this.breathingRemaining}s`)
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('rgba(255,255,255,0.9)')
                .margin({ top: 8 })
            }
          }
        }
        .layoutWeight(1) // å æ®å‰©ä½™ç©ºé—´ï¼Œå±…ä¸­
        .alignContent(Alignment.Center)

        // æ§åˆ¶åŒº
        Column({ space: 20 }) {
          Text('å¸æ°” 4s - å±æ¯ 2s - å‘¼æ°” 6s')
            .fontSize(14)
            .fontColor('#888888')
            .textAlign(TextAlign.Center)
            .opacity(0.8)

          Text('è·Ÿéšåœ†ç¯çš„å¾‹åŠ¨ï¼Œè®©èº«å¿ƒå›å½’å¹³é™ã€‚')
            .fontSize(14)
            .fontColor('#666666')
            .textAlign(TextAlign.Center)

          Row({ space: 20 }) {
            Button('å¼€å§‹ç»ƒä¹ ')
              .backgroundColor('#333333')
              .fontColor(Color.White)
              .width(140)
              .height(48)
              .borderRadius(24)
              .shadow({ radius: 10, color: 'rgba(0,0,0,0.2)', offsetY: 5 })
              .onClick(() => this.startBreathingGuide(60))

            Button('åœæ­¢')
              .backgroundColor('#FFFFFF')
              .fontColor('#333333')
              .width(140)
              .height(48)
              .borderRadius(24)
              .border({ width: 1, color: '#EEEEEE' })
              .onClick(() => this.stopBreathingGuide())
          }
        }
        .margin({ bottom: 120 }) // ç•™å‡ºåº•éƒ¨å¯¼èˆªæ ä½ç½®
      }
      .width('100%')
      .height('100%')

      // æ‚¬æµ®å¯¼èˆªæ 
      // è¿™é‡Œçš„ current='breathing' æ˜¯æ­£ç¡®çš„ï¼Œç¡®ä¿åº•æ é«˜äº®æ­£ç¡®
      BottomNavBar({ current: 'breathing' })
    }
    .width('100%')
    .height('100%')
  }
}