import { router } from '@kit.ArkUI';
import common from '@ohos.app.ability.common';
import { AIService, ChatMessage } from '../common/AIService';
import { BottomNavBar } from '../common/BottomNavBar';
import { EnergyManager } from '../common/EnergyManager';

@Entry
@Component
struct AIChatPage {
  @State messageList: ChatMessage[] = [
    {
      role: 'assistant',
      content: 'ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„æƒ…ç»ªæ ‘æ´ã€‚æ­¤åˆ»çš„ä½ ï¼Œæœ‰ä»€ä¹ˆæƒ³è¯´çš„å—ï¼Ÿä¸è®ºæ˜¯å¼€å¿ƒçš„äº‹ï¼Œè¿˜æ˜¯çƒ¦æ¼çš„æ€ç»ªï¼Œæˆ‘éƒ½æ„¿æ„å€¾å¬ã€‚'
    }
  ];
  @State inputText: string = '';
  @State isSending: boolean = false;
  @State currentEnergy: number = 0;

  private listScroller: Scroller = new Scroller();
  private context = getContext(this) as common.UIAbilityContext;
  private energyManager = EnergyManager.getInstance();

  async aboutToAppear() {
    await this.energyManager.init(this.context);
    this.currentEnergy = this.energyManager.getEnergy();
  }

  async sendMessage() {
    if (this.inputText.trim().length === 0 || this.isSending) return;

    const userMsg = this.inputText;
    this.inputText = '';
    this.messageList.push({ role: 'user', content: userMsg });
    this.scrollToBottom();

    this.isSending = true;

    // æ„é€ è¯·æ±‚å†å²ï¼Œä»…ä¿ç•™æœ€è¿‘çš„å‡ è½®å¯¹è¯ä»¥èŠ‚çœ token æˆ–ä¿æŒä¸Šä¸‹æ–‡ç›¸å…³æ€§
    // è¿™é‡Œç®€å•åœ°æŠŠæ•´ä¸ªåˆ—è¡¨ä¼ è¿›å»ï¼ŒAIService ä¼šè‡ªåŠ¨å¤„ç† system prompt
    try {
      const reply = await AIService.requestChat(this.messageList, this.context, false);
      this.messageList.push({ role: 'assistant', content: reply });
      
      // æ›´æ–°å¿ƒåŠ›æ˜¾ç¤º
      this.currentEnergy = this.energyManager.getEnergy();
    } catch (error) {
      this.messageList.push({ role: 'assistant', content: 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æœ‰ç‚¹ç´¯ï¼ˆç½‘ç»œè¿æ¥å¤±è´¥ï¼‰ï¼Œè¯·ç¨åå†è¯•ã€‚' });
    } finally {
      this.isSending = false;
      this.scrollToBottom();
    }
  }

  scrollToBottom() {
    setTimeout(() => {
      this.listScroller.scrollEdge(Edge.Bottom);
    }, 100);
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('æƒ…ç»ªå¯¹è¯')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
        
        Blank()

        Row() {
          Text('âš¡').fontSize(14)
          Text(`${this.currentEnergy}`).fontSize(14).fontColor('#FB7299').fontWeight(FontWeight.Bold).margin({ left: 2 })
        }
        .backgroundColor('rgba(255,255,255,0.6)')
        .backdropBlur(20)
        .padding({ left: 10, right: 10, top: 6, bottom: 6 })
        .borderRadius(16)
        .shadow({ radius: 5, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 12, bottom: 12 })
      .backgroundColor('rgba(255,255,255,0.8)')
      .backdropBlur(10)
      .shadow({ radius: 10, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
      .zIndex(1)

      // èŠå¤©åˆ—è¡¨
      List({ scroller: this.listScroller }) {
        ListItem().height(16) // é¡¶éƒ¨ç•™ç™½

        ForEach(this.messageList, (msg: ChatMessage, index: number) => {
          ListItem() {
            if (msg.role === 'assistant') {
              // AI æ¶ˆæ¯ (å·¦ä¾§)
              Row() {
                // å¤´åƒ
                Image($r('app.media.startIcon')) // å»ºè®®æ›¿æ¢ä¸ºä¸“é—¨çš„ AI å¤´åƒ
                  .width(40).height(40).borderRadius(20)
                  .margin({ right: 12 })
                  .backgroundColor('#F0F0F0')
                  .border({ width: 1, color: '#FFF' })
                  .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)', offsetY: 2 })

                // æ°”æ³¡
                Text(msg.content)
                  .fontSize(16)
                  .fontColor('#333')
                  .lineHeight(24)
                  .backgroundColor(Color.White)
                  .padding(14)
                  .borderRadius({ topLeft: 4, topRight: 16, bottomLeft: 16, bottomRight: 16 })
                  .shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
                  .layoutWeight(1)
              }
              .alignItems(VerticalAlign.Top)
              .width('100%')
              .padding({ left: 16, right: 60, top: 8, bottom: 8 })
            } else {
              // ç”¨æˆ·æ¶ˆæ¯ (å³ä¾§)
              Row() {
                // æ°”æ³¡
                Text(msg.content.startsWith('ã€ç”¨æˆ·å½“å‰çŠ¶æ€ã€‘') ? 'ğŸ”® å¼€å§‹æ·±åº¦è§£è¯»...' : msg.content)
                  .fontSize(16)
                  .fontColor(Color.White)
                  .lineHeight(24)
                  .backgroundColor('#FB7299') // å°‘å¥³ç²‰
                  .padding(14)
                  .borderRadius({ topLeft: 16, topRight: 4, bottomLeft: 16, bottomRight: 16 })
                  .shadow({ radius: 8, color: 'rgba(251, 114, 153, 0.4)', offsetY: 4 })
                  .margin({ right: 12 })

                // å¤´åƒ
                Image($r('app.media.startIcon')) // ç”¨æˆ·å¤´åƒï¼Œåç»­å¯ç»‘å®šç”¨æˆ·ä¿¡æ¯
                  .width(40).height(40).borderRadius(20)
                  .backgroundColor('#EEE')
                  .border({ width: 1, color: '#FFF' })
                  .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)', offsetY: 2 })
              }
              .alignItems(VerticalAlign.Top)
              .width('100%')
              .justifyContent(FlexAlign.End) // å†…å®¹å³å¯¹é½
              .padding({ left: 60, right: 16, top: 8, bottom: 8 })
            }
          }
        })
        ListItem().height(20) // åº•éƒ¨ç•™ç™½
      }
      .layoutWeight(1)
      .width('100%')
      .alignListItem(ListItemAlign.Start)

      // åº•éƒ¨è¾“å…¥æ¡†åŒºåŸŸ
      Row() {
        TextInput({ placeholder: 'ä¸æˆ‘åˆ†äº«ä½ çš„æ•…äº‹...', text: this.inputText })
          .layoutWeight(1)
          .height(48)
          .backgroundColor(Color.White)
          .borderRadius(24)
          .padding({ left: 20, right: 20 })
          .shadow({ radius: 4, color: 'rgba(0,0,0,0.05)', offsetY: 1 })
          .onChange((value) => { this.inputText = value; })
          .onSubmit(() => this.sendMessage())

        Button(this.isSending ? '...' : 'å‘é€')
          .height(48)
          .width(80)
          .margin({ left: 12 })
          .backgroundColor(this.inputText.trim().length > 0 ? '#FB7299' : '#E0E0E0')
          .fontColor(Color.White)
          .fontWeight(FontWeight.Bold)
          .borderRadius(24)
          .shadow({ radius: this.inputText.trim().length > 0 ? 8 : 0, color: 'rgba(251, 114, 153, 0.4)', offsetY: 3 })
          .enabled(this.inputText.trim().length > 0 && !this.isSending)
          .onClick(() => this.sendMessage())
          .animation({ duration: 200 })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor('rgba(249, 249, 249, 0.9)')
      .backdropBlur(20)

      // åº•éƒ¨å¯¼èˆªæ 
      BottomNavBar({ current: 'chat' })
    }
    .width('100%')
    .height('100%')
    .linearGradient({
      direction: GradientDirection.Top,
      colors: [['#FDFBFB', 0.0], ['#FFF0F5', 1.0]] // æµ…ç²‰è‰²æ¸å˜èƒŒæ™¯
    })
  }
}
