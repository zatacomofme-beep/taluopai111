import { FortuneManager, CardRecord } from '../common/FortuneManager';
import { fileIo as fs, fileUri } from '@kit.CoreFileKit';
import { uniformTypeDescriptor as utd } from '@kit.ArkData';
import { TarotCard, TAROT_DECK, resolveDeckImage } from '../model/TarotData';
import common from '@ohos.app.ability.common';
import { abilityAccessCtrl } from '@kit.AbilityKit';
import { promptAction, curves, router, componentSnapshot } from '@kit.ArkUI';
import { formBindingData, formProvider } from '@kit.FormKit';
import { BottomNavBar } from '../common/BottomNavBar';
import { ImageSaver } from '../common/ImageSaver';
import { DeckSelectionSheet } from '../common/DeckSelectionSheet';
import { EnergyManager } from '../common/EnergyManager';
import { ShareHelper } from '../common/ShareHelper';
import { CloudService } from '../common/CloudService';
import { UserManager, UserInfo } from '../common/UserManager';
import { BusinessError } from '@kit.BasicServicesKit';
import { AIService } from '../common/AIService';

// 1. å®šä¹‰äº‘ç«¯èµ„æºå¸¸é‡
const OBS_PATH = 'https://taluopai.obs.cn-southwest-2.myhuaweicloud.com/tarot_cards/';
const CARD_BACK_URL = `${OBS_PATH}card_back.png`;
const QR_CODE_URL = `${OBS_PATH}qr_code.png`;

// ğŸŒŸ ç¨€æœ‰åº¦é…ç½®æ¥å£
interface RarityItem {
  level: number;
  label: string;
  color: string;
  desc: string;
}

// ğŸŒŸ ç¨€æœ‰åº¦é…ç½®
const RARITY_CONFIG: RarityItem[] = [
  { level: 1, label: 'N', color: 'rgba(200, 200, 200, 0.5)', desc: 'æ™®é€š' },
  { level: 3, label: 'R', color: 'rgba(60, 179, 113, 0.6)', desc: 'ç¨€æœ‰' },
  { level: 4, label: 'SR', color: 'rgba(30, 144, 255, 0.7)', desc: 'å²è¯—' },
  { level: 5, label: 'SSR', color: 'rgba(255, 69, 0, 0.8)', desc: 'ä¼ è¯´' },
  { level: 6, label: 'UR', color: 'rgba(255, 215, 0, 0.9)', desc: 'ç¥è¯' }
];

@Entry
@Component
struct Index {
  // === æ ¸å¿ƒæ•°æ® ===
  @State currentCard: TarotCard | null = null;
  @State isFlipped: boolean = false;
  @State showResultText: boolean = false;
  @State isVip: boolean = false;

  // === ğŸŒˆ çç¨€åº¦ç³»ç»Ÿ ===
  @State rarityColor: string = 'rgba(0,0,0,0.15)';
  @State rarityLevel: number = 1;
  @State rarityLabel: string = 'N'; // æ–°å¢ï¼šæ˜¾ç¤ºç¨€æœ‰åº¦æ ‡ç­¾

  // === ğŸ¬ åŠ¨ç”»çŠ¶æ€ ===
  @State angle: number = 0;
  @State floatOffsetY: number = 0;
  @State floatRotateZ: number = 0;
  @State clickScale: number = 1;
  @State mysteryScale: number = 1;

  // å…‰å½±ç‰¹æ•ˆ
  @State shadowOpacity: number = 0.15;
  @State shadowRadius: number = 10;
  @State shadowOffsetY: number = 5;
  @State shadowColor: string = 'rgba(0,0,0,0.2)';
  @State guideOpacity: number = 1;

  // æ´—ç‰ŒåŠ¨ç”»
  @State shuffleOffsetX: number = 0;
  @State shuffleRotate: number = 0;
  @State shuffleScale: number = 1;
  @State mainScale: number = 1;
  @State mainOffsetY: number = 0;
  @State mainRotateZ: number = 0;

  // è£…é¥°æ€§ç‰Œå †
  @State deckOffset1: number = 0;
  @State deckOffset2: number = 0;
  @State deckOpacity: number = 0;
  @State deckScale: number = 0.9;
  @State deckAngle1: number = -5;
  @State deckAngle2: number = 5;

  // ğŸ‘» å¹»å½±ç‰Œå †ï¼ˆç”¨äºæ›´åä¸½çš„æ´—ç‰Œ/æ‰‡å½¢åŠ¨ç”»ï¼‰
  @State phantomOffset1: number = 0;
  @State phantomOffset2: number = 0;
  @State phantomAngle1: number = 0;
  @State phantomAngle2: number = 0;
  @State phantomOpacity: number = 0;

  // ğŸ”’ äº¤äº’é”
  @State isAnimating: boolean = false;

  // === ğŸŒˆ ç‰¹æ•ˆå˜é‡ ===
  @State glowScale: number = 1;
  @State glowOpacity: number = 0;
  @State starScale: number = 0;
  @State flashOpacity: number = 0; // æ–°å¢ï¼šå…¨å±é—ªå…‰é€æ˜åº¦
  @State flashColor: string = '#FFFFFF'; // æ–°å¢ï¼šå…¨å±é—ªå…‰é¢œè‰²
  @State godRayRotate: number = 0; // æ–°å¢ï¼šåœ£å…‰æ—‹è½¬è§’åº¦
  @State godRayOpacity: number = 0; // æ–°å¢ï¼šåœ£å…‰é€æ˜åº¦

  // === ğŸ–¼ï¸ è¾¹æ¡†åŠ¨ç”»çŠ¶æ€ ===
  @State borderProgress: number = 0; // 0-4: 0-1(Top), 1-2(Right), 2-3(Bottom), 3-4(Left)
  @State borderOpacity: number = 0;

  // === ğŸ›ï¸ å¼¹çª—çŠ¶æ€æ§åˆ¶ ===
  @State isGallerySheetOpen: boolean = false;
  @State isEnergySheetOpen: boolean = false;
  @State isDeckSheetOpen: boolean = false;

  // === ğŸ¨ ç‰Œç»„ä¸»é¢˜ ===
  @StorageLink('CurrentDeckFolder') currentDeckFolder: string = 'impasto%20style/';

  // === æ•°æ® ===
  @State galleryList: CardRecord[] = [];
  @State collectionProgress: number = 0;
  @State stickers: string[] = [];
  @State todayDate: string = "";
  @State todayWeek: string = "";

  // === P0ï¼šæƒ…ç»ªä¸ä»»åŠ¡ ===
  @State moodIndex: number = -1;
  @State moodNote: string = '';
  @State goldQuote: string = '';
  @State dailyTask: string = '';

  // === P2/P4ï¼šå‘¼å¸ä¸ç§å¯† ===
  @State isBreathingSheetOpen: boolean = false;
  @State breathingPhase: string = 'å‡†å¤‡';
  @State breathingRemaining: number = 60;
  @State privacyMode: boolean = false;

  // === âš¡ èƒ½é‡æ˜¾ç¤ºä¸å……å€¼ ===
  @State currentEnergy: number = 0;

  // === ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯ ===
  @State currentUserInfo: UserInfo | null = null;

  private manager = FortuneManager.getInstance();
  private energyManager = EnergyManager.getInstance();
  private userManager = UserManager.getInstance();
  private context = getContext(this) as common.UIAbilityContext;

  private asyncAnimateTo(duration: number, curve: Curve | string | ICurve, updateFn: () => void): Promise<void> {
    return new Promise((resolve) => {
      animateTo({ duration: duration, curve: curve, onFinish: resolve }, updateFn);
    });
  }

  // æ™ºèƒ½å›¾ç‰‡æºå¤„ç†ï¼šå…¼å®¹ç½‘ç»œå›¾ç‰‡å’Œæœ¬åœ° rawfile
  getCardImageSource(url: string): ResourceStr {
    // å°è¯•æ ¹æ®å½“å‰ç‰Œç»„è§£æåŠ¨æ€ URL
    const finalUrl = resolveDeckImage(url, this.currentDeckFolder);
    
    if (finalUrl && finalUrl.startsWith('http')) {
      return finalUrl;
    }
    return $rawfile(url);
  }

  async aboutToAppear() {
    await this.manager.init(this.context);
    await this.energyManager.init(this.context);
    this.refreshEnergy();

    this.checkState();
    this.initDate();
    this.startGuideAnimation();

    const mood = await this.manager.getTodayMood();
    this.moodIndex = mood.mood;
    this.moodNote = mood.note;

    const aff = await this.manager.getTodayAffirmations();
    this.goldQuote = aff.quote;
    this.dailyTask = aff.task;
    this.privacyMode = await this.manager.isPrivacyMode();

    this.refreshLoginStatus();
  }

  onPageShow() {
    this.refreshEnergy();
    void (async () => {
      const mood = await this.manager.getTodayMood();
      this.moodIndex = mood.mood;
    })();
    this.refreshLoginStatus();
  }

  refreshEnergy() {
    this.currentEnergy = this.energyManager.getEnergy();
  }

  refreshLoginStatus() {
    this.currentUserInfo = this.userManager.getCurrentUser();
  }

  initDate() {
    const now = new Date();
    this.todayDate = `${now.getFullYear()}.${(now.getMonth() + 1).toString().padStart(2, '0')}.${now.getDate().toString().padStart(2, '0')}`;
    const weeks = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    this.todayWeek = weeks[now.getDay()];
  }

  async checkState() {
    this.isVip = await this.manager.isVip();
    const savedData = await this.manager.checkTodayCard();
    if (savedData) {
      this.currentCard = savedData.card;
      this.rarityLevel = savedData.rarityLevel;
      this.rarityColor = savedData.rarityColor;
      
      // æ ¹æ®ç¨€æœ‰åº¦è·å–å¯¹åº”çš„æ ‡ç­¾
      const config = RARITY_CONFIG.find(c => c.level === this.rarityLevel);
      this.rarityLabel = config ? config.label : 'N';

      this.angle = 180;
      this.isFlipped = true;
      this.showResultText = true;
      this.startBreathingAnimation();
      
      // æ¢å¤è¾¹æ¡†çŠ¶æ€
      this.borderProgress = 4;
      this.borderOpacity = 1;
      
      // æ¢å¤é˜´å½±æ•ˆæœ
      this.shadowColor = this.rarityLevel >= 5 ? this.rarityColor : 'rgba(0,0,0,0.2)';
      this.shadowRadius = this.rarityLevel >= 5 ? 30 : 10;
      
      this.updateForm(savedData.card);
    } else {
      this.resetUI();
    }

    // ğŸŸ¢ å¯åŠ¨æ—¶å°è¯•è‡ªåŠ¨åŒæ­¥ï¼ˆä¸é˜»å¡ UIï¼‰
    void (async () => {
      const restored = await CloudService.autoRestore();
      if (restored) {
        // å¦‚æœæœ‰æ–°æ•°æ®æ¢å¤ï¼Œé‡æ–°åˆ·æ–°çŠ¶æ€
        const newSavedCard = await this.manager.checkTodayCard();
        if (newSavedCard && !this.currentCard) {
          this.checkState();
        }
        promptAction.showToast({ message: 'â˜ï¸ æ•°æ®å·²ä»äº‘ç«¯åŒæ­¥' });
      }
    })();
  }

  resetUI() {
    this.currentCard = null;
    this.angle = 0;
    this.isFlipped = false;
    this.showResultText = false;
    this.rarityColor = 'rgba(0,0,0,0.15)';
    this.stopBreathingAnimation();
    this.mainReset();
    // é‡ç½®è¾¹æ¡†åŠ¨ç”»
    this.borderProgress = 0;
    this.borderOpacity = 0;
  }

  mainReset() {
    this.shuffleOffsetX = 0;
    this.shuffleRotate = 0;
    this.shuffleScale = 1;
    this.phantomOpacity = 0;
    this.phantomOffset1 = 0;
    this.phantomOffset2 = 0;
    this.phantomAngle1 = 0;
    this.phantomAngle2 = 0;
    this.isAnimating = false;
    this.godRayOpacity = 0;
    this.godRayRotate = 0;
  }

  @Builder ComplexBorderBuilder() {
    Stack() {
      // 1. é¡¶éƒ¨çº¿æ¡ (ä»å·¦åˆ°å³)
      Row()
        .width(`${Math.min(Math.max(this.borderProgress, 0), 1) * 92}%`) // ç•™å‡ºè§’çš„ä½ç½®
        .height(3)
        .backgroundColor('#FFD700') // é‡‘è‰²
        .shadow({ radius: 2, color: '#AA8800', offsetY: 0 })
        .position({ x: '4%', y: 8 }) // å†…ç¼©ä¸€ç‚¹

      // 2. å³ä¾§çº¿æ¡ (ä»ä¸Šåˆ°ä¸‹)
      Column()
        .height(`${Math.min(Math.max(this.borderProgress - 1, 0), 1) * 92}%`)
        .width(3)
        .backgroundColor('#FFD700')
        .shadow({ radius: 2, color: '#AA8800', offsetY: 0 })
        .position({ x: '94%', y: '4%' }) // x = 100% - 8px - width

      // 3. åº•éƒ¨çº¿æ¡ (ä»å³åˆ°å·¦ - è¿™é‡Œç®€åŒ–ä¸ºä»å·¦åˆ°å³æ˜¾ç¤ºï¼Œè§†è§‰ä¸Šä¸€æ ·ï¼Œå¦‚æœéœ€è¦æ–¹å‘æ„Ÿå¯ä»¥åè½¬å¯¹å…¶æ–¹å¼)
      // ä¸ºäº†å®ç°ä»å³åˆ°å·¦çš„ç»˜åˆ¶æ„Ÿï¼Œæˆ‘ä»¬å¯ä»¥è®©å®ƒå³å¯¹é½
      Row()
        .width(`${Math.min(Math.max(this.borderProgress - 2, 0), 1) * 92}%`)
        .height(3)
        .backgroundColor('#FFD700')
        .shadow({ radius: 2, color: '#AA8800', offsetY: 0 })
        .position({ x: '4%', y: '94%' }) // y = 100% - 8px - height
        // æ³¨æ„ï¼šArkTS Row é»˜è®¤å·¦å¯¹é½ï¼Œå¦‚æœæƒ³ä»å³è¾¹é•¿å‡ºæ¥ï¼Œéœ€è¦åµŒå¥—åœ¨ Stack ä¸” alignment: TopEndï¼Œæˆ–è€…ç”¨ direction
        // è¿™é‡Œç®€å•å¤„ç†ï¼Œç»Ÿä¸€é¡ºæ—¶é’ˆæ„Ÿè§‰

      // 4. å·¦ä¾§çº¿æ¡ (ä»ä¸‹åˆ°ä¸Š)
      Column()
        .height(`${Math.min(Math.max(this.borderProgress - 3, 0), 1) * 92}%`)
        .width(3)
        .backgroundColor('#FFD700')
        .shadow({ radius: 2, color: '#AA8800', offsetY: 0 })
        .position({ x: 8, y: '4%' })

      // 5. å››è§’è£…é¥° (å½“è¿›åº¦åˆ°è¾¾å¯¹åº”é˜¶æ®µæ—¶æ˜¾ç°)
      if (this.borderProgress > 0.1) {
        Text("âœ¦").fontSize(16).fontColor('#FFD700').position({ x: 2, y: 2 })
          .transition({ type: TransitionType.Insert, opacity: 0, scale: { x: 0, y: 0 } })
      }
      if (this.borderProgress > 1.1) {
        Text("âœ¦").fontSize(16).fontColor('#FFD700').position({ x: '92%', y: 2 })
          .transition({ type: TransitionType.Insert, opacity: 0, scale: { x: 0, y: 0 } })
      }
      if (this.borderProgress > 2.1) {
        Text("âœ¦").fontSize(16).fontColor('#FFD700').position({ x: '92%', y: '92%' })
          .transition({ type: TransitionType.Insert, opacity: 0, scale: { x: 0, y: 0 } })
      }
      if (this.borderProgress > 3.1) {
        Text("âœ¦").fontSize(16).fontColor('#FFD700').position({ x: 2, y: '92%' })
          .transition({ type: TransitionType.Insert, opacity: 0, scale: { x: 0, y: 0 } })
      }
      
      // 6. å†…æ¡†è£…é¥°çº¿ (ç»†çº¿ï¼Œå›ºå®šæ˜¾ç¤ºï¼Œéšé€æ˜åº¦æ¸å˜)
      Stack() {
        Rect().width('100%').height('100%').fill('transparent')
          .stroke('#AAFFD700').strokeWidth(1)
      }
      .width('85%').height('90%')
      .opacity(this.borderProgress > 3.5 ? 1 : 0)
      .animation({ duration: 500 })

    }
    .width('100%')
    .height('100%')
    .hitTestBehavior(HitTestMode.None)
    .opacity(this.borderOpacity)
  }

  @Builder GodRayBuilder() {
    Stack() {
      // ä¸»å…‰æŸ
      ForEach([0, 45, 90, 135], (angle: number) => {
        Column()
          .width(30)
          .height(600)
          .linearGradient({
            direction: GradientDirection.Top,
            colors: [[this.rarityLevel === 6 ? '#FFD700' : '#FF4500', 0], ['rgba(255,255,255,0)', 0.5], [this.rarityLevel === 6 ? '#FFD700' : '#FF4500', 1]]
          })
          .opacity(0.3)
          .rotate({ angle: angle })
      })
      // å‰¯å…‰æŸ
      ForEach([22.5, 67.5, 112.5, 157.5], (angle: number) => {
        Column()
          .width(15)
          .height(500)
          .linearGradient({
            direction: GradientDirection.Top,
            colors: [['#FFFFFF', 0], ['rgba(255,255,255,0)', 0.5], ['#FFFFFF', 1]]
          })
          .opacity(0.4)
          .rotate({ angle: angle })
      })
    }
    .width(500)
    .height(500)
    .rotate({ angle: this.godRayRotate })
    .opacity(this.godRayOpacity)
    .hitTestBehavior(HitTestMode.None) // ä¸æ‹¦æˆªç‚¹å‡»
  }

  updateForm(card: TarotCard) {
    try {
      const formData = formBindingData.createFormBindingData({
        'cardImage': card.image,
        'cardName': card.name,
        'cardDesc': card.meaning,
        'goldQuote': this.goldQuote,
        'dailyTask': this.dailyTask,
        'moodNote': this.moodNote,
        'privacyMode': this.privacyMode
      });
      void (async () => {
        const ids = await this.manager.getFormIds();
        for (const id of ids) {
          try {
            await formProvider.updateForm(id, formData);
          } catch (e) {
            const _err = e as BusinessError;
            console.error(`Form update failed: ${_err.message}`);
          }
        }
      })();
    } catch (err) {
      console.error('Form Update Error');
    }
  }

  handleManualReset() {
    this.resetUI();
    promptAction.showToast({ message: 'ğŸ”„ å·²é‡ç½®', duration: 1000 });
  }

  handleBuyVip() {
    animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
      this.isEnergySheetOpen = true;
    });
  }

  async handleRecharge(amount: number) {
    await this.energyManager.recharge(amount);
    this.refreshEnergy();
    promptAction.showToast({ message: `âš¡ æˆåŠŸè¡¥å…… ${amount} ç‚¹å¿ƒåŠ›ï¼` });
    animateTo({ duration: 300 }, () => {
      this.isEnergySheetOpen = false;
    });
  }

  calculateRarity() {
    const rand = Math.random() * 100;
    let config = RARITY_CONFIG[0]; // Default N

    if (rand < 1) config = RARITY_CONFIG.find(c => c.level === 6) || config;      // UR 1%
    else if (rand < 6) config = RARITY_CONFIG.find(c => c.level === 5) || config; // SSR 5%
    else if (rand < 20) config = RARITY_CONFIG.find(c => c.level === 4) || config;// SR 14%
    else if (rand < 50) config = RARITY_CONFIG.find(c => c.level === 3) || config;// R 30%
    else config = RARITY_CONFIG.find(c => c.level === 1) || config;               // N 50%

    this.rarityLevel = config.level;
    this.rarityColor = config.color;
    this.rarityLabel = config.label;
  }

  getFlipDurationByRarity(): number {
    const map = [800, 900, 1000, 1200, 1500, 1800, 2000];
    const idx = Math.min(Math.max(this.rarityLevel, 1), 7) - 1;
    return map[idx];
  }

  getGlowRadiusByRarity(): number {
    const map = [15, 18, 20, 25, 30, 35, 40];
    const idx = Math.min(Math.max(this.rarityLevel, 1), 7) - 1;
    return map[idx];
  }

  startGuideAnimation() { animateTo({ duration: 1500, curve: Curve.EaseInOut, iterations: -1, playMode: PlayMode.Alternate }, () => { this.guideOpacity = 0.3; }); }

  startMysteryAnimation() {
    animateTo({ duration: 2000, curve: Curve.EaseInOut, iterations: -1, playMode: PlayMode.Alternate }, () => {
      this.mysteryScale = 1.05;
      this.shadowRadius = 20;
      this.shadowColor = 'rgba(100,0,200,0.3)';
    });
  }
  stopMysteryAnimation() { animateTo({ duration: 300 }, () => { this.mysteryScale = 1; this.shadowRadius = 10; this.shadowColor = 'rgba(0,0,0,0.15)'; }); }

  startBreathingAnimation() {
    animateTo({ duration: 2500, curve: Curve.EaseInOut, iterations: -1, playMode: PlayMode.Alternate }, () => { this.floatOffsetY = -12; });
    animateTo({ duration: 3500, curve: Curve.Smooth, iterations: -1, playMode: PlayMode.Alternate }, () => { this.floatRotateZ = 1.5; });
  }
  stopBreathingAnimation() { animateTo({ duration: 0 }, () => { this.floatOffsetY = 0; this.floatRotateZ = 0; }); }

  handleClickFeedback() { animateTo({ duration: 100, curve: Curve.EaseOut }, () => { this.clickScale = 0.95; }); setTimeout(() => { animateTo({ duration: 400, curve: curves.springMotion(0.5, 0.6) }, () => { this.clickScale = 1; }); }, 100); }

  async handleDrawCard() {
    if (this.isFlipped) {
      if (this.currentCard) {
        promptAction.showToast({ message: 'ğŸ“… æ¯å¤©åªèƒ½æŠ½å–ä¸€æ¬¡å“¦', duration: 2000 });
        this.handleClickFeedback();
        return;
      }
    }

    // ğŸ”’ é˜²æ­¢é‡å¤ç‚¹å‡»
    if (this.isAnimating) return;
    this.isAnimating = true;

    this.guideOpacity = 0;
    this.stopMysteryAnimation();

    // === ğŸ¬ é˜¶æ®µ 1ï¼šå”¤é†’ç‰Œå † (0ms - 300ms) ===
    // æ˜¾ç°æ‰€æœ‰ç‰Œï¼Œå‡†å¤‡æ´—ç‰Œ
    await this.asyncAnimateTo(300, Curve.EaseOut, () => {
      this.mainScale = 0.9;
      this.shadowRadius = 5;
      this.shadowOffsetY = 2;
      this.deckOpacity = 1;
      this.phantomOpacity = 1; // æ˜¾ç¤ºå¹»å½±ç‰Œ
      // å½’ä½
      this.deckOffset1 = 0; this.deckOffset2 = 0;
      this.phantomOffset1 = 0; this.phantomOffset2 = 0;
    });

    // === ğŸ¬ é˜¶æ®µ 2ï¼šåä¸½æ´—ç‰Œ (300ms - 900ms) ===
    // æ¨¡æ‹Ÿæ´—ç‰ŒåŠ¨ä½œï¼šç‰Œå·¦å³äº¤é”™
    for (let i = 0; i < 4; i++) {
      const dir = i % 2 === 0 ? 1 : -1;
      await this.asyncAnimateTo(150, Curve.Rhythm, () => {
        this.shuffleRotate = 2 * dir;
        this.deckOffset1 = -20 * dir;
        this.deckOffset2 = 20 * dir;
        this.phantomOffset1 = -40 * dir;
        this.phantomOffset2 = 40 * dir;
        this.deckAngle1 = -5 * dir;
        this.deckAngle2 = 5 * dir;
      });
    }

    // åœ¨æ´—ç‰Œé—´éš™è·å–æ•°æ®
    this.currentCard = await this.manager.drawDailyCard();
    this.calculateRarity();

    if (this.currentCard) {
      await this.manager.saveDrawResult(this.currentCard, this.rarityColor, this.rarityLevel);
      CloudService.autoSave();
    }

    // === ğŸ¬ é˜¶æ®µ 3ï¼šæ‰‡å½¢å±•å¼€ (900ms - 1400ms) ===
    await this.asyncAnimateTo(500, curves.springMotion(0.6, 0.8), () => {
      this.shuffleRotate = 0;
      this.mainScale = 1.0;
      // æ‰‡å½¢å±•å¼€
      this.deckOffset1 = -60;   this.deckAngle1 = -10;
      this.deckOffset2 = 60;    this.deckAngle2 = 10;
      this.phantomOffset1 = -120; this.phantomAngle1 = -20;
      this.phantomOffset2 = 120;  this.phantomAngle2 = 20;
    });

    // ç¨ä½œåœé¡¿
    await new Promise<void>(r => setTimeout(r, 200));

    // === ğŸ¬ é˜¶æ®µ 4ï¼šé€‰ä¸­æŠ½ç¦» (1600ms - 2100ms) ===
    await this.asyncAnimateTo(500, curves.springMotion(0.7, 0.7), () => {
      // ä¸»ç‰Œçªå‡ºå¹¶ä¸Šæµ®
      this.mainScale = 1.1;
      this.floatOffsetY = -50;
      this.shadowRadius = 30;
      this.shadowColor = 'rgba(0,0,0,0.3)';
      
      // å…¶ä»–ç‰Œé€€æ•£
      this.deckOpacity = 0;
      this.phantomOpacity = 0;
      this.deckOffset1 = -200; this.deckOffset2 = 200;
      this.phantomOffset1 = -300; this.phantomOffset2 = 300;
    });

    // === ğŸ¬ é˜¶æ®µ 5ï¼šç¿»è½¬æ­æ™“ ===
    const flipDuration = this.getFlipDurationByRarity();

    // ğŸŒŸ SSR/UR ä¸“å±ç‚«é…·ç‰¹æ•ˆ
    if (this.rarityLevel >= 5) {
      setTimeout(() => {
        // 1. å…¨å±é—ªå…‰
        this.flashColor = this.rarityLevel === 6 ? '#FFD700' : '#FF4500'; // URé‡‘å…‰ï¼ŒSSRçº¢å…‰
        animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
          this.flashOpacity = 0.8;
        });
        setTimeout(() => {
          animateTo({ duration: 800, curve: Curve.EaseIn }, () => {
            this.flashOpacity = 0;
          });
        }, 300);

        // 2. åœ£å…‰é™ä¸´ (God Ray)
        this.godRayOpacity = 0;
        this.godRayRotate = 0;
        
        // å¯åŠ¨åœ£å…‰æ—‹è½¬ (æŒç»­æ—‹è½¬)
        animateTo({ duration: 10000, curve: Curve.Linear, iterations: -1, playMode: PlayMode.Normal }, () => {
            this.godRayRotate = 360;
        });

        // åœ£å…‰æ¸æ˜¾
        animateTo({ duration: 1000, curve: Curve.EaseOut }, () => {
          this.godRayOpacity = 1;
        });

        // 3. æ˜Ÿå…‰ç²’å­æµ®ç°
        this.starScale = 0;
        animateTo({ duration: 800, curve: curves.springMotion(0.6, 0.8) }, () => {
          this.starScale = 1.5;
        });
      }, flipDuration / 2 - 200); // åœ¨ç¿»è½¬å¿«ç»“æŸæ—¶è§¦å‘
    }

    await this.asyncAnimateTo(flipDuration, curves.springMotion(0.6, 0.8), () => {
      this.angle = 180;
      this.mainScale = 1.0;
      this.floatOffsetY = 0;
      this.shadowRadius = 20;
      this.shadowOffsetY = 10;
    });

    // æ™®é€šå¡ç‰Œä¸éœ€è¦å…‰æ™•å¸¸é©»ï¼Œæˆ–è€…ä»…ä¿ç•™å¾®å¼±å…‰æ™•
    await this.asyncAnimateTo(500, Curve.EaseOut, () => {
      // åªæœ‰ SSR/UR ä¿ç•™åœ£å…‰ï¼Œå…¶ä»–æ— é¢å¤–å…‰æ™•
      this.shadowColor = this.rarityLevel >= 5 ? this.rarityColor : 'rgba(0,0,0,0.2)'; 
      this.shadowRadius = this.rarityLevel >= 5 ? 30 : 10;
      this.shadowOffsetY = 0;
    });

    this.isFlipped = true;

    // ğŸŒŸ å¯åŠ¨è¾¹æ¡†ç»˜åˆ¶åŠ¨ç”»
    this.borderOpacity = 1;
    animateTo({ duration: 2500, curve: Curve.EaseOut }, () => {
      this.borderProgress = 4;
    });

    this.isAnimating = false; // è§£é”
    this.startBreathingAnimation();

    if (this.currentCard) {
      this.goldQuote = this.manager.createGoldQuote(this.currentCard);
      this.dailyTask = this.manager.createDailyTask(this.currentCard);
      await this.manager.setTodayAffirmations(this.goldQuote, this.dailyTask);
      this.updateForm(this.currentCard);
    }

    animateTo({ duration: 600 }, () => { this.showResultText = true; });
  }

  // ğŸŸ¢ è·³è½¬åˆ°åˆ†äº«é¢„è§ˆé¡µ
  handleShare() {
    if (!this.currentCard) return;
    router.pushUrl({
      url: 'pages/SharePreviewPage',
      params: {
        card: this.currentCard,
        todayDate: this.todayDate,
        todayWeek: this.todayWeek,
        goldQuote: this.goldQuote,
        privacyMode: this.privacyMode
      }
    });
  }

  async handleUserClick() {
    if (this.currentUserInfo) {
      promptAction.showDialog({
        title: 'è´¦å·ç®¡ç†',
        message: `å½“å‰ç™»å½•ï¼š${this.currentUserInfo.nickname}\næ˜¯å¦é€€å‡ºç™»å½•ï¼Ÿ`,
        buttons: [
          { text: 'é€€å‡ºç™»å½•', color: '#FF0000' },
          { text: 'å–æ¶ˆ', color: '#999999' }
        ]
      }, (err, data) => {
        if (data.index === 0) {
          this.userManager.logout();
          this.refreshLoginStatus();
          promptAction.showToast({ message: 'å·²é€€å‡ºç™»å½•' });
        }
      });
    } else {
      try {
        const user = await this.userManager.login(this.context);
        this.refreshLoginStatus();
        promptAction.showToast({ message: `æ¬¢è¿ï¼Œ${user.nickname}` });
      } catch (e) {
      }
    }
  }

  async handleCloudSync() {
    let currentUser = this.userManager.getCurrentUser();

    if (!this.userManager.isLoggedIn()) {
      try {
        promptAction.showToast({ message: 'æ­£åœ¨è¿æ¥åä¸ºè´¦å·...', duration: 1500 });
        currentUser = await this.userManager.login(this.context);
        this.refreshLoginStatus();
        promptAction.showToast({ message: `æ¬¢è¿å›æ¥ï¼Œ${currentUser.nickname}`, duration: 2000 });
      } catch (err) {
        const error = err as BusinessError;
        console.error('ç™»å½•å¤±è´¥', JSON.stringify(error));
        promptAction.showToast({ message: 'éœ€è¦ç™»å½•æ‰èƒ½åŒæ­¥æ•°æ®å“¦', duration: 2000 });
        return;
      }
    }

    if (!currentUser) return;

    const realUserId = currentUser.userId;
    const realToken = currentUser.token;

    promptAction.showToast({ message: 'æ­£åœ¨è¿æ¥äº‘ç«¯...', duration: 1000 });
    const isOnline = await CloudService.checkConnection();
    const statusEmoji = isOnline ? 'ğŸŸ¢' : 'ğŸ”´';
    const statusText = isOnline ? 'æœåŠ¡å™¨åœ¨çº¿' : 'æœåŠ¡å™¨è¿æ¥å¤±è´¥';

    promptAction.showDialog({
      title: `â˜ï¸ äº‘ç«¯åŒæ­¥ (${statusEmoji} ${statusText})`,
      message: isOnline
        ? `å½“å‰è´¦å·: ${currentUser.nickname}\nè¯·é€‰æ‹©æ“ä½œï¼š\nâ€¢ ä¸Šä¼ ï¼šå¤‡ä»½æœ¬æœºæ•°æ®åˆ°äº‘ç«¯\nâ€¢ ä¸‹è½½ï¼šä»äº‘ç«¯æ¢å¤æ•°æ®åˆ°æœ¬æœº`
        : 'âš ï¸ æ— æ³•è¿æ¥åˆ°äº‘æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚',
      buttons: [
        { text: 'â¬†ï¸ ä¸Šä¼ å¤‡ä»½', color: isOnline ? '#007DFF' : '#CCCCCC' },
        { text: 'â¬‡ï¸ ä¸‹è½½æ¢å¤', color: isOnline ? '#007DFF' : '#CCCCCC' },
        { text: 'å–æ¶ˆ', color: '#999999' }
      ]
    }, async (err, data) => {
      if (err || data.index === 2 || !isOnline) return;

      if (data.index === 0) {
        promptAction.showToast({ message: 'æ­£åœ¨ä¸Šä¼ å¤‡ä»½...', duration: 2000 });
        const allData = await this.manager.exportAllData();
        const success = await CloudService.backupData(realUserId, realToken, allData);
        if (success) {
          promptAction.showToast({ message: 'âœ… å¤‡ä»½æˆåŠŸï¼' });
        } else {
          promptAction.showToast({ message: 'âŒ å¤‡ä»½å¤±è´¥' });
        }
      } else {
        promptAction.showToast({ message: 'æ­£åœ¨ä¸‹è½½æ¢å¤...', duration: 2000 });
        const jsonStr = await CloudService.restoreData(realUserId, realToken);
        if (jsonStr) {
          const ok = await this.manager.importData(jsonStr);
          if (ok) {
            promptAction.showToast({ message: 'âœ… æ¢å¤æˆåŠŸï¼Œå³å°†åˆ·æ–°...' });
            this.checkState();
            this.initDate();
          } else {
            promptAction.showToast({ message: 'âš ï¸ æ•°æ®è§£æå¤±è´¥' });
          }
        } else {
          promptAction.showToast({ message: 'âŒ æœªæ‰¾åˆ°äº‘ç«¯å¤‡ä»½æˆ–ä¸‹è½½å¤±è´¥' });
        }
      }
    });
  }

  async handleAIAnalyze() {
    // ... è°ƒç”¨ SpreadPage åŒæ¬¾çš„ AI åˆ†æé€»è¾‘ï¼Œæˆ–è€…è·³è½¬åˆ° SpreadPage
    router.pushUrl({ url: 'pages/SpreadPage' });
  }

  // ğŸŸ¢ è¡¥å› loadGalleryData
  async loadGalleryData() {
    this.isGallerySheetOpen = true;
    this.isEnergySheetOpen = false;
    this.galleryList = await this.manager.getGallery();
    this.collectionProgress = Math.round((this.galleryList.length / TAROT_DECK.length) * 100);
  }

  // ğŸŸ¢ è¡¥å› isCollected
  isCollected(id: number): boolean {
    return this.galleryList.some(record => record.cardId === id);
  }

  // ğŸŸ¢ è¡¥å› getCardRarityColor
  getCardRarityColor(id: number): string {
    const record = this.galleryList.find(r => r.cardId === id);
    return record ? record.rarityColor : 'rgba(0,0,0,0.1)';
  }

  // ğŸŸ¢ æ–°å¢ï¼šè·å–å¡ç‰Œç¨€æœ‰åº¦æ ‡ç­¾
  getCardRarityLabel(id: number): string {
    const record = this.galleryList.find(r => r.cardId === id);
    if (!record || !record.rarityLevel) return 'N';
    const config = RARITY_CONFIG.find(c => c.level === record.rarityLevel);
    return config ? config.label : 'N';
  }

  @Builder GallerySheetBuilder() {
    Column() {
      Row() {
        Column() {
          Text("æ²»æ„ˆå±•è§ˆå…").fontSize(24).fontWeight(FontWeight.Bold).fontColor('#333333')
          Text(`å·²æ”¶é›† ${this.galleryList.length} / ${TAROT_DECK.length} å¼ `).fontSize(13).fontColor('#888888').margin({ top: 4 })
        }.alignItems(HorizontalAlign.Start)
        Blank()
        Stack() {
          Progress({ value: this.collectionProgress, total: 100, type: ProgressType.Ring }).color('#FB7299').width(44)
          Text(`${this.collectionProgress}%`).fontSize(10).fontColor('#FB7299').fontWeight(FontWeight.Bold)
        }.margin({ right: 32 })
      }.width('100%').padding({ left: 24, right: 24, top: 24, bottom: 10 })
      Divider().color('#F9F9F9').width('90%')
      Grid() {
        ForEach(TAROT_DECK, (card: TarotCard) => {
          GridItem() {
            Column() {
              if (this.isCollected(card.id)) {
                Stack() {
                  Image(this.getCardImageSource(card.image))
                    .width('100%').aspectRatio(2/3).borderRadius(10)
                    .shadow({ radius: 8, color: this.getCardRarityColor(card.id), offsetY: 2 })
                    .alt($rawfile('card_back.png'))
                  
                  // ğŸŒŸ ç¨€æœ‰åº¦æ ‡ç­¾
                  Text(this.getCardRarityLabel(card.id))
                    .fontSize(10).fontWeight(FontWeight.Bold).fontColor(Color.White)
                    .backgroundColor(this.getCardRarityColor(card.id))
                    .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                    .borderRadius({ topLeft: 8, bottomRight: 8 })
                    .position({ x: 0, y: 0 })
                }
                Text(card.name).fontSize(12).fontColor('#333').fontWeight(FontWeight.Medium).margin({ top: 8 })
              } else {
                Stack() {
                  Rect().width('100%').height('100%').fill('#F7F8FA').borderRadius(10).strokeWidth(1).stroke('#F0F0F0')
                  Column({space: 4}) { Text("ğŸ”’").fontSize(18).fontColor('#DDD'); Text("???").fontSize(10).fontColor('#EEE') }
                }.width('100%').aspectRatio(2/3)
                Text("å¾…è§£é”").fontSize(12).fontColor('#EEE').margin({ top: 8 })
              }
            }
          }
        })
      }.columnsTemplate('1fr 1fr 1fr').columnsGap(12).rowsGap(20).padding({ left: 20, right: 20, top: 20, bottom: 80 }).layoutWeight(1)
    }
    .width('100%').height('85%').backgroundColor(Color.White).borderRadius({ topLeft: 24, topRight: 24 })
  }

  @Builder EnergySheetBuilder() {
    Column() {
      Row().width(40).height(5).backgroundColor('#E0E0E0').borderRadius(10).margin({ top: 10, bottom: 20 })
      Text("âš¡ å¿ƒåŠ›åŠ æ²¹ç«™").fontSize(20).fontWeight(FontWeight.Bold).fontColor('#333').margin({ bottom: 8 })
      Text(`å½“å‰å‰©ä½™: ${this.currentEnergy}`).fontSize(14).fontColor('#999').margin({ bottom: 30 })

      Row() {
        Column() { Text("æ¯æ—¥è¡¥ç»™").fontSize(16).fontWeight(FontWeight.Bold); Text("æ¯å¤© 00:00 è‡ªåŠ¨æ¢å¤è‡³ 20 ç‚¹").fontSize(12).fontColor('#999').margin({ top: 4 }) }.alignItems(HorizontalAlign.Start)
        Blank()
        Button("å·²é¢†å–").backgroundColor('#F5F5F5').fontColor('#BBB').height(32).fontSize(12).enabled(false)
      }.width('90%').padding(16).backgroundColor('#FAFAFA').borderRadius(16).margin({ bottom: 12 })

      Row() {
        Column() { Text("è§‚çœ‹å¹¿å‘Š").fontSize(16).fontWeight(FontWeight.Bold); Text("ç«‹å³è·å¾— +10 å¿ƒåŠ›").fontSize(12).fontColor('#999').margin({ top: 4 }) }.alignItems(HorizontalAlign.Start)
        Blank()
        Button("å»è§‚çœ‹").backgroundColor('#E1F5FE').fontColor('#0277BD').height(32).fontSize(12).onClick(() => this.handleRecharge(10))
      }.width('90%').padding(16).backgroundColor('#FAFAFA').borderRadius(16).margin({ bottom: 12 })

      Row() {
        Column() { Text("å¿ƒåŠ›ç¤¼åŒ…").fontSize(16).fontWeight(FontWeight.Bold); Text("è·å¾— +100 å¿ƒåŠ›").fontSize(12).fontColor('#999').margin({ top: 4 }) }.alignItems(HorizontalAlign.Start)
        Blank()
        Button("Â¥ 6.00").backgroundColor('#FCE4EC').fontColor('#FB7299').height(32).fontSize(12).onClick(() => this.handleRecharge(100))
      }.width('90%').padding(16).backgroundColor('#FAFAFA').borderRadius(16)
    }
    .width('100%').height('50%').backgroundColor(Color.White).borderRadius({ topLeft: 24, topRight: 24 })
  }

  @Builder
  DeckSheetBuilder() {
    DeckSelectionSheet({ isOpen: $isDeckSheetOpen })
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Scroll() {
        Column() {
          Row() {
            // å·¦ä¾§æ˜¾ç¤ºç”¨æˆ·å¤´åƒæˆ–ç™»å½•æç¤º
            Row() {
              if (this.currentUserInfo && this.currentUserInfo.avatar) {
                // å¤´åƒä½¿ç”¨ getCardImageSource å…¼å®¹æœ¬åœ°/ç½‘ç»œ
                Image(this.getCardImageSource(this.currentUserInfo.avatar))
                  .width(32).height(32).borderRadius(16).margin({ right: 8 })
                  .alt($r('app.media.startIcon'))
              } else {
                // æœªç™»å½•æ˜¾ç¤ºé»˜è®¤å›¾æ ‡
                Text('ğŸ‘¤').fontSize(24).margin({ right: 8 })
              }

              if (this.currentUserInfo) {
                Text(this.currentUserInfo.nickname || 'ç”¨æˆ·')
                  .fontSize(14).fontColor('#555').fontWeight(FontWeight.Medium)
              } else {
                Text('ç™»å½•').fontSize(14).fontColor('#666')
              }
            }
            .backgroundColor('rgba(255,255,255,0.85)')
            .backdropBlur(10)
            .padding({ left: 8, right: 12, top: 6, bottom: 6 })
            .borderRadius(20)
            .shadow({ radius: 10, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
            .onClick(() => this.handleUserClick())

            Blank()

            // äº‘åŒæ­¥å…¥å£
            Button({ type: ButtonType.Circle }) { Text('â˜ï¸').fontSize(16) }
            .width(36).height(36)
            .backgroundColor('rgba(255,255,255,0.85)')
            .backdropBlur(10)
            .shadow({ radius: 10, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
            .margin({ right: 12 })
            .onClick(() => {
              // ç‚¹å‡»æ—¶æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡åŒæ­¥æ£€æŸ¥
              promptAction.showToast({ message: 'æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...', duration: 1500 });
              CloudService.autoSave();
              void (async () => {
                const restored = await CloudService.autoRestore();
                if(restored) {
                  this.checkState();
                  promptAction.showToast({ message: 'âœ… åŒæ­¥å®Œæˆ' });
                }
              })();
            })

            Row() {
              Text('âš¡').fontSize(14)
              Text(`${this.currentEnergy}`).fontSize(14).fontColor('#FB7299').fontWeight(FontWeight.Bold).margin({left: 2})
            }
            .backgroundColor('rgba(255,255,255,0.85)')
            .backdropBlur(10)
            .padding({left: 12, right: 12, top: 8, bottom: 8})
            .borderRadius(18)
            .margin({right: 12})
            .shadow({ radius: 10, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
            .onClick(() => this.handleBuyVip())

            Button({ type: ButtonType.Circle }) { Text('ğŸ›ï¸').fontSize(18) }
            .width(40).height(40)
            .backgroundColor('rgba(255,255,255,0.9)')
            .backdropBlur(10)
            .shadow({ radius: 10, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
            .onClick(() => this.loadGalleryData())
          }.width('100%').padding({ left: 24, right: 24, top: 16 }).height(60)

          Blank().height(20)

          Stack() {
            Circle({ width: 260, height: 260 }).fill('#FFFFFF').opacity(0.4)
              .scale({ x: this.mysteryScale, y: this.mysteryScale }).blur(50)

            if (this.rarityLevel >= 5) {
              this.GodRayBuilder()
            }

            // è£…é¥°æ€§ç‰Œå †ä½¿ç”¨ CARD_BACK_URL
            // ğŸ‘» å¹»å½±ç‰Œ 1 (å·¦è¿œ)
            Image(CARD_BACK_URL).width('100%').height('100%').borderRadius(16)
              .scale({ x: this.deckScale, y: this.deckScale })
              .translate({ x: this.phantomOffset1 })
              .rotate({ z: 1, angle: this.phantomAngle1 })
              .opacity(this.phantomOpacity)
              .alt($rawfile('card_back.png'))

            // ğŸ‘» å¹»å½±ç‰Œ 2 (å³è¿œ)
            Image(CARD_BACK_URL).width('100%').height('100%').borderRadius(16)
              .scale({ x: this.deckScale, y: this.deckScale })
              .translate({ x: this.phantomOffset2 })
              .rotate({ z: 1, angle: this.phantomAngle2 })
              .opacity(this.phantomOpacity)
              .alt($rawfile('card_back.png'))

            // åŸæœ‰è£…é¥°ç‰Œ 1 (å·¦)
            Image(CARD_BACK_URL).width('100%').height('100%').borderRadius(16)
              .scale({ x: this.deckScale, y: this.deckScale }).translate({ x: this.deckOffset1 }).rotate({ z: 1, angle: this.deckAngle1 }).opacity(this.deckOpacity)
              .alt($rawfile('card_back.png'))

            // åŸæœ‰è£…é¥°ç‰Œ 2 (å³)
            Image(CARD_BACK_URL).width('100%').height('100%').borderRadius(16)
              .scale({ x: this.deckScale, y: this.deckScale }).translate({ x: this.deckOffset2 }).rotate({ z: 1, angle: this.deckAngle2 }).opacity(this.deckOpacity)
              .alt($rawfile('card_back.png'))

            // ç¿»è½¬åŠ¨ç”»çš„èƒŒé¢ä½¿ç”¨ CARD_BACK_URL
            Image(CARD_BACK_URL).width('100%').height('100%').borderRadius(16)
              .rotate({ x: 0, y: 1, z: 0, angle: this.angle }).opacity(this.angle < 90 ? 1 : 0)
              .alt($rawfile('card_back.png'))

            if (this.currentCard) {
              // ä½¿ç”¨é€šç”¨æ–¹æ³•è·å–å›¾ç‰‡
              Image(this.getCardImageSource(this.currentCard.image))
                .width('100%').height('100%').borderRadius(16)
                .rotate({ x: 0, y: 1, z: 0, angle: this.angle - 180 }).opacity(this.angle >= 90 ? 1 : 0)
                .alt($rawfile('card_back.png')) // æ·»åŠ åŠ è½½å ä½å›¾
              
              // ğŸŒŸ ç»˜åˆ¶è¾¹æ¡†åŠ¨ç”» (è·Ÿéšå¡ç‰Œç¿»è½¬)
              if (this.isFlipped) {
                Column() {
                  this.ComplexBorderBuilder()
                }
                .width('100%').height('100%')
                .rotate({ x: 0, y: 1, z: 0, angle: this.angle - 180 })
                .opacity(this.angle >= 90 ? 1 : 0)
                .hitTestBehavior(HitTestMode.None)
              }
            }

            if (this.currentCard && this.rarityLevel >= 6 && this.isFlipped) {
              Text("âœ¨").fontSize(40).position({x: -20, y: -20})
                .scale({x: this.starScale, y: this.starScale})
                .rotate({angle: -15})
                .animation({duration: 1000, iterations: -1, playMode: PlayMode.Alternate})
              Text("âœ¨").fontSize(30).position({x: '85%', y: '85%'})
                .scale({x: this.starScale, y: this.starScale})
                .rotate({angle: 15})
                .animation({duration: 1200, iterations: -1, playMode: PlayMode.Alternate, delay: 200})
            }
          }
          .width('70%').aspectRatio(2/3).margin({ top: 20, bottom: 30 })
          .rotate({ z: 1, angle: this.mainRotateZ + this.shuffleRotate })
          .translate({ x: this.shuffleOffsetX, y: this.floatOffsetY + this.mainOffsetY })
          .scale({ x: this.shuffleScale * this.clickScale, y: this.shuffleScale * this.clickScale })
          .shadow({ radius: this.shadowRadius, color: this.shadowColor, offsetY: this.shadowOffsetY })
          .onClick(() => { this.handleDrawCard(); })

          if (this.showResultText && this.currentCard) {
            Column() {
              Row() {
                // ğŸŒŸ ç»“æœé¡µç¨€æœ‰åº¦æ ‡ç­¾
                Text(this.rarityLabel)
                  .fontSize(14).fontWeight(FontWeight.Bold).fontColor(Color.White)
                  .backgroundColor(this.rarityColor)
                  .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                  .borderRadius(6)
                  .margin({ right: 8 })

                Text(this.currentCard.name).fontSize(24).fontWeight(FontWeight.Bold).fontColor('#333333')
              }.margin({bottom: 4})

              Text(this.currentCard.name_en).fontSize(14).fontColor('#AAAAAA').fontStyle(FontStyle.Italic).margin({bottom: 16})
              Text(this.currentCard.desc).fontSize(16).fontColor('#555555').textAlign(TextAlign.Center).lineHeight(26).padding({ left: 20, right: 20 }).opacity(0.9)
              Divider().color('rgba(0,0,0,0.05)').width('80%').margin({top: 24, bottom: 24})

              // 1. ä¸»è¦æ“ä½œï¼šæ·±åº¦è§£è¯» (å¼ºè°ƒè‰²ï¼Œå æ®Cä½)
              Button("ğŸ”® æ·±åº¦è§£è¯»")
                .backgroundColor('#87CEEB') // å¤©ç©ºè“ï¼Œæ²»æ„ˆç³»
                .linearGradient({
                  direction: GradientDirection.Right,
                  colors: [['#89CFF0', 0], ['#B0E0E6', 1]]
                })
                .fontColor(Color.White)
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .height(56)
                .width('100%')
                .borderRadius(28)
                .shadow({ radius: 15, color: 'rgba(137, 207, 240, 0.4)', offsetY: 5 })
                .margin({ bottom: 16 })
                .stateStyles({ pressed: { .scale({ x: 0.98, y: 0.98 }) }, normal: { .scale({ x: 1, y: 1 }) } })
                .onClick(() => router.pushUrl({ url: 'pages/SpreadPage' }))

              // 2. æ¬¡è¦æ“ä½œï¼šåˆ†äº« & è®°å½• (å¹¶æ’ï¼Œè½»é‡åŒ–)
              Row({ space: 12 }) {
                Button("âœ¨ åˆ†äº«")
                  .backgroundColor('#F5F7FA')
                  .fontColor('#555')
                  .height(48)
                  .layoutWeight(1)
                  .borderRadius(24)
                  .stateStyles({ pressed: { .scale({ x: 0.96, y: 0.96 }) }, normal: { .scale({ x: 1, y: 1 }) } })
                  .onClick(() => this.handleShare())

                if (this.moodIndex === -1) {
                  Button("ğŸ“ è®°å½•å¿ƒæƒ…")
                    .backgroundColor('#FFF0F5')
                    .fontColor('#DB7093') // è‹ç´«ç½—å…°è‰²
                    .height(48)
                    .layoutWeight(1)
                    .borderRadius(24)
                    .stateStyles({ pressed: { .scale({ x: 0.96, y: 0.96 }) }, normal: { .scale({ x: 1, y: 1 }) } })
                    .onClick(() => router.pushUrl({ url: 'pages/MoodPage' }))
                } else {
                  // å¦‚æœå·²è®°å½•ï¼Œæ˜¾ç¤ºæŸ¥çœ‹æŒ‰é’®æˆ–å ä½
                  Button("âœ… å·²è®°å½•")
                    .backgroundColor('#F0FFF0')
                    .fontColor('#3CB371')
                    .height(48)
                    .layoutWeight(1)
                    .borderRadius(24)
                    .stateStyles({ pressed: { .scale({ x: 0.96, y: 0.96 }) }, normal: { .scale({ x: 1, y: 1 }) } })
                    .onClick(() => router.pushUrl({ url: 'pages/MoodPage' }))
                }
              }
              .width('100%')
              .margin({ bottom: 20 })

              // 3. åº•éƒ¨åŠŸèƒ½ï¼šè¡¥å……å¿ƒåŠ› & ç‰Œç»„
              Row() {
                Row() {
                  Text("âš¡ è¡¥å……å¿ƒåŠ›").fontSize(14).fontColor('#AAA').margin({ right: 4 })
                  Text("è·å¾—æ›´å¤šæŒ‡å¼•").fontSize(12).fontColor('#CCC')
                }
                .layoutWeight(1)
                .justifyContent(FlexAlign.Center)
                .onClick(() => this.handleBuyVip())

                Divider().vertical(true).height(20).color('#DDD').margin({ left: 8, right: 8 })

                Row() {
                  Text("ğŸ¨ æ›´æ¢ç‰Œç»„").fontSize(14).fontColor('#AAA')
                }
                .layoutWeight(1)
                .justifyContent(FlexAlign.Center)
                .onClick(() => {
                   animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
                     this.isDeckSheetOpen = true;
                   })
                })
              }
              .width('100%')
              .height(40)
              .backgroundColor('rgba(255,255,255,0.5)')
              .borderRadius(20)
            }
            .width('90%').backgroundColor('rgba(255,255,255,0.90)').backdropBlur(40).borderRadius(32).padding({ left: 24, right: 24, top: 32, bottom: 24 })
            .shadow({ radius: 40, color: 'rgba(0, 0, 0, 0.08)', offsetY: 10 })
            .transition({ type: TransitionType.Insert, opacity: 0, translate: { y: 20 } })
          } else {
            Text("ç‚¹å‡»å¡ç‰Œï¼Œå¼€å¯ä»Šæ—¥æŒ‡å¼•").fontSize(14).fontColor('#AAAAAA').letterSpacing(1).opacity(this.guideOpacity).margin({ top: 20 })
          }
          Blank().height(120)
        }.width('100%')
      }
      .width('100%').height('100%').scrollBar(BarState.Off)

      BottomNavBar({ current: 'index' })

      if (this.isGallerySheetOpen) {
        Column() {
          Column()
            .width('100%').height('100%').backgroundColor('rgba(0,0,0,0.4)')
            .onClick(() => { animateTo({ duration: 300, curve: Curve.EaseOut }, () => { this.isGallerySheetOpen = false; }); })
            .transition({ opacity: 0 })
            .zIndex(100)
          Column() { this.GallerySheetBuilder() }
          .width('100%')
          .transition({ type: TransitionType.Insert, translate: { y: '100%' } })
          .zIndex(101).position({ y: '15%' }).constraintSize({ maxWidth: 480 })
        }.width('100%').height('100%').zIndex(200)
      }

      if (this.isEnergySheetOpen) {
        Column() {
          Column()
            .width('100%').height('100%').backgroundColor('rgba(0,0,0,0.4)')
            .onClick(() => { animateTo({ duration: 300, curve: Curve.EaseOut }, () => { this.isEnergySheetOpen = false; }); })
            .transition({ opacity: 0 })
            .zIndex(100)
          Column() { this.EnergySheetBuilder() }
          .width('100%')
          .transition({ type: TransitionType.Insert, translate: { y: '100%' } })
          .zIndex(101).position({ y: '50%' }).constraintSize({ maxWidth: 480 })
        }.width('100%').height('100%').zIndex(200)
      }

      if (this.isDeckSheetOpen) {
        Column() {
          Column()
            .width('100%').height('100%').backgroundColor('rgba(0,0,0,0.4)')
            .onClick(() => { animateTo({ duration: 300, curve: Curve.EaseOut }, () => { this.isDeckSheetOpen = false; }); })
            .transition({ opacity: 0 })
            .zIndex(100)
          Column() { this.DeckSheetBuilder() }
          .width('100%')
          .transition({ type: TransitionType.Insert, translate: { y: '100%' } })
          .zIndex(101).position({ y: '35%' }).constraintSize({ maxWidth: 480 }) // Higher position
        }.width('100%').height('100%').zIndex(200)
      }

      // ğŸŒŸ å…¨å±é—ªå…‰ (Flash Effect)
      Rect().width('100%').height('100%').fill(this.flashColor).opacity(this.flashOpacity)
        .hitTestBehavior(HitTestMode.None)
        .zIndex(999)
    }
    .width('100%').height('100%')
    .linearGradient({ direction: GradientDirection.Top, colors: [['#FFF9F9', 0.0], ['#FFF0F5', 1.0]] })
  }
}