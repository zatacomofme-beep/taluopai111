import { FortuneManager, CardRecord } from '../common/FortuneManager';
import { systemShare } from '@kit.ShareKit';
import { image } from '@kit.ImageKit';
import { fileIo as fs, fileUri } from '@kit.CoreFileKit';
import { uniformTypeDescriptor as utd } from '@kit.ArkData';
import { TarotCard, TAROT_DECK } from '../model/TarotData';
import common from '@ohos.app.ability.common';
import { abilityAccessCtrl } from '@kit.AbilityKit';
import { promptAction, curves, router, componentSnapshot } from '@kit.ArkUI';
import { formBindingData, formProvider } from '@kit.FormKit';
import { BottomNavBar } from '../common/BottomNavBar';
import { ImageSaver } from '../common/ImageSaver';
import { EnergyManager } from '../common/EnergyManager';
import { ShareHelper } from '../common/ShareHelper';

@Entry
@Component
struct Index {
  // === æ ¸å¿ƒæ•°æ® ===
  @State currentCard: TarotCard | null = null;
  @State isFlipped: boolean = false;
  @State showResultText: boolean = false;
  @State isVip: boolean = false;

  // === ğŸŒˆ çç¨€åº¦ç³»ç»Ÿ ===
  @State rarityColor: string = 'rgba(0,0,0,0.15)';
  @State rarityLevel: number = 1;

  // === ğŸ¬ åŠ¨ç”»çŠ¶æ€ ===
  @State angle: number = 0;
  @State floatOffsetY: number = 0;
  @State floatRotateZ: number = 0;
  @State clickScale: number = 1;
  @State mysteryScale: number = 1;

  // å…‰å½±ç‰¹æ•ˆ
  @State shadowOpacity: number = 0.15;
  @State shadowRadius: number = 10;
  @State shadowOffsetY: number = 5;
  @State shadowColor: string = 'rgba(0,0,0,0.2)';
  @State guideOpacity: number = 1;

  // æ´—ç‰ŒåŠ¨ç”»
  @State shuffleOffsetX: number = 0;
  @State shuffleRotate: number = 0;
  @State shuffleScale: number = 1;
  @State mainScale: number = 1;
  @State mainOffsetY: number = 0;
  @State mainRotateZ: number = 0;

  // è£…é¥°æ€§ç‰Œå †
  @State deckOffset1: number = 0;
  @State deckOffset2: number = 0;
  @State deckOpacity: number = 0;
  @State deckScale: number = 0.9;
  @State deckAngle1: number = -5;
  @State deckAngle2: number = 5;

  // === ğŸŒˆ ç‰¹æ•ˆå˜é‡ ===
  @State glowScale: number = 1;
  @State glowOpacity: number = 0;
  @State starScale: number = 0;

  // === ğŸ›ï¸ å¼¹çª—çŠ¶æ€æ§åˆ¶ (ä¸å†ä¾èµ– bindSheet) ===
  @State isGallerySheetOpen: boolean = false;
  @State isEnergySheetOpen: boolean = false;
  @State isShareSheetOpen: boolean = false;

  // === æ•°æ® ===
  @State galleryList: CardRecord[] = [];
  @State collectionProgress: number = 0;
  @State isPosterReady: boolean = false;
  @State shareTheme: string = 'soft';
  @State stickers: string[] = [];
  @State todayDate: string = "";
  @State todayWeek: string = "";

  // === P0ï¼šæƒ…ç»ªä¸ä»»åŠ¡ ===
  @State moodIndex: number = -1;
  @State moodNote: string = '';
  @State goldQuote: string = '';
  @State dailyTask: string = '';

  // === P2/P4ï¼šå‘¼å¸ä¸ç§å¯† ===
  @State isBreathingSheetOpen: boolean = false;
  @State breathingPhase: string = 'å‡†å¤‡';
  @State breathingRemaining: number = 60;
  @State privacyMode: boolean = false;

  // === âš¡ èƒ½é‡æ˜¾ç¤ºä¸å……å€¼ ===
  @State currentEnergy: number = 0;

  private manager = FortuneManager.getInstance();
  private energyManager = EnergyManager.getInstance();
  private context = getContext(this) as common.UIAbilityContext;
  private POSTER_ID = 'poster_component_id';
  private breathingTimerId: number | null = null;

  private asyncAnimateTo(duration: number, curve: Curve | string | ICurve, updateFn: () => void): Promise<void> {
    return new Promise((resolve) => {
      animateTo({ duration: duration, curve: curve, onFinish: resolve }, updateFn);
    });
  }

  async aboutToAppear() {
    await this.manager.init(this.context);
    await this.energyManager.init(this.context);
    this.refreshEnergy();

    this.checkState();
    this.initDate();
    this.startGuideAnimation();
    const mood = await this.manager.getTodayMood();
    this.moodIndex = mood.mood;
    this.moodNote = mood.note;
    const aff = await this.manager.getTodayAffirmations();
    this.goldQuote = aff.quote;
    this.dailyTask = aff.task;
    this.privacyMode = await this.manager.isPrivacyMode();
  }

  onPageShow() {
    this.refreshEnergy();
  }

  refreshEnergy() {
    this.currentEnergy = this.energyManager.getEnergy();
  }

  initDate() {
    const now = new Date();
    this.todayDate = `${now.getFullYear()}.${(now.getMonth() + 1).toString().padStart(2, '0')}.${now.getDate().toString().padStart(2, '0')}`;
    const weeks = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    this.todayWeek = weeks[now.getDay()];
  }

  async checkState() {
    this.isVip = await this.manager.isVip();
    const savedCard = await this.manager.checkTodayCard();
    if (savedCard) {
      this.currentCard = savedCard;
      this.angle = 180;
      this.isFlipped = true;
      this.showResultText = true;
      this.startBreathingAnimation();
      this.rarityColor = 'rgba(255, 182, 193, 0.5)';
      this.shadowColor = this.rarityColor;
      this.shadowRadius = 20;
      this.updateForm(savedCard);
    } else {
      this.resetUI();
    }
  }

  resetUI() {
    this.currentCard = null;
    this.angle = 0;
    this.isFlipped = false;
    this.showResultText = false;
    this.rarityColor = 'rgba(0,0,0,0.15)';
    this.stopBreathingAnimation();
    this.mainReset();
  }

  mainReset() {
    this.shuffleOffsetX = 0;
    this.shuffleRotate = 0;
    this.shuffleScale = 1;
  }

  updateForm(card: TarotCard) {
    try {
      const formData = formBindingData.createFormBindingData({
        'cardImage': card.image,
        'cardName': card.name,
        'cardDesc': card.meaning,
        'goldQuote': this.goldQuote,
        'dailyTask': this.dailyTask,
        'moodNote': this.moodNote,
        'privacyMode': this.privacyMode
      });
      void (async () => {
        const ids = await this.manager.getFormIds();
        for (const id of ids) {
          try { await formProvider.updateForm(id, formData); } catch (e) { const _err = e as Error | object; }
        }
      })();
    } catch (err) {
      console.error('Form Update Error');
    }
  }

  handleManualReset() {
    this.resetUI();
    promptAction.showToast({ message: 'ğŸ”„ å·²é‡ç½®', duration: 1000 });
  }

  // === å……å€¼ç›¸å…³ ===
  handleBuyVip() {
    animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
      this.isEnergySheetOpen = true;
    });
  }

  async handleRecharge(amount: number) {
    await this.energyManager.recharge(amount);
    this.refreshEnergy();
    promptAction.showToast({ message: `âš¡ æˆåŠŸè¡¥å…… ${amount} ç‚¹å¿ƒåŠ›ï¼` });
    animateTo({ duration: 300 }, () => {
      this.isEnergySheetOpen = false;
    });
  }

  // === ğŸŒˆ çç¨€åº¦è®¡ç®—é€»è¾‘ ===
  calculateRarity() {
    const rand = Math.random() * 100;
    if (rand < 0.1) { this.rarityLevel = 7; this.rarityColor = 'rgba(255, 215, 0, 0.9)'; }
    else if (rand < 1.1) { this.rarityLevel = 6; this.rarityColor = 'rgba(255, 69, 0, 0.8)'; }
    else if (rand < 6.1) { this.rarityLevel = 5; this.rarityColor = 'rgba(138, 43, 226, 0.7)'; }
    else if (rand < 16.1) { this.rarityLevel = 4; this.rarityColor = 'rgba(30, 144, 255, 0.7)'; }
    else if (rand < 36.1) { this.rarityLevel = 3; this.rarityColor = 'rgba(60, 179, 113, 0.6)'; }
    else { this.rarityLevel = 1; this.rarityColor = 'rgba(200, 200, 200, 0.5)'; }
  }

  getFlipDurationByRarity(): number {
    const map = [800, 900, 1000, 1200, 1500, 1800, 2000];
    const idx = Math.min(Math.max(this.rarityLevel, 1), 7) - 1;
    return map[idx];
  }

  getGlowRadiusByRarity(): number {
    const map = [15, 18, 20, 25, 30, 35, 40];
    const idx = Math.min(Math.max(this.rarityLevel, 1), 7) - 1;
    return map[idx];
  }

  // === åŠ¨ç”»ç»„ ===
  startGuideAnimation() { animateTo({ duration: 1500, curve: Curve.EaseInOut, iterations: -1, playMode: PlayMode.Alternate }, () => { this.guideOpacity = 0.3; }); }

  startMysteryAnimation() {
    animateTo({ duration: 2000, curve: Curve.EaseInOut, iterations: -1, playMode: PlayMode.Alternate }, () => {
      this.mysteryScale = 1.05;
      this.shadowRadius = 20;
      this.shadowColor = 'rgba(100,0,200,0.3)';
    });
  }
  stopMysteryAnimation() { animateTo({ duration: 300 }, () => { this.mysteryScale = 1; this.shadowRadius = 10; this.shadowColor = 'rgba(0,0,0,0.15)'; }); }

  startBreathingAnimation() {
    animateTo({ duration: 2500, curve: Curve.EaseInOut, iterations: -1, playMode: PlayMode.Alternate }, () => { this.floatOffsetY = -12; });
    animateTo({ duration: 3500, curve: Curve.Smooth, iterations: -1, playMode: PlayMode.Alternate }, () => { this.floatRotateZ = 1.5; });
  }
  stopBreathingAnimation() { animateTo({ duration: 0 }, () => { this.floatOffsetY = 0; this.floatRotateZ = 0; }); }

  handleClickFeedback() { animateTo({ duration: 100, curve: Curve.EaseOut }, () => { this.clickScale = 0.95; }); setTimeout(() => { animateTo({ duration: 400, curve: curves.springMotion(0.5, 0.6) }, () => { this.clickScale = 1; }); }, 100); }

  // === ğŸƒ æ ¸å¿ƒæŠ½å¡é€»è¾‘ ===
  async handleDrawCard() {
    if (this.isFlipped) {
      if (this.currentCard) {
        promptAction.showToast({ message: 'ğŸ“… æ¯å¤©åªèƒ½æŠ½å–ä¸€æ¬¡å“¦', duration: 2000 });
        this.handleClickFeedback();
        return;
      }
    }

    this.guideOpacity = 0;
    this.stopMysteryAnimation();

    await this.asyncAnimateTo(300, Curve.EaseOut, () => {
      this.mainScale = 0.9;
      this.shadowRadius = 5;
      this.shadowOffsetY = 2;
      this.deckOpacity = 1;
      this.deckOffset1 = -40;
      this.deckOffset2 = 40;
    });

    for (let i = 0; i < 3; i++) {
      const dir = i % 2 === 0 ? 1 : -1;
      await this.asyncAnimateTo(150, Curve.Sharp, () => {
        this.shuffleOffsetX = 60 * dir;
        this.shuffleRotate = 6 * dir;
        this.deckOffset1 = -60 * dir;
        this.deckOffset2 = -20 * dir;
      });
      await this.asyncAnimateTo(150, Curve.Sharp, () => {
        this.shuffleOffsetX = 0;
        this.shuffleRotate = 0;
        this.deckOffset1 = -40;
        this.deckOffset2 = 40;
      });
    }

    this.currentCard = await this.manager.drawDailyCard();
    this.calculateRarity();

    if (this.currentCard) {
      await this.manager.saveDrawResult(this.currentCard, this.rarityColor);
    }

    await this.asyncAnimateTo(500, curves.springMotion(0.6, 0.7), () => {
      this.mainScale = 1.05;
      this.floatOffsetY = 0;
      this.shuffleOffsetX = 0;
      this.shuffleRotate = 0;
      this.shadowColor = 'rgba(0,0,0,0.15)';
      this.deckOpacity = 0;
      this.deckOffset1 = -300;
      this.deckOffset2 = 300;
    });

    const flipDuration = this.getFlipDurationByRarity();

    if (this.rarityLevel >= 5) {
      setTimeout(() => {
        this.glowScale = 0.8;
        this.glowOpacity = 1;
        animateTo({ duration: 800, curve: Curve.EaseOut }, () => {
          this.glowScale = 2.5;
          this.glowOpacity = 0;
        });
        this.starScale = 0;
        animateTo({ duration: 600, curve: curves.springMotion(0.6, 0.8) }, () => {
          this.starScale = 1.2;
        });
      }, flipDuration / 3);
    }

    await this.asyncAnimateTo(flipDuration, curves.springMotion(0.6, 0.8), () => {
      this.angle = 180;
      this.mainScale = 1.0;
      this.floatOffsetY = 0;
      this.shadowRadius = 20;
      this.shadowOffsetY = 10;
    });

    await this.asyncAnimateTo(500, Curve.EaseOut, () => {
      this.shadowColor = this.rarityColor;
      this.shadowRadius = this.getGlowRadiusByRarity();
      this.shadowOffsetY = 0;
    });

    this.isFlipped = true;
    this.startBreathingAnimation();

    if (this.currentCard) {
      this.goldQuote = this.manager.createGoldQuote(this.currentCard);
      this.dailyTask = this.manager.createDailyTask(this.currentCard);
      await this.manager.setTodayAffirmations(this.goldQuote, this.dailyTask);
      this.updateForm(this.currentCard);
    }

    animateTo({ duration: 600 }, () => { this.showResultText = true; });
  }

  handleShare() {
    if (!this.currentCard) return;
    this.isShareSheetOpen = false;
    this.isGallerySheetOpen = false;
    this.isPosterReady = false;
    animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
      this.isShareSheetOpen = true;
    });
    setTimeout(() => { this.isPosterReady = true; }, 140);
  }

  async handleSystemShare() {
    try {
      promptAction.showToast({ message: 'æ­£åœ¨ç”Ÿæˆ...', duration: 1000 });
      await ShareHelper.snapshotAndShare(this.context, this.POSTER_ID);
    } catch (err) {
      promptAction.showToast({ message: 'åˆ†äº«å¤±è´¥ï¼Œè¯·é‡è¯•', duration: 2000 });
    }
  }

  async executeSave() {
    try {
      const ok = await this.ensureAlbumPermissions();
      if (!ok) { promptAction.showToast({ message: 'éœ€è¦ç›¸å†Œæƒé™', duration: 2500 }); return; }
      const pixelMap = await componentSnapshot.get(this.POSTER_ID);
      await ImageSaver.saveToAlbum(this.context, pixelMap);
      this.isShareSheetOpen = false;
    } catch (err) { promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥', duration: 2000 }); }
  }

  async ensureAlbumPermissions(): Promise<boolean> {
    try {
      const atManager = abilityAccessCtrl.createAtManager();
      const result = await atManager.requestPermissionsFromUser(this.context, ['ohos.permission.READ_IMAGEVIDEO', 'ohos.permission.WRITE_IMAGEVIDEO']);
      return Array.isArray(result.authResults) ? result.authResults.every(v => v === 0) : true;
    } catch { return false; }
  }

  async setMood(index: number) {
    this.moodIndex = index;
    await this.manager.setTodayMood(index, this.moodNote);
    promptAction.showToast({ message: 'âœ¨ å¿ƒæƒ…å·²è®°å½•', duration: 1200 });
  }

  togglePrivacyMode() {
    this.privacyMode = !this.privacyMode;
    this.manager.setPrivacyMode(this.privacyMode);
    promptAction.showToast({ message: this.privacyMode ? 'ğŸ”’ ç§å¯†æ¨¡å¼å·²å¼€å¯' : 'ğŸ”“ ç§å¯†æ¨¡å¼å·²å…³é—­' });
  }
  openBreathingGuide() { this.isBreathingSheetOpen = true; }

  async loadGalleryData() {
    // å…³é—­å…¶ä»–çª—å£
    this.isShareSheetOpen = false;
    this.isEnergySheetOpen = false;

    // åŠ è½½æ•°æ®
    this.galleryList = await this.manager.getGallery();
    this.collectionProgress = Math.round((this.galleryList.length / TAROT_DECK.length) * 100);

    // å¼€å¯å±•è§ˆå… (æ‰‹åŠ¨æ§åˆ¶)
    animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
      this.isGallerySheetOpen = true;
    });
  }
  isCollected(id: number): boolean { return this.galleryList.some(record => record.cardId === id); }

  getCardRarityColor(id: number): string {
    const record = this.galleryList.find(r => r.cardId === id);
    return record ? record.rarityColor : 'rgba(0,0,0,0.1)';
  }

  getThemePrimaryTextColor(): string { return this.shareTheme === 'star' ? '#EEEEEE' : '#333333'; }
  getThemeSecondaryTextColor(): string { return this.shareTheme === 'star' ? '#BBBBBB' : '#888888'; }

  // === ğŸ¨ æ‰‹åŠ¨æ„å»ºçš„å¼¹çª—å†…å®¹ ===
  @Builder GallerySheetBuilder() {
    Column() {
      Row() {
        Column() {
          Text("æ²»æ„ˆå±•è§ˆå…").fontSize(24).fontWeight(FontWeight.Bold).fontColor('#333333')
          Text(`å·²æ”¶é›† ${this.galleryList.length} / ${TAROT_DECK.length} å¼ `).fontSize(13).fontColor('#888888').margin({ top: 4 })
        }.alignItems(HorizontalAlign.Start)
        Blank()
        Stack() {
          Progress({ value: this.collectionProgress, total: 100, type: ProgressType.Ring }).color('#FF69B4').width(44)
          Text(`${this.collectionProgress}%`).fontSize(10).fontColor('#FF69B4').fontWeight(FontWeight.Bold)
        }.margin({ right: 32 })
      }.width('100%').padding({ left: 24, right: 24, top: 24, bottom: 10 })
      Divider().color('#F9F9F9').width('90%')
      Grid() {
        ForEach(TAROT_DECK, (card: TarotCard) => {
          GridItem() {
            Column() {
              if (this.isCollected(card.id)) {
                Stack() {
                  Image($rawfile(card.image)).width('100%').aspectRatio(2/3).borderRadius(10)
                    .shadow({ radius: 8, color: this.getCardRarityColor(card.id), offsetY: 2 })
                }
                Text(card.name).fontSize(12).fontColor('#333').fontWeight(FontWeight.Medium).margin({ top: 8 })
              } else {
                Stack() {
                  Rect().width('100%').height('100%').fill('#F7F8FA').borderRadius(10).strokeWidth(1).stroke('#F0F0F0')
                  Column({space: 4}) { Text("ğŸ”’").fontSize(18).fontColor('#DDD'); Text("???").fontSize(10).fontColor('#EEE') }
                }.width('100%').aspectRatio(2/3)
                Text("å¾…è§£é”").fontSize(12).fontColor('#EEE').margin({ top: 8 })
              }
            }
          }
        })
      }.columnsTemplate('1fr 1fr 1fr').columnsGap(12).rowsGap(20).padding({ left: 20, right: 20, top: 20, bottom: 80 }).layoutWeight(1)
    }
    .width('100%')
    .height('85%') // æ¨¡æ‹Ÿ SheetSize.LARGE
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 24, topRight: 24 })
  }

  @Builder EnergySheetBuilder() {
    Column() {
      Row().width(40).height(5).backgroundColor('#E0E0E0').borderRadius(10).margin({ top: 10, bottom: 20 })
      Text("âš¡ å¿ƒåŠ›åŠ æ²¹ç«™").fontSize(20).fontWeight(FontWeight.Bold).fontColor('#333').margin({ bottom: 8 })
      Text(`å½“å‰å‰©ä½™: ${this.currentEnergy}`).fontSize(14).fontColor('#999').margin({ bottom: 30 })

      Row() {
        Column() { Text("æ¯æ—¥è¡¥ç»™").fontSize(16).fontWeight(FontWeight.Bold); Text("æ¯å¤© 00:00 è‡ªåŠ¨æ¢å¤è‡³ 20 ç‚¹").fontSize(12).fontColor('#999').margin({ top: 4 }) }.alignItems(HorizontalAlign.Start)
        Blank()
        Button("å·²é¢†å–").backgroundColor('#F5F5F5').fontColor('#BBB').height(32).fontSize(12).enabled(false)
      }.width('90%').padding(16).backgroundColor('#FAFAFA').borderRadius(16).margin({ bottom: 12 })

      Row() {
        Column() { Text("è§‚çœ‹å¹¿å‘Š").fontSize(16).fontWeight(FontWeight.Bold); Text("ç«‹å³è·å¾— +10 å¿ƒåŠ›").fontSize(12).fontColor('#999').margin({ top: 4 }) }.alignItems(HorizontalAlign.Start)
        Blank()
        Button("å»è§‚çœ‹").backgroundColor('#E0F7FA').fontColor('#006064').height(32).fontSize(12).onClick(() => this.handleRecharge(10))
      }.width('90%').padding(16).backgroundColor('#FAFAFA').borderRadius(16).margin({ bottom: 12 })

      Row() {
        Column() { Text("å¿ƒåŠ›ç¤¼åŒ…").fontSize(16).fontWeight(FontWeight.Bold); Text("è·å¾— +100 å¿ƒåŠ›").fontSize(12).fontColor('#999').margin({ top: 4 }) }.alignItems(HorizontalAlign.Start)
        Blank()
        Button("Â¥ 6.00").backgroundColor('#FFF0F5').fontColor('#FF69B4').height(32).fontSize(12).onClick(() => this.handleRecharge(100))
      }.width('90%').padding(16).backgroundColor('#FAFAFA').borderRadius(16)
    }
    .width('100%')
    .height('50%') // æ¨¡æ‹Ÿ SheetSize.MEDIUM
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 24, topRight: 24 })
  }

  @Builder ShareSheetBuilder() {
    if (!this.currentCard) {
      Column().height(100)
    } else {
      Column() {
        Row({ space: 8 }) {
          Button('è½»æŸ”').onClick(() => { this.shareTheme = 'soft'; }).backgroundColor(this.shareTheme === 'soft' ? '#333' : '#EEE').fontColor(this.shareTheme === 'soft' ? '#FFF' : '#000').height(32).fontSize(12)
          Button('æç®€').onClick(() => { this.shareTheme = 'minimal'; }).backgroundColor(this.shareTheme === 'minimal' ? '#333' : '#EEE').fontColor(this.shareTheme === 'minimal' ? '#FFF' : '#000').height(32).fontSize(12)
          Button('æ˜Ÿç©º').onClick(() => { this.shareTheme = 'star'; }).backgroundColor(this.shareTheme === 'star' ? '#333' : '#EEE').fontColor(this.shareTheme === 'star' ? '#FFF' : '#000').height(32).fontSize(12)
        }.margin({ top: 15, bottom: 15 })

        Column() {
          Row() {
            Column() {
              Text(this.todayDate).fontSize(18).fontWeight(FontWeight.Bold).fontColor(this.getThemePrimaryTextColor())
              Text(this.todayWeek).fontSize(12).fontColor(this.getThemeSecondaryTextColor())
            }.alignItems(HorizontalAlign.Start)
            Blank()
            Text("æ²»æ„ˆä¹‹ä¹¦").fontSize(14).fontColor('#FF69B4').fontWeight(FontWeight.Medium)
          }.width('100%').padding({ left: 16, right: 16, top: 16 })

          Image($rawfile(this.currentCard.image))
            .width('100%').aspectRatio(2/3).borderRadius(12).margin({ top: 12 })
            .shadow({ radius: 10, color: 'rgba(0,0,0,0.1)', offsetY: 5 })

          Column() {
            Text(this.currentCard.name).fontSize(20).fontWeight(FontWeight.Bold).fontColor(this.getThemePrimaryTextColor()).margin({ top: 16 })
            Text(this.currentCard.meaning).fontSize(14).fontColor(this.getThemeSecondaryTextColor()).margin({ top: 4, bottom: 12 })

            if (!this.privacyMode) {
              Text(this.currentCard.desc).fontSize(14).fontColor(this.getThemePrimaryTextColor()).opacity(0.8).textAlign(TextAlign.Center).lineHeight(20)
              if (this.goldQuote) {
                Text(`â€œ ${this.goldQuote} â€`).fontSize(13).fontColor('#FF69B4').fontStyle(FontStyle.Italic).margin({ top: 12 })
              }
            } else {
              Text("ğŸ”’ ç§å¯†æ¨¡å¼").fontSize(12).fontColor(this.getThemeSecondaryTextColor()).margin({ top: 10 })
            }
          }.padding(16)

          Row() {
            Text("æ‰«ç è·å–ä½ çš„æ²»æ„ˆå¡ç‰‡").fontSize(10).fontColor(this.getThemeSecondaryTextColor())
            Blank()
            Image($rawfile('qr_code.png')).width(40).height(40).opacity(0.8)
          }.width('100%').padding({ left: 16, right: 16, bottom: 16 })

        }
        .width('88%')
        .backgroundColor(this.shareTheme === 'soft' ? Color.White : (this.shareTheme === 'minimal' ? '#F7F7F7' : '#1A1A2E'))
        .borderRadius(16)
        .shadow({ radius: 20, color: 'rgba(0,0,0,0.1)', offsetY: 10 })
        .id(this.POSTER_ID)
      }
      .width('100%')
    }
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Scroll() {
        Column() {
          // Top Bar
          Row() {
            if (this.isFlipped) {
              Button({ type: ButtonType.Circle }) { Text('â†º').fontSize(18).fontColor('#666666') }
              .width(40).height(40).backgroundColor(Color.White).shadow({ radius: 8, color: 'rgba(0,0,0,0.05)' })
              .onClick(() => this.handleManualReset())
            } else {
              Text("DAILY TAROT").fontSize(12).fontWeight(FontWeight.Bold).fontColor('#CCCCCC').letterSpacing(2)
            }
            Blank()
            // å¿ƒåŠ›å€¼å…¥å£
            Row() {
              Text('âš¡').fontSize(14)
              Text(`${this.currentEnergy}`).fontSize(14).fontColor('#FF69B4').fontWeight(FontWeight.Bold).margin({left: 2})
            }.backgroundColor('rgba(255,255,255,0.6)').padding({left: 10, right: 10, top: 6, bottom: 6}).borderRadius(14).margin({right: 12}).onClick(() => this.handleBuyVip())

            // å±•è§ˆå…å…¥å£
            Button({ type: ButtonType.Circle }) { Text('ğŸ›ï¸').fontSize(18) }
            .width(40).height(40).backgroundColor(Color.White).shadow({ radius: 8, color: 'rgba(0,0,0,0.05)' })
            .onClick(() => this.loadGalleryData())
          }.width('100%').padding({ left: 24, right: 24, top: 16 }).height(60)

          Blank().height(20)

          // === 3D å¡ç‰Œä¸ç‰¹æ•ˆå®¹å™¨ ===
          Stack() {
            // 1. åº•å±‚å…‰æ™•
            Circle({ width: 260, height: 260 }).fill('#FFFFFF').opacity(0.5)
              .scale({ x: this.mysteryScale, y: this.mysteryScale }).blur(40)

            // 2. SSR çˆ†å‘å…‰ç¯
            if (this.rarityLevel >= 5) {
              Circle({ width: 200, height: 200 })
                .fill(this.rarityColor)
                .scale({ x: this.glowScale, y: this.glowScale })
                .opacity(this.glowOpacity)
                .blur(20)
            }

            // 3. è£…é¥°æ€§ç‰Œå †
            Image($rawfile('card_back.png')).width('100%').height('100%').borderRadius(16)
              .scale({ x: this.deckScale, y: this.deckScale }).translate({ x: this.deckOffset1 }).rotate({ z: 1, angle: this.deckAngle1 }).opacity(this.deckOpacity)
            Image($rawfile('card_back.png')).width('100%').height('100%').borderRadius(16)
              .scale({ x: this.deckScale, y: this.deckScale }).translate({ x: this.deckOffset2 }).rotate({ z: 1, angle: this.deckAngle2 }).opacity(this.deckOpacity)

            // 4. ä¸»å¡ç‰Œ (èƒŒé¢)
            Image($rawfile('card_back.png')).width('100%').height('100%').borderRadius(16)
              .rotate({ x: 0, y: 1, z: 0, angle: this.angle }).opacity(this.angle < 90 ? 1 : 0)

            // 5. ä¸»å¡ç‰Œ (æ­£é¢)
            if (this.currentCard) {
              Image($rawfile(this.currentCard.image))
                .width('100%').height('100%').borderRadius(16)
                .rotate({ x: 0, y: 1, z: 0, angle: this.angle - 180 }).opacity(this.angle >= 90 ? 1 : 0)
            }

            // 6. SSR å‰æ™¯æ˜Ÿæ˜Ÿ
            if (this.currentCard && this.rarityLevel >= 6 && this.isFlipped) {
              Text("âœ¨").fontSize(40).position({x: -20, y: -20})
                .scale({x: this.starScale, y: this.starScale})
                .rotate({angle: -15})
                .animation({duration: 1000, iterations: -1, playMode: PlayMode.Alternate})
              Text("âœ¨").fontSize(30).position({x: '85%', y: '85%'})
                .scale({x: this.starScale, y: this.starScale})
                .rotate({angle: 15})
                .animation({duration: 1200, iterations: -1, playMode: PlayMode.Alternate, delay: 200})
            }
          }
          .width('70%').aspectRatio(2/3).margin({ top: 20, bottom: 30 })
          .rotate({ z: 1, angle: this.mainRotateZ + this.shuffleRotate })
          .translate({ x: this.shuffleOffsetX, y: this.floatOffsetY + this.mainOffsetY })
          .scale({ x: this.shuffleScale * this.clickScale, y: this.shuffleScale * this.clickScale })
          .shadow({ radius: this.shadowRadius, color: this.shadowColor, offsetY: this.shadowOffsetY })
          .onClick(() => { this.handleDrawCard(); })

          // ç»“æœä¸æŒ‰é’®
          if (this.showResultText && this.currentCard) {
            Column() {
              Text(this.currentCard.name).fontSize(24).fontWeight(FontWeight.Bold).fontColor('#333333').margin({bottom: 4})
              Text(this.currentCard.name_en).fontSize(14).fontColor('#AAAAAA').fontStyle(FontStyle.Italic).margin({bottom: 16})
              Text(this.currentCard.desc).fontSize(16).fontColor('#555555').textAlign(TextAlign.Center).lineHeight(26).padding({ left: 20, right: 20 }).opacity(0.9)
              Divider().color('#F0F0F0').width('80%').margin({top: 24, bottom: 24})
              Row({ space: 12 }) {
                Button("âœ¨ åˆ†äº«").backgroundColor('#333333').fontColor(Color.White).height(44).layoutWeight(1).borderRadius(22).onClick(() => this.handleShare())
                Button("ğŸ”® ä¸‰ç‰Œé˜µ").backgroundColor('#E0F7FA').fontColor('#006064').height(44).layoutWeight(1).borderRadius(22).onClick(() => router.pushUrl({ url: 'pages/SpreadPage' }))
              }.width('90%').margin({ bottom: 12 })
              // å……å€¼å…¥å£
              Button("âš¡ è¡¥å……å¿ƒåŠ›").backgroundColor('#FFF0F5').fontColor('#FF69B4').height(44).width('90%').borderRadius(22).onClick(() => this.handleBuyVip())
            }
            .width('92%').backgroundColor('rgba(255,255,255,0.8)').backdropBlur(10).borderRadius(24).padding({ top: 30, bottom: 20 })
            .shadow({ radius: 20, color: 'rgba(0,0,0,0.04)', offsetY: 5 })
            .transition({ type: TransitionType.Insert, opacity: 0, translate: { y: 20 } })
          } else {
            Text("ç‚¹å‡»å¡ç‰Œï¼Œå¼€å¯ä»Šæ—¥æŒ‡å¼•").fontSize(14).fontColor('#AAAAAA').letterSpacing(1).opacity(this.guideOpacity).margin({ top: 20 })
          }
          Blank().height(120)
        }.width('100%')
      }
      .width('100%').height('100%').scrollBar(BarState.Off)

      BottomNavBar({ current: 'index' })

      // ğŸš€ æ‰‹å†™å¼¹çª—é€»è¾‘ï¼šå±•è§ˆå…
      if (this.isGallerySheetOpen) {
        Column() {
          // é®ç½©å±‚
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.4)')
            .onClick(() => {
              animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
                this.isGallerySheetOpen = false;
              });
            })
            // ğŸŸ¢ ä¿®å¤ï¼šå»æ‰ type: TransitionType.Opacityï¼Œç›´æ¥å†™ opacity: 0
            .transition({ opacity: 0 })
            .zIndex(100)

          // å¼¹çª—å†…å®¹å±‚
          Column() {
            this.GallerySheetBuilder()
          }
          .width('100%')
          .transition({ type: TransitionType.Insert, translate: { y: '100%' } })
          .zIndex(101)
          .position({ y: '15%' }) // æ¨¡æ‹Ÿ SheetSize.LARGE æ•ˆæœ
          .constraintSize({ maxWidth: 480 }) // é€‚é…å¤§å±
        }
        .width('100%')
        .height('100%')
        .zIndex(200)
      }

      // ğŸš€ æ‰‹å†™å¼¹çª—é€»è¾‘ï¼šèƒ½é‡å……å€¼
      if (this.isEnergySheetOpen) {
        Column() {
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.4)')
            .onClick(() => {
              animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
                this.isEnergySheetOpen = false;
              });
            })
            // ğŸŸ¢ ä¿®å¤ï¼šå»æ‰ type: TransitionType.Opacity
            .transition({ opacity: 0 })
            .zIndex(100)

          Column() {
            this.EnergySheetBuilder()
          }
          .width('100%')
          .transition({ type: TransitionType.Insert, translate: { y: '100%' } })
          .zIndex(101)
          .position({ y: '50%' }) // æ¨¡æ‹Ÿ SheetSize.MEDIUM æ•ˆæœ
          .constraintSize({ maxWidth: 480 }) // é€‚é…å¤§å±
        }
        .width('100%')
        .height('100%')
        .zIndex(200)
      }

      // ğŸš€ æ‰‹å†™å¼¹çª—é€»è¾‘ï¼šåˆ†äº«
      if (this.isShareSheetOpen) {
        Column() {
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.4)')
            .onClick(() => {
              animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
                this.isShareSheetOpen = false;
              });
            })
            // ğŸŸ¢ ä¿®å¤ï¼šå»æ‰ type: TransitionType.Opacity
            .transition({ opacity: 0 })
            .zIndex(100)

          Column() {
            this.ShareSheetBuilder()
            Row({ space: 16 }) {
              Button('ä¿å­˜ç›¸å†Œ').backgroundColor('#F5F5F5').fontColor('#333').layoutWeight(1).height(48).borderRadius(24).onClick(() => this.executeSave())
              Button('å‘é€ç»™å¥½å‹').backgroundColor('#333').fontColor('#FFF').layoutWeight(1).height(48).borderRadius(24).onClick(() => this.handleSystemShare())
            }.width('90%').margin({ top: 20, bottom: 30 })
          }
          .width('100%')
          .backgroundColor(Color.White)
          .borderRadius({ topLeft: 24, topRight: 24 })
          .transition({ type: TransitionType.Insert, translate: { y: '100%' } })
          .zIndex(101)
          .position({ y: '30%' }) // è‡ªå®šä¹‰é«˜åº¦
          .constraintSize({ maxWidth: 480 }) // é€‚é…å¤§å±
        }
        .width('100%')
        .height('100%')
        .zIndex(200)
      }
    }
    .width('100%').height('100%')
    .linearGradient({ direction: GradientDirection.Top, colors: [['#FDFBFB', 0.0], ['#F2F4F8', 1.0]] })
  }
}