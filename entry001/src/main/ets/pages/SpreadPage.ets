import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import { FortuneManager } from '../common/FortuneManager';
import { TarotCard } from '../model/TarotData';
import curves from '@ohos.curves';
import promptAction from '@ohos.promptAction';
import { AIService } from '../common/AIService';
import { EnergyManager } from '../common/EnergyManager';
import { BottomNavBar } from '../common/BottomNavBar';

// ğŸŒŸ ç‰Œé˜µå®šä¹‰æ¥å£
interface SpreadPosition {
  x: number;
  y: number;
  rotate: number;
  label: string;
  zIndex: number;
}

interface SpreadDef {
  id: string;
  name: string;
  description: string;
  cardCount: number;
  positions: SpreadPosition[];
}

// ğŸŒŸ é¢„è®¾ç‰Œé˜µæ•°æ®
const SPREADS: SpreadDef[] = [
  {
    id: 'celtic_cross',
    name: 'å‡¯å°”ç‰¹åå­—',
    description: 'æœ€ç»å…¸çš„å¡”ç½—ç‰Œé˜µï¼Œå…¨æ–¹ä½è§£æç°çŠ¶ã€é˜»ç¢ã€æ½œæ„è¯†ã€è¿‡å»ã€æœªæ¥åŠæœ€ç»ˆç»“æœã€‚é€‚ç”¨äºé‡å¤§å†³ç­–ä¸æ·±åº¦è‡ªæˆ‘æ¢ç´¢ã€‚',
    cardCount: 10,
    positions: [
      { x: -60, y: 0, rotate: 0, label: '1. æ ¸å¿ƒç°çŠ¶', zIndex: 1 },
      { x: -60, y: 0, rotate: 90, label: '2. é˜»ç¢/æŒ‘æˆ˜', zIndex: 2 },
      { x: -60, y: 110, rotate: 0, label: '3. æ½œæ„è¯†/åŸºç¡€', zIndex: 1 },
      { x: -150, y: 0, rotate: 0, label: '4. è¿‡å»çš„å½±å“', zIndex: 1 },
      { x: -60, y: -110, rotate: 0, label: '5. æœ€é«˜æ„¿æ™¯', zIndex: 1 },
      { x: 30, y: 0, rotate: 0, label: '6. å³å°†å‘ç”Ÿçš„æœªæ¥', zIndex: 1 },
      { x: 120, y: 120, rotate: 0, label: '7. è‡ªæˆ‘æ€åº¦', zIndex: 1 },
      { x: 120, y: 40, rotate: 0, label: '8. ç¯å¢ƒå½±å“', zIndex: 1 },
      { x: 120, y: -40, rotate: 0, label: '9. å¸Œæœ›ä¸ææƒ§', zIndex: 1 },
      { x: 120, y: -120, rotate: 0, label: '10. æœ€ç»ˆç»“æœ', zIndex: 1 }
    ]
  },
  {
    id: 'tree_of_life',
    name: 'ç”Ÿå‘½ä¹‹æ ‘',
    description: 'åŸºäºå¡å·´æ‹‰ç”Ÿå‘½ä¹‹æ ‘çš„æ·±åº¦çµæ€§ç‰Œé˜µï¼Œæ¢ç´¢èº«å¿ƒçµçš„æ•´ä½“çŠ¶æ€ä¸æˆé•¿è·¯å¾„ã€‚',
    cardCount: 10,
    positions: [
      { x: 0, y: -140, rotate: 0, label: '1. ç²¾ç¥æºå¤´', zIndex: 1 },
      { x: 60, y: -110, rotate: 0, label: '2. æ™ºæ…§/é˜³æ€§', zIndex: 1 },
      { x: -60, y: -110, rotate: 0, label: '3. ç†è§£/é˜´æ€§', zIndex: 1 },
      { x: 60, y: -50, rotate: 0, label: '4. æ…ˆæ‚²', zIndex: 1 },
      { x: -60, y: -50, rotate: 0, label: '5. åŠ›é‡', zIndex: 1 },
      { x: 0, y: 0, rotate: 0, label: '6. ç¾/æ ¸å¿ƒ', zIndex: 1 },
      { x: 60, y: 50, rotate: 0, label: '7. èƒœåˆ©', zIndex: 1 },
      { x: -60, y: 50, rotate: 0, label: '8. è£è€€', zIndex: 1 },
      { x: 0, y: 100, rotate: 0, label: '9. åŸºç¡€', zIndex: 1 },
      { x: 0, y: 150, rotate: 0, label: '10. ç‹å›½/ç°å®', zIndex: 1 }
    ]
  }
];

@Entry
@Component
struct SpreadPage {
  // === çŠ¶æ€å˜é‡ ===
  @State selectedSpreadId: string = '';
  @State currentSpread: SpreadDef | null = null;
  @State cards: TarotCard[] = [];
  @State isDrawing: boolean = false; // æ˜¯å¦æ­£åœ¨æŠ½ç‰Œè¿‡ç¨‹ä¸­ï¼ˆUIçŠ¶æ€ï¼‰
  @State drawnCount: number = 0; // å·²æŠ½å–çš„æ•°é‡

  // åŠ¨ç”»ç›¸å…³
  @State cardOpacities: number[] = []; // æ§åˆ¶æ¯å¼ ç‰Œçš„æ˜¾ç¤º
  @State cardScales: number[] = [];
  @State deckScale: number = 1.0;

  // èƒ½é‡ä¸æœåŠ¡
  @State currentEnergy: number = 0;
  @State isFreeAnalysis: boolean = false;

  private manager = FortuneManager.getInstance();
  private energyManager = EnergyManager.getInstance();
  private context = getContext(this) as common.UIAbilityContext;

  // æ™ºèƒ½å›¾ç‰‡æºå¤„ç†æ–¹æ³•
  getCardImageSource(url: string): ResourceStr {
    if (url.startsWith('http')) {
      return url;
    }
    return $rawfile(url);
  }

  async aboutToAppear() {
    await this.energyManager.init(this.context);
    this.currentEnergy = this.energyManager.getEnergy();
    this.isFreeAnalysis = await this.manager.isDailyDeepAnalysisFree();
  }

  onPageShow() {
    this.currentEnergy = this.energyManager.getEnergy();
  }

  // é€‰æ‹©ç‰Œé˜µ
  selectSpread(spread: SpreadDef) {
    this.currentSpread = spread;
    this.selectedSpreadId = spread.id;
    this.resetDrawingBoard();
  }

  // é‡ç½®æŠ½ç‰Œå°
  resetDrawingBoard() {
    if (!this.currentSpread) return;
    this.cards = [];
    this.drawnCount = 0;
    this.cardOpacities = new Array(this.currentSpread.cardCount).fill(0);
    this.cardScales = new Array(this.currentSpread.cardCount).fill(0.5);
    this.isDrawing = true;
  }

  // æŠ½å–ä¸‹ä¸€å¼ ç‰Œ
  async drawNextCard() {
    if (!this.currentSpread || this.drawnCount >= this.currentSpread.cardCount) return;

    // éœ‡åŠ¨åé¦ˆ
    // try { vibrator.startVibration({ type: 'time', duration: 50 }, { id: 0, usage: 'touch' }); } catch(e) {}

    // åŠ¨ç”»æ•ˆæœï¼šç‰Œå †ç‚¹å‡»
    animateTo({ duration: 100, curve: Curve.EaseOut }, () => {
      this.deckScale = 0.9;
    });
    setTimeout(() => {
      animateTo({ duration: 200, curve: curves.springMotion(0.6, 0.8) }, () => {
        this.deckScale = 1.0;
      });
    }, 100);

    // æŠ½ç‰Œé€»è¾‘
    const newCard = await this.manager.drawRandomCard();
    this.cards.push(newCard);
    const currentIndex = this.drawnCount;
    
    // åŠ¨ç”»ï¼šç‰Œé£å…¥ä½ç½®
    animateTo({ duration: 600, curve: curves.springMotion(0.6, 0.7) }, () => {
      this.cardOpacities[currentIndex] = 1;
      this.cardScales[currentIndex] = 1;
    });

    this.drawnCount++;
  }

  // å®ŒæˆæŠ½ç‰Œï¼Œå¼€å§‹åˆ†æ
  async handleAnalyze() {
    if (this.currentEnergy < AIService.COST_DEEP_ANALYSIS && !this.isFreeAnalysis) {
      promptAction.showToast({ message: 'å¿ƒåŠ›ä¸è¶³ï¼Œè¯·å…ˆè¡¥å……', duration: 2000 });
      return;
    }

    if (!this.currentSpread) return;

    // è·å–ä»Šæ—¥å¿ƒæƒ…ä½œä¸ºèƒŒæ™¯ä¿¡æ¯
    const todayMood = await this.manager.getTodayMood();

    // è·³è½¬åˆ°ç»“æœé¡µ
    router.pushUrl({
      url: 'pages/DeepAnalysisResultPage',
      params: {
        cards: this.cards,
        spreadType: this.currentSpread.id, // ä¼ é€’ç‰Œé˜µç±»å‹
        spreadName: this.currentSpread.name,
        isFree: this.isFreeAnalysis,
        todayMood: todayMood
      }
    });
  }

  // è¿”å›é€‰æ‹©é¡µ
  handleBack() {
    this.isDrawing = false;
    this.currentSpread = null;
    this.selectedSpreadId = '';
  }

  @Builder
  SpreadSelector() {
    Column() {
      Text('é€‰æ‹©æ·±åº¦è§£è¯»ç‰Œé˜µ')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
        .margin({ top: 40, bottom: 20 })

      List({ space: 20 }) {
        ForEach(SPREADS, (spread: SpreadDef) => {
          ListItem() {
            Column() {
              Text(spread.name)
                .fontSize(20)
                .fontWeight(FontWeight.Medium)
                .fontColor('#FFD700')
                .margin({ bottom: 8 })
              
              Text(spread.description)
                .fontSize(14)
                .fontColor('rgba(255,255,255,0.7)')
                .maxLines(3)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .lineHeight(20)
              
              Row() {
                Text(`${spread.cardCount} å¼ ç‰Œ`)
                  .fontSize(12)
                  .fontColor('rgba(255,255,255,0.5)')
                  .padding({ top: 4, bottom: 4, left: 8, right: 8 })
                  .backgroundColor('rgba(255,255,255,0.1)')
                  .borderRadius(4)
                  .margin({ top: 12 })
              }
              .width('100%')
              .justifyContent(FlexAlign.Start)
            }
            .width('100%')
            .padding(20)
            .backgroundColor('rgba(255,255,255,0.08)')
            .borderRadius(16)
            .backdropBlur(10)
            .border({ width: 1, color: 'rgba(255,255,255,0.1)' })
            .onClick(() => this.selectSpread(spread))
          }
        })
      }
      .width('90%')
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  DrawingBoard() {
    Stack() {
      // 1. èƒŒæ™¯/è¿”å›æŒ‰é’®
      Column() {
        Row() {
          Text('< è¿”å›')
            .fontColor('rgba(255,255,255,0.8)')
            .fontSize(16)
            .onClick(() => this.handleBack())
          
          Blank()
          
          Text(this.currentSpread?.name)
            .fontColor('#FFFFFF')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 10, bottom: 10 })
        .height(50)
        .zIndex(10)
      }
      .position({ x: 0, y: 0 })

      // 2. ç‰Œé˜µå¸ƒå±€åŒºåŸŸ (å±…ä¸­)
      if (this.currentSpread) {
        Stack() {
          ForEach(this.currentSpread.positions, (pos: SpreadPosition, index: number) => {
            // å ä½æ¡† (è™šçº¿)
            Column() {
              Text((index + 1).toString())
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('rgba(255,255,255,0.1)')
            }
            .width(50).height(80) // å°å°ºå¯¸ä»¥é€‚åº”å±å¹•
            .justifyContent(FlexAlign.Center)
            .border({ width: 1, color: 'rgba(255,255,255,0.15)', style: BorderStyle.Dashed })
            .borderRadius(4)
            .position({ x: '50%', y: '50%' })
            .translate({ x: pos.x - 25, y: pos.y - 40 }) // å±…ä¸­ä¿®æ­£
            .rotate({ angle: pos.rotate })
            .zIndex(0)

            // å®é™…å¡ç‰Œ (å¦‚æœå·²æŠ½å–)
            if (index < this.cards.length) {
              Image(this.getCardImageSource(this.cards[index].image))
                .width(50).height(80)
                .borderRadius(4)
                .position({ x: '50%', y: '50%' })
                .translate({ x: pos.x - 25, y: pos.y - 40 })
                .rotate({ angle: pos.rotate })
                .zIndex(pos.zIndex)
                .opacity(this.cardOpacities[index])
                .scale({ x: this.cardScales[index], y: this.cardScales[index] })
                .shadow({ radius: 5, color: 'rgba(0,0,0,0.5)' })
            }
          })
        }
        .width('100%')
        .height('100%')
        // æ•´ä½“ç¼©æ”¾ä»¥é€‚åº”ä¸åŒå±å¹•
        .scale({ x: 0.9, y: 0.9 }) 
      }

      // 3. åº•éƒ¨æ“ä½œåŒº
      Column() {
        if (this.currentSpread && this.drawnCount < this.currentSpread.cardCount) {
          // æŠ½ç‰ŒæŒ‰é’® (ç‰Œå †æ ·å¼)
          Stack() {
            Image($rawfile('card_back.png'))
              .width(80).height(120)
              .borderRadius(8)
              .shadow({ radius: 10, color: 'rgba(0,0,0,0.3)' })
              .rotate({ angle: -5 })
            
            Image($rawfile('card_back.png'))
              .width(80).height(120)
              .borderRadius(8)
              .shadow({ radius: 10, color: 'rgba(0,0,0,0.3)' })
              .rotate({ angle: 5 })
            
            Column() {
              Text('ç‚¹å‡»æŠ½ç‰Œ')
                .fontColor('#FFFFFF')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .textShadow({ radius: 2, color: 'rgba(0,0,0,0.5)' })
            }
            .width(80).height(120)
            .justifyContent(FlexAlign.Center)
          }
          .scale({ x: this.deckScale, y: this.deckScale })
          .onClick(() => this.drawNextCard())
          .margin({ bottom: 40 })
        } else {
          // åˆ†ææŒ‰é’®
          Button(this.isFreeAnalysis ? 'å¼€å§‹æ·±åº¦è§£è¯» (å…è´¹)' : `å¼€å§‹æ·±åº¦è§£è¯» (æ¶ˆè€— ${AIService.COST_DEEP_ANALYSIS} å¿ƒåŠ›)`)
            .backgroundColor('#FF69B4')
            .fontColor(Color.White)
            .width('80%')
            .height(50)
            .borderRadius(25)
            .shadow({ radius: 10, color: 'rgba(255, 105, 180, 0.4)', offsetY: 5 })
            .onClick(() => this.handleAnalyze())
            .margin({ bottom: 40 })
            .transition({ type: TransitionType.Insert, opacity: 0, translate: { y: 20 } })
        }
      }
      .width('100%')
      .position({ y: '100%' })
      .translate({ y: -100 }) // æŠ¬é«˜
    }
    .width('100%')
    .height('100%')
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      // èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#1A1A2E')
        // .backgroundImage($rawfile('bg_stars.png')) 

        .backgroundImageSize(ImageSize.Cover)

      // ä¸»å†…å®¹
      if (this.isDrawing) {
        this.DrawingBoard()
      } else {
        this.SpreadSelector()
      }

      BottomNavBar({ current: 'spread' })
    }
    .width('100%')
    .height('100%')
  }
}
