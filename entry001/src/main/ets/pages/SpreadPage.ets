// è·¯å¾„: ets/pages/SpreadPage.ets
// V10.0 ç»ˆæäº¤äº’ç‰ˆï¼šä¸‰ç‰Œé˜µåŠ å…¥â€œå‘¼å¸æ‚¬æµ®â€ä¸â€œQå¼¹ç‚¹å‡»â€

import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import { FortuneManager } from '../common/FortuneManager';
import { TarotCard } from '../model/TarotData';
import curves from '@ohos.curves';
import promptAction from '@ohos.promptAction';
import { BusinessError } from '@kit.BasicServicesKit';
import { AIService, ChatMessage } from '../common/AIService';

@Entry
@Component
struct SpreadPage {
  @State cards: TarotCard[] = [];
  @State cardStates: number[] = [0, 0, 0];
  @State cardImages: Resource[] = [$rawfile('card_back.png'), $rawfile('card_back.png'), $rawfile('card_back.png')];

  // ğŸ¬ ç¿»è½¬åŠ¨ç”»å˜é‡
  @State cardAngles: number[] = [0, 0, 0];
  @State cardFlightScales: number[] = [1, 1, 1];

  // âœ¨âœ¨âœ¨ æ–°å¢ï¼šå‘¼å¸ä¸äº¤äº’åŠ¨ç”»å˜é‡ (æ•°ç»„å¯¹åº”3å¼ ç‰Œ) âœ¨âœ¨âœ¨
  @State cardFloatOffsets: number[] = [0, 0, 0]; // å‘¼å¸ï¼šä¸Šä¸‹æµ®åŠ¨
  @State cardFloatAngles: number[] = [0, 0, 0];  // å‘¼å¸ï¼šå·¦å³å¾®æ‘†
  @State cardClickScales: number[] = [1, 1, 1];  // äº¤äº’ï¼šç‚¹å‡»ç¼©æ”¾

  // æ–‡å­—ä¸AI
  @State displayNames: string[] = ['', '', ''];
  @State displayMeanings: string[] = ['', '', ''];
  @State cardTextOpacities: number[] = [0, 0, 0];
  @State currentReadingCardIndex: number = -1;

  // AI å¼¹çª—
  @State isSheetOpen: boolean = false;
  @State isAnalyzing: boolean = false;
  @State chatHistory: ChatMessage[] = [];
  @State inputText: string = "";

  // ä¿®å¤ Scroller çŠ¶æ€æŠ¥é”™ï¼šç§»é™¤ @State
  private listScroller: Scroller = new Scroller();

  private manager = FortuneManager.getInstance();
  private positions = ['è¿‡å» Â· The Past', 'ç°åœ¨ Â· The Present', 'æœªæ¥ Â· The Future'];
  private context = getContext(this) as common.UIAbilityContext;

  aboutToAppear() {
    this.cards = this.manager.drawThreeSpread();
  }

  startTypewriter(index: number) {
    const card = this.cards[index];
    const fullMeaning = card.meaning;
    this.displayNames[index] = card.name;

    let charIndex = 0;
    let intervalID = setInterval(() => {
      if (charIndex < fullMeaning.length) {
        this.displayMeanings[index] += fullMeaning.charAt(charIndex);
        charIndex++;
      } else {
        clearInterval(intervalID);
      }
    }, 60);
  }

  // âœ¨ å¯åŠ¨å‘¼å¸åŠ¨ç”» (å¸¦éšæœºå»¶è¿Ÿï¼Œè®©ä¸‰å¼ ç‰Œå‘¼å¸ä¸åŒæ­¥ï¼Œæ›´è‡ªç„¶) âœ¨
  startBreathing(index: number) {
    const delay = index * 150; // æ¯å¼ ç‰Œé”™å¼€ä¸€ç‚¹æ—¶é—´

    // 1. ä¸Šä¸‹æµ®åŠ¨
    animateTo({
      duration: 2000,
      curve: Curve.EaseInOut,
      iterations: -1,
      playMode: PlayMode.Alternate,
      delay: delay
    }, () => {
      this.cardFloatOffsets[index] = -8; // å‘ä¸Šæµ®åŠ¨ 8px
    });

    // 2. å·¦å³å¾®æ‘†
    animateTo({
      duration: 3000,
      curve: Curve.Smooth,
      iterations: -1,
      playMode: PlayMode.Alternate,
      delay: delay + 500
    }, () => {
      this.cardFloatAngles[index] = 1; // å‘å³å¾®æ‘† 1åº¦
    });
  }

  // âœ¨ ç‚¹å‡» Q å¼¹åé¦ˆ âœ¨
  playClickFeedback(index: number) {
    // ç¬é—´ç¼©å°
    animateTo({ duration: 100, curve: Curve.EaseOut }, () => {
      this.cardClickScales[index] = 0.95;
    });

    // å¼¹ç°§å›å¼¹
    setTimeout(() => {
      animateTo({
        duration: 400,
        curve: curves.springMotion(0.5, 0.6)
      }, () => {
        this.cardClickScales[index] = 1.0;
      });
    }, 100);
  }

  handleCardClick(index: number) {
    // é¡ºåºæ§åˆ¶
    if (index > 0 && this.cardStates[index - 1] !== 2) {
      try {
        promptAction.showToast({ message: `è¯·å…ˆç¿»å¼€ã€Œ${this.positions[index - 1].split('Â·')[0].trim()}ã€çš„ç‰Œ`, duration: 2000 });
      } catch (e) {
        const _err = e as BusinessError | Error | object;
      }
      return;
    }

    // ğŸŒŸ æƒ…å†µ 1: å·²ç»ç¿»å¼€äº† -> è§¦å‘ Q å¼¹åé¦ˆ
    if (this.cardStates[index] === 2) {
      this.playClickFeedback(index);
      return;
    }

    // ğŸŒŸ æƒ…å†µ 2: æ­£åœ¨ç¿»è½¬ä¸­ -> å¿½ç•¥
    if (this.cardStates[index] !== 0) return;

    // ğŸŒŸ æƒ…å†µ 3: æœªç¿»å¼€ -> æ‰§è¡Œç¿»è½¬é€»è¾‘
    this.cardStates[index] = 1;

    // ğŸ¬ åŠ¨ç”»ç¬¬ä¸€é˜¶æ®µï¼šèµ·é£ + æ—‹è½¬90åº¦
    animateTo({
      duration: 400,
      curve: curves.springMotion(0.6, 0.8)
    }, () => {
      this.cardAngles[index] = 90;
      this.cardFlightScales[index] = 1.15; // ç¿»è½¬æ—¶æ”¾å¤§
    });

    // ğŸ¬ ä¸­åœºåˆ‡æ¢
    setTimeout(() => {
      this.cardImages[index] = $rawfile(this.cards[index].image);

      // ğŸ¬ åŠ¨ç”»ç¬¬äºŒé˜¶æ®µï¼šé™è½ + æ—‹è½¬180åº¦
      animateTo({
        duration: 500,
        curve: curves.springMotion(0.5, 0.7)
      }, () => {
        this.cardAngles[index] = 180;
        this.cardFlightScales[index] = 1.0; // æ¢å¤åŸå¤§å°
      });

      // ğŸ¬ æ”¶å°¾ï¼šå¯åŠ¨å‘¼å¸ + æ‰“å­—æœº
      setTimeout(() => {
        this.cardStates[index] = 2;
        this.currentReadingCardIndex = index;

        // å¯åŠ¨å‘¼å¸åŠ¨ç”»
        this.startBreathing(index);

        animateTo({ duration: 400 }, () => {
          this.cardTextOpacities[index] = 1;
        });
        this.startTypewriter(index);
      }, 300);

    }, 400);
  }

  /**
   * è§¦å‘ AI æ·±åº¦åˆ†æå¼¹çª—ï¼Œå¹¶è¯·æ±‚é¦–æ¡åˆ†æ
   */
  async handleAIAnalyze() {
    this.isSheetOpen = true;
    if (this.chatHistory.length > 0) return;
    this.isAnalyzing = true;

    const initialPrompt = AIService.createInitialPrompt(this.cards);
    const userMsg: ChatMessage = { role: 'user', content: initialPrompt };
    this.chatHistory.push(userMsg);
    const aiMsg: ChatMessage = { role: 'assistant', content: '' };
    this.chatHistory.push(aiMsg);

    const requestHistory = [userMsg];
    const resultText = await AIService.requestChat(requestHistory, this.context);

    this.isAnalyzing = false;
    this.typewriterEffect(resultText, this.chatHistory.length - 1);
  }

  /**
   * å‘é€åç»­å¯¹è¯æ¶ˆæ¯ï¼Œä¿æŒä¸Šä¸‹æ–‡
   */
  async handleSendMessage() {
    if (this.inputText.trim() === "" || this.isAnalyzing) return;
    const text = this.inputText;
    this.inputText = "";
    this.chatHistory.push({ role: 'user', content: text });
    this.listScroller.scrollEdge(Edge.Bottom);
    this.isAnalyzing = true;
    this.chatHistory.push({ role: 'assistant', content: "..." });
    const aiMsgIndex = this.chatHistory.length - 1;
    const requestHistory = this.chatHistory.slice(0, aiMsgIndex);
    const resultText = await AIService.requestChat(requestHistory, this.context);
    this.isAnalyzing = false;
    this.chatHistory[aiMsgIndex].content = "";
    this.typewriterEffect(resultText, aiMsgIndex);
  }

  typewriterEffect(fullText: string, msgIndex: number) {
    let index = 0;
    let intervalID = setInterval(() => {
      if (index < fullText.length) {
        const currentMsg = this.chatHistory[msgIndex];
        this.chatHistory[msgIndex] = {
          role: currentMsg.role,
          content: currentMsg.content + fullText.charAt(index)
        };
        index++;
        this.listScroller.scrollEdge(Edge.Bottom);
      } else {
        clearInterval(intervalID);
      }
    }, 30);
  }

  @Builder
  ChatSheetBuilder() {
    Column() {
      Row().width(40).height(5).backgroundColor('#E0E0E0').borderRadius(10).margin({ top: 10, bottom: 10 })

      Row() {
        Row() {
          Text("âœ¨å°é˜¿ç§‹").fontSize(18).fontWeight(FontWeight.Bold).fontColor('#333333')
          if (this.isAnalyzing) {
            LoadingProgress().width(20).height(20).color('#FF69B4').margin({ left: 8 })
          }
        }
        Button({ type: ButtonType.Circle, stateEffect: true }) {
          Text('âœ•').fontSize(14).fontColor('#999999')
        }.width(28).height(28).backgroundColor('#F5F5F5').onClick(() => { this.isSheetOpen = false; })
      }.width('100%').padding({ left: 20, right: 20, bottom: 10 }).justifyContent(FlexAlign.SpaceBetween)

      Divider().color('#F0F0F0')

      List({ scroller: this.listScroller }) {
        ForEach(this.chatHistory, (msg: ChatMessage, index: number) => {
          if (index > 0) {
            ListItem() {
              Row() {
                if (msg.role === 'user') {
                  Blank()
                  Text(msg.content).fontSize(15).fontColor(Color.White).backgroundColor('#FFB6C1').padding(12)
                    .borderRadius({ topLeft: 15, topRight: 5, bottomLeft: 15, bottomRight: 15 }).margin({ left: 40 })
                } else {
                  Image($rawfile('card_back.png')).width(30).height(30).borderRadius(15).margin({ right: 8 })
                  Text(msg.content).fontSize(15).fontColor('#333333').backgroundColor('#F5F5F5').padding(12)
                    .borderRadius({ topLeft: 5, topRight: 15, bottomLeft: 15, bottomRight: 15 }).margin({ right: 40 }).layoutWeight(1)
                }
              }.width('100%').padding({ top: 10, bottom: 10, left: 20, right: 20 }).alignItems(VerticalAlign.Top)
            }
          }
        })
      }.layoutWeight(1).width('100%')

      Row() {
        TextInput({ text: this.inputText, placeholder: 'æƒ³é—®ä»€ä¹ˆ...?' }).layoutWeight(1).height(40).backgroundColor('#F5F5F5')
          .borderRadius(20).padding({ left: 15 }).onChange((value) => { this.inputText = value; }).onSubmit(() => this.handleSendMessage())
        Button("å‘é€").width(70).height(40).backgroundColor('#FF69B4').fontColor(Color.White).margin({ left: 10 })
          .borderRadius(20).onClick(() => this.handleSendMessage()).opacity(this.isAnalyzing ? 0.5 : 1)
      }.width('100%').padding(15).backgroundColor(Color.White).shadow({ radius: 10, color: 'rgba(0,0,0,0.05)', offsetY: -2 })
    }
    .width('100%').height('100%').backgroundColor(Color.White)
  }

  build() {
    Column() {
      Row() {
        Button({ type: ButtonType.Circle, stateEffect: true }) {
          Text('â®').fontSize(18).fontColor('#FFFFFF')
        }.width(40).height(40).backgroundColor('rgba(255,255,255,0.2)').onClick(() => router.back())
        Text('æ—¶å…‰æµ Â· ä¸‰ç‰Œé˜µ').fontSize(20).fontWeight(FontWeight.Bold).fontColor('#FFFFFF')
          .layoutWeight(1).textAlign(TextAlign.Center).margin({ right: 40 })
      }.width('100%').height(50).padding({ left: 20, right: 20 }).margin({ top: 10, bottom: 20 })

      Column({ space: 20 }) {
        ForEach([0, 1, 2], (index: number) => {
          Row() {
            // --- 3D å¡ç‰Œå®¹å™¨ ---
            Stack() {
              // 1. èƒŒé¢ (0 -> 180åº¦ï¼Œç¿»è¿‡å»åæ¶ˆå¤±)
              Image($rawfile('card_back.png'))
                .width('100%').height('100%')
                .borderRadius(10)
                .rotate({ x: 0, y: 1, z: 0, angle: this.cardAngles[index] })
                .opacity(this.cardAngles[index] < 90 ? 1 : 0)

              // 2. æ­£é¢ (åˆå§‹ -180åº¦ï¼Œç¿»è¿‡æ¥å˜0åº¦æ˜¾ç¤º)
              Image($rawfile(this.cards[index].image))
                .width('100%').height('100%')
                .borderRadius(10)
                .rotate({ x: 0, y: 1, z: 0, angle: this.cardAngles[index] - 180 })
                .opacity(this.cardAngles[index] >= 90 ? 1 : 0)
                // ğŸ’¡ ç»‘å®šç¿»è½¬æ—¶çš„æ‚¬æµ®ç¼©æ”¾ (ScaleY)
                .scale({ x: 1, y: this.cardFlightScales[index] })
            }
            .width(110).aspectRatio(2/3)
            .shadow({ radius: 15, color: 'rgba(0,0,0,0.4)', offsetY: 8 })

            // âœ¨âœ¨âœ¨ å¤–å±‚ Stack ç»‘å®šå‘¼å¸å’Œç‚¹å‡»åŠ¨ç”» âœ¨âœ¨âœ¨
            .translate({ y: this.cardFloatOffsets[index] })    // ç»‘å®šå‘¼å¸æµ®åŠ¨
            .rotate({ z: 1, angle: this.cardFloatAngles[index] }) // ç»‘å®šå‘¼å¸æ‘†åŠ¨ (æ³¨æ„z:1)
            .scale({ x: this.cardClickScales[index], y: this.cardClickScales[index] }) // ç»‘å®šç‚¹å‡»ç¼©æ”¾

            .onClick(() => this.handleCardClick(index))
            .align(Alignment.Center)
            .animation({ duration: 0 }) // ç¦ç”¨ Stack è‡ªèº«éšå¼åŠ¨ç”»ï¼Œé˜²æ­¢å¹²æ‰°

            // å³ä¾§æ–‡å­—
            if (this.cardStates[index] === 2) {
              Column() {
                Text(this.positions[index]).fontSize(13).fontColor('rgba(255,255,255,0.7)').margin({ bottom: 4 })
                Text(this.displayNames[index]).fontSize(20).fontWeight(FontWeight.Bold).fontColor('#FFFFFF').margin({ bottom: 8 })
                Text(this.displayMeanings[index]).fontSize(15).fontColor('#EEEEEE').maxLines(3).textOverflow({ overflow: TextOverflow.Ellipsis })
                  .border(this.displayMeanings[index].length < this.cards[index].meaning.length ? { width: { right: 2 }, color: '#FF69B4' } : { width: 0 })
              }
              .layoutWeight(1).padding({ left: 25, right: 10 }).alignItems(HorizontalAlign.Start)
              .opacity(this.cardTextOpacities[index])
              .transition({ type: TransitionType.Insert, opacity: 0, translate: { x: 20 } })
            }
          }.width('100%').alignItems(VerticalAlign.Center)
          .opacity(index > (this.currentReadingCardIndex === -1 ? 0 : this.currentReadingCardIndex + 1) && this.cardStates[index - 1] !== 2 ? 0.3 : 1)
        })
      }.margin({ top: 30 }).padding({ left: 20, right: 20 })

      Blank()

      if (this.cardStates[2] === 2) {
        Column() {
          // Text("âœ¨ ç‰Œé˜µå·²æˆï¼Œæ˜¯å¦éœ€è¦æ·±å…¥è§£è¯»ï¼Ÿ").fontSize(14).fontColor('rgba(255,255,255,0.6)').margin({ bottom: 15 })
          Button("ğŸ”®æ·±åº¦åˆ†æ").backgroundColor('#FF69B4').fontColor(Color.White).width('80%').height(50).borderRadius(25)
            .shadow({ radius: 10, color: 'rgba(255, 105, 180, 0.4)', offsetY: 5 }).onClick(() => this.handleAIAnalyze())
        }
        .margin({ bottom: 40 })
        .transition({ type: TransitionType.Insert, opacity: 0, translate: { y: 20 } })
      }
    }
    .width('100%').height('100%').backgroundColor('#1A1A2E').padding({ top: 12, bottom: 12 })
    .bindSheet($$this.isSheetOpen, this.ChatSheetBuilder(), {
      height: SheetSize.LARGE, backgroundColor: Color.White, blurStyle: BlurStyle.Thin, showClose: false, dragBar: true
    })
  }
}