import { router } from '@kit.ArkUI';
import { BottomNavBar } from '../common/BottomNavBar';
import { UserManager, UserInfo } from '../common/UserManager';
import { EnergyManager } from '../common/EnergyManager';
import { FortuneManager } from '../common/FortuneManager';
import { promptAction } from '@kit.ArkUI';
import common from '@ohos.app.ability.common';
import { BusinessError } from '@kit.BasicServicesKit';

@Entry
@Component
struct ProfilePage {
  @State currentUser: UserInfo | null = null;
  @State currentEnergy: number = 0;
  @State isVip: boolean = false;
  // ç”¨äº DatePicker çš„æ—¥æœŸå¯¹è±¡
  @State selectedDate: Date = new Date('1995-01-01');
  // ç”¨äºå±•ç¤ºçš„å­—ç¬¦ä¸²
  @State birthDateText: string = 'æœªè®¾ç½®';

  private userManager = UserManager.getInstance();
  private energyManager = EnergyManager.getInstance();
  private fortuneManager = FortuneManager.getInstance();

  async aboutToAppear(): Promise<void> {
    this.refreshData();
  }

  onPageShow(): void {
    this.refreshData();
  }

  refreshData(): void {
    this.currentUser = this.userManager.getCurrentUser();
    this.currentEnergy = this.energyManager.getEnergy();
    void (async () => {
      this.isVip = await this.fortuneManager.isVip();
    })();
  }

  // ğŸŸ¢ ä¿®å¤2ï¼šä½¿ç”¨ DatePickerDialog é€‰æ‹©å‡ºç”Ÿå¹´æœˆ
  handleEditBirth(): void {
    DatePickerDialog.show({
      start: new Date("1900-1-1"),
      end: new Date(), // ç»“æŸæ—¶é—´ä¸ºä»Šå¤©
      selected: this.selectedDate,
      onAccept: (value: DatePickerResult) => {
        // value.year, value.month(0-11), value.day
        if (value.year !== undefined && value.month !== undefined && value.day !== undefined) {
          this.selectedDate.setFullYear(value.year, value.month, value.day);
          // æ ¼å¼åŒ–æ˜¾ç¤ºï¼šYYYY-MM-DD
          this.birthDateText = `${value.year}-${(value.month + 1).toString().padStart(2, '0')}-${value.day.toString().padStart(2, '0')}`;
          promptAction.showToast({ message: 'ğŸ“… ç”Ÿæ—¥å·²æ›´æ–°' });
          // TODO: å¦‚æœéœ€è¦ï¼Œè¿™é‡Œå¯ä»¥è°ƒç”¨ FortuneManager ä¿å­˜ç”Ÿæ—¥ä¿¡æ¯
        }
      }
    });
  }


  // ğŸŸ¢ ä¿®å¤1ï¼šå®Œå–„ç™»å½•é€»è¾‘ä¸åé¦ˆ
  async handleLogin(): Promise<void> {
    try {
      // æ˜¾å¼è·å– UIAbilityContext
      const context = getContext(this) as common.UIAbilityContext;

      // ç»™ç”¨æˆ·ä¸€ä¸ªåé¦ˆï¼Œé˜²æ­¢ç‚¹å‡»æ²¡ååº”
      promptAction.showToast({ message: 'æ­£åœ¨å”¤èµ·åä¸ºç™»å½•...', duration: 1500 });

      const user = await this.userManager.login(context);
      this.currentUser = user;
      promptAction.showToast({ message: `æ¬¢è¿å›æ¥ï¼Œ${user.nickname}` });
    } catch (e) {
      const err = e as BusinessError;
      console.error(`ProfilePage Login Error: ${err.code} - ${err.message}`);

      // æ ¹æ®é”™è¯¯ç ç»™å‡ºæ›´å‹å¥½çš„æç¤º
      let msg = 'ç™»å½•å¤±è´¥';
      if (err.code === 1001502001) msg = 'è¯·å…ˆåœ¨ç³»ç»Ÿè®¾ç½®ä¸­ç™»å½•åä¸ºè´¦å·'; // æ¨¡æ‹Ÿå™¨å¸¸è§
      else if (err.code === 1001500001) msg = 'ç­¾åæŒ‡çº¹æœªé…ç½® (Client ID)';
      else if (err.code === 12300001) msg = 'ç³»ç»ŸæœåŠ¡ä¸å¯ç”¨';

      promptAction.showToast({ message: msg, duration: 3000 });
    }
  }

  @Builder
  InfoItem(icon: string, label: string, value: string, onClick?: () => void, showArrow: boolean = true) {
    Row() {
      Row() {
        Text(icon).fontSize(20).margin({ right: 12 })
        Text(label).fontSize(16).fontColor('#333')
      }
      Blank()
      Row() {
        Text(value).fontSize(14).fontColor('#999').margin({ right: 4 })
        if (showArrow) {
          Text('â€º').fontSize(18).fontColor('#CCC').margin({ bottom: 2 })
        }
      }
    }
    .width('100%')
    .height(56)
    .backgroundColor(Color.White)
    .padding({ left: 20, right: 20 })
    .borderRadius(16)
    .margin({ bottom: 12 })
    .onClick(() => {
      if (onClick) onClick();
    })
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      // èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Top,
          colors: [['#FDFBFB', 0.0], ['#F2F4F8', 1.0]]
        })

      Scroll() {
        Column() {
          // 1. å¤´éƒ¨ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
          Column() {
            if (this.currentUser) {
              Row() {
                // ä½¿ç”¨ resource å¼•ç”¨æœ¬åœ°å›¾ç‰‡ä½œä¸ºé»˜è®¤å¤´åƒ
                Image(this.currentUser.avatar || $r('app.media.startIcon'))
                  .width(72).height(72).borderRadius(36)
                  .objectFit(ImageFit.Cover)
                  .backgroundColor('#EEE')

                Column({ space: 6 }) {
                  Text(this.currentUser.nickname || 'åä¸ºç”¨æˆ·')
                    .fontSize(20).fontWeight(FontWeight.Bold).fontColor('#333')

                  Row({ space: 8 }) {
                    Text(this.isVip ? 'ğŸ‘‘ å°Šè´µä¼šå‘˜' : 'ğŸŒ± æ²»æ„ˆæ—…äºº')
                      .fontSize(12).fontColor(this.isVip ? '#D4AF37' : '#888')
                      .backgroundColor(this.isVip ? '#FFF8E1' : '#F0F0F0')
                      .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                      .borderRadius(10)

                    Text(`ID: ${this.currentUser.userId.substring(0, 6)}...`)
                      .fontSize(12).fontColor('#AAA')
                  }
                }
                .alignItems(HorizontalAlign.Start)
                .margin({ left: 16 })
              }
              .width('100%')
              .padding({ top: 20, bottom: 20 })
            } else {
              // æœªç™»å½•çŠ¶æ€
              Column({ space: 12 }) {
                Text('ğŸ‘¤').fontSize(48)
                Text('ç™»å½•åä¸ºè´¦å·ï¼ŒåŒæ­¥ä½ çš„æ²»æ„ˆä¹‹æ—…').fontSize(14).fontColor('#888')
                Button('ç«‹å³ç™»å½•')
                  .backgroundColor('#333')
                  .fontColor(Color.White)
                  .height(36)
                  .fontSize(14)
                  .onClick(() => this.handleLogin())
              }
              .width('100%')
              .padding({ top: 30, bottom: 30 })
              .alignItems(HorizontalAlign.Center)
            }
          }
          .backgroundColor(Color.White)
          .borderRadius(20)
          .padding(20)
          .margin({ top: 20, left: 20, right: 20 })
          .shadow({ radius: 20, color: 'rgba(0,0,0,0.03)', offsetY: 5 })

          // 2. èƒ½é‡å¡ç‰‡
          Row() {
            Column() {
              Text(this.currentEnergy.toString()).fontSize(24).fontWeight(FontWeight.Bold).fontColor('#FF69B4')
              Text('å½“å‰å¿ƒåŠ›').fontSize(12).fontColor('#888').margin({ top: 4 })
            }.layoutWeight(1).alignItems(HorizontalAlign.Center)

            Divider().vertical(true).height(30).color('#F0F0F0')

            Column() {
              Text('æ¯æ—¥ 00:00').fontSize(16).fontWeight(FontWeight.Bold).fontColor('#333')
              Text('è‡ªåŠ¨æ¢å¤').fontSize(12).fontColor('#888').margin({ top: 4 })
            }.layoutWeight(1).alignItems(HorizontalAlign.Center)
          }
          .backgroundColor(Color.White)
          .borderRadius(20)
          .padding(20)
          .margin({ top: 16, left: 20, right: 20 })
          .shadow({ radius: 20, color: 'rgba(0,0,0,0.03)', offsetY: 5 })

          // 3. åŠŸèƒ½åˆ—è¡¨
          Column() {
            if (this.currentUser) {
              Text('ä¸ªäººèµ„æ–™').fontSize(14).fontColor('#888').margin({ left: 8, bottom: 8 })
              // ğŸŸ¢ ä¿®å¤ï¼šç‚¹å‡»å¼¹å‡º DatePicker é€‰æ‹©å™¨
              this.InfoItem('ğŸ‚', 'å‡ºç”Ÿå¹´æœˆ', this.birthDateText, () => this.handleEditBirth())
            }

            Text('æ›´å¤šæœåŠ¡').fontSize(14).fontColor('#888').margin({ left: 8, top: 20, bottom: 8 })
            this.InfoItem('ğŸ“–', 'å…³äºæˆ‘ä»¬', '', () => promptAction.showToast({ message: 'å…³äºæˆ‘ä»¬ï¼šæ²»æ„ˆç³»å¡”ç½— v1.0' }))
            this.InfoItem('ğŸ“„', 'ç”¨æˆ·åè®®', '', () => router.pushUrl({ url: 'pages/UserAgreementPage' }))
            this.InfoItem('ğŸ›¡ï¸', 'éšç§æ”¿ç­–', '', () => router.pushUrl({ url: 'pages/PrivacyPolicyPage' }))
            this.InfoItem('ğŸ§', 'è”ç³»å®¢æœ', '', () => promptAction.showToast({ message: 'å®¢æœå°†ä¼šå°½å¿«è”ç³»æ‚¨' }))
            this.InfoItem('ğŸ’ª', 'å¸¸è§é¼“åŠ±', '', () => promptAction.showToast({ message: 'ç›¸ä¿¡è‡ªå·±ï¼Œæœªæ¥å¯æœŸï¼' }))
            this.InfoItem('â­', 'äº”æ˜Ÿé¼“åŠ±', '', () => promptAction.showToast({ message: 'æ„Ÿè°¢æ‚¨çš„äº”æ˜Ÿå¥½è¯„ï¼' }))
            this.InfoItem('âš™ï¸', 'è®¾ç½®', '', () => router.pushUrl({ url: 'pages/SettingsPage' }))
          }
          .padding(20)
          .width('100%')

          Blank().height(100) // åº•éƒ¨ç•™ç™½
        }
      }
      .width('100%')
      .height('100%')
      .scrollBar(BarState.Off)

      // åº•éƒ¨å¯¼èˆªæ 
      BottomNavBar({ current: 'profile' })
    }
    .width('100%')
    .height('100%')
  }
}