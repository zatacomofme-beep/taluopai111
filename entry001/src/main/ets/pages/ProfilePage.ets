import { router } from '@kit.ArkUI';
import { BottomNavBar } from '../common/BottomNavBar';
import { UserManager, UserInfo } from '../common/UserManager';
import { EnergyManager } from '../common/EnergyManager';
import { FortuneManager } from '../common/FortuneManager';
import { promptAction } from '@kit.ArkUI';
import common from '@ohos.app.ability.common'; // ğŸ”´ 1. å¼•å…¥ common æ¨¡å—

@Entry
@Component
struct ProfilePage {
  @State currentUser: UserInfo | null = null;
  @State currentEnergy: number = 0;
  @State isVip: boolean = false;
  @State birthDate: string = 'æœªè®¾ç½®';
  @State isPrivacyMode: boolean = false;

  private userManager = UserManager.getInstance();
  private energyManager = EnergyManager.getInstance();
  private fortuneManager = FortuneManager.getInstance();

  // ğŸ”´ 2. æ·»åŠ æ˜¾å¼è¿”å›ç±»å‹ Promise<void>
  async aboutToAppear(): Promise<void> {
    this.refreshData();
    this.isPrivacyMode = await this.fortuneManager.isPrivacyMode();
  }

  // ğŸ”´ 2. æ·»åŠ æ˜¾å¼è¿”å›ç±»å‹ void
  onPageShow(): void {
    this.refreshData();
  }

  refreshData(): void {
    this.currentUser = this.userManager.getCurrentUser();
    this.currentEnergy = this.energyManager.getEnergy();
    void (async () => {
      this.isVip = await this.fortuneManager.isVip();
    })();
  }

  // æ¨¡æ‹Ÿé€‰æ‹©å‡ºç”Ÿæ—¥æœŸ
  handleEditBirth(): void {
    promptAction.showDialog({
      title: 'è®¾ç½®å‡ºç”Ÿå¹´æœˆ',
      message: 'è¯·è¾“å…¥æ‚¨çš„å‡ºç”Ÿå¹´æœˆ (å¦‚ 1995-08-05)',
      buttons: [
        { text: 'å–æ¶ˆ', color: '#999999' },
        { text: 'ç¡®å®š', color: '#FF69B4' }
      ],
    }, (err, data) => {
      if (data.index === 1) {
        this.birthDate = '1998.06.15';
        promptAction.showToast({ message: 'ğŸ“… ç”Ÿæ—¥å·²æ›´æ–°' });
      }
    });
  }

  async togglePrivacy(isOn: boolean): Promise<void> {
    this.isPrivacyMode = isOn;
    await this.fortuneManager.setPrivacyMode(isOn);
    promptAction.showToast({ message: isOn ? 'ğŸ”’ éšç§æ¨¡å¼å·²å¼€å¯' : 'ğŸ”“ éšç§æ¨¡å¼å·²å…³é—­' });
  }

  handleLogout(): void {
    promptAction.showDialog({
      title: 'é€€å‡ºç™»å½•',
      message: 'ç¡®å®šè¦é€€å‡ºå½“å‰è´¦å·å—ï¼Ÿ',
      buttons: [
        { text: 'å–æ¶ˆ', color: '#999999' },
        { text: 'é€€å‡º', color: '#FF0000' }
      ]
    }, (err, data) => {
      if (data.index === 1) {
        this.userManager.logout();
        this.currentUser = null;
        promptAction.showToast({ message: 'å·²é€€å‡º' });
        this.refreshData();
      }
    });
  }

  async handleLogin(): Promise<void> {
    try {
      // ğŸ”´ 3. ä¿®å¤ Context ç±»å‹æŠ¥é”™ï¼šå¼ºåˆ¶è½¬æ¢ä¸º common.UIAbilityContext
      const context = getContext(this) as common.UIAbilityContext;
      const user = await this.userManager.login(context);
      this.currentUser = user;
      promptAction.showToast({ message: `æ¬¢è¿å›æ¥ï¼Œ${user.nickname}` });
    } catch (e) {
      // ç™»å½•å¤±è´¥æˆ–å–æ¶ˆ
    }
  }

  @Builder
  InfoItem(icon: string, label: string, value: string, onClick?: () => void, showArrow: boolean = true) {
    Row() {
      Row() {
        Text(icon).fontSize(20).margin({ right: 12 })
        Text(label).fontSize(16).fontColor('#333')
      }
      Blank()
      Row() {
        Text(value).fontSize(14).fontColor('#999').margin({ right: 4 })
        if (showArrow) {
          Text('â€º').fontSize(18).fontColor('#CCC').margin({ bottom: 2 })
        }
      }
    }
    .width('100%')
    .height(56)
    .backgroundColor(Color.White)
    .padding({ left: 20, right: 20 })
    .borderRadius(16)
    .margin({ bottom: 12 })
    .onClick(() => {
      if (onClick) onClick();
    })
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      // èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Top,
          colors: [['#FDFBFB', 0.0], ['#F2F4F8', 1.0]]
        })

      Scroll() {
        Column() {
          // 1. å¤´éƒ¨ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
          Column() {
            if (this.currentUser) {
              Row() {
                // ğŸ”´ 4. ä¿®å¤èµ„æºå¼•ç”¨æŠ¥é”™ï¼šæ”¹ç”¨ $r('app.media.startIcon')
                Image(this.currentUser.avatar || $r('app.media.startIcon'))
                  .width(72).height(72).borderRadius(36)
                  .objectFit(ImageFit.Cover)
                  .backgroundColor('#EEE')

                Column({ space: 6 }) {
                  Text(this.currentUser.nickname || 'åä¸ºç”¨æˆ·')
                    .fontSize(20).fontWeight(FontWeight.Bold).fontColor('#333')

                  Row({ space: 8 }) {
                    Text(this.isVip ? 'ğŸ‘‘ å°Šè´µä¼šå‘˜' : 'ğŸŒ± æ²»æ„ˆæ—…äºº')
                      .fontSize(12).fontColor(this.isVip ? '#D4AF37' : '#888')
                      .backgroundColor(this.isVip ? '#FFF8E1' : '#F0F0F0')
                      .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                      .borderRadius(10)

                    Text(`ID: ${this.currentUser.userId.substring(0, 6)}...`)
                      .fontSize(12).fontColor('#AAA')
                  }
                }
                .alignItems(HorizontalAlign.Start)
                .margin({ left: 16 })
              }
              .width('100%')
              .padding({ top: 20, bottom: 20 })
            } else {
              // æœªç™»å½•çŠ¶æ€
              Column({ space: 12 }) {
                Text('ğŸ‘¤').fontSize(48)
                Text('ç™»å½•åä¸ºè´¦å·ï¼ŒåŒæ­¥ä½ çš„æ²»æ„ˆä¹‹æ—…').fontSize(14).fontColor('#888')
                Button('ç«‹å³ç™»å½•')
                  .backgroundColor('#333')
                  .fontColor(Color.White)
                  .height(36)
                  .fontSize(14)
                  .onClick(() => this.handleLogin())
              }
              .width('100%')
              .padding({ top: 30, bottom: 30 })
              .alignItems(HorizontalAlign.Center)
            }
          }
          .backgroundColor(Color.White)
          .borderRadius(20)
          .padding(20)
          .margin({ top: 20, left: 20, right: 20 })
          .shadow({ radius: 20, color: 'rgba(0,0,0,0.03)', offsetY: 5 })

          // 2. èƒ½é‡å¡ç‰‡
          Row() {
            Column() {
              Text(this.currentEnergy.toString()).fontSize(24).fontWeight(FontWeight.Bold).fontColor('#FF69B4')
              Text('å½“å‰å¿ƒåŠ›').fontSize(12).fontColor('#888').margin({ top: 4 })
            }.layoutWeight(1).alignItems(HorizontalAlign.Center)

            Divider().vertical(true).height(30).color('#F0F0F0')

            Column() {
              Text('æ¯æ—¥ 00:00').fontSize(16).fontWeight(FontWeight.Bold).fontColor('#333')
              Text('è‡ªåŠ¨æ¢å¤').fontSize(12).fontColor('#888').margin({ top: 4 })
            }.layoutWeight(1).alignItems(HorizontalAlign.Center)
          }
          .backgroundColor(Color.White)
          .borderRadius(20)
          .padding(20)
          .margin({ top: 16, left: 20, right: 20 })
          .shadow({ radius: 20, color: 'rgba(0,0,0,0.03)', offsetY: 5 })

          // 3. åŠŸèƒ½åˆ—è¡¨
          Column() {
            Text('ä¸ªäººèµ„æ–™').fontSize(14).fontColor('#888').margin({ left: 8, bottom: 8 })

            this.InfoItem('ğŸ‚', 'å‡ºç”Ÿå¹´æœˆ', this.birthDate, () => this.handleEditBirth())
            this.InfoItem('â˜ï¸', 'æ•°æ®äº‘åŒæ­¥', this.currentUser ? 'å·²å°±ç»ª' : 'æœªç™»å½•', () => {
              // è·³è½¬å›é¦–é¡µè§¦å‘åŒæ­¥ï¼Œæˆ–è€…åœ¨è¿™é‡Œå¤åˆ¶åŒæ­¥é€»è¾‘
              router.back();
              promptAction.showToast({message: 'è¯·åœ¨é¦–é¡µç‚¹å‡»äº‘å›¾æ ‡è¿›è¡ŒåŒæ­¥'});
            })

            Text('è®¾ç½®').fontSize(14).fontColor('#888').margin({ left: 8, top: 12, bottom: 8 })

            // éšç§æ¨¡å¼å¼€å…³
            Row() {
              Row() {
                Text('ğŸ”’').fontSize(20).margin({ right: 12 })
                Column() {
                  Text('éšç§ä¿æŠ¤æ¨¡å¼').fontSize(16).fontColor('#333')
                  Text('éšè—é¦–é¡µæ–‡å­—å’Œåˆ†äº«å†…å®¹').fontSize(12).fontColor('#AAA').margin({ top: 2 })
                }.alignItems(HorizontalAlign.Start)
              }
              Toggle({ type: ToggleType.Switch, isOn: this.isPrivacyMode })
                .selectedColor('#FF69B4')
                .onChange((isOn) => this.togglePrivacy(isOn))
            }
            .width('100%')
            .padding(20)
            .backgroundColor(Color.White)
            .borderRadius(16)
            .margin({ bottom: 12 })

            if (this.currentUser) {
              Button('é€€å‡ºç™»å½•')
                .backgroundColor('#FFF0F5')
                .fontColor('#FF69B4')
                .width('100%')
                .height(50)
                .borderRadius(16)
                .margin({ top: 20 })
                .onClick(() => this.handleLogout())
            }
          }
          .padding(20)
          .width('100%')

          Blank().height(100) // åº•éƒ¨ç•™ç™½
        }
      }
      .width('100%')
      .height('100%')
      .scrollBar(BarState.Off)

      // åº•éƒ¨å¯¼èˆªæ  (éœ€è¦æ›´æ–° BottomNavBar æ”¯æŒ Profile tab)
      BottomNavBar({ current: 'profile' })
    }
    .width('100%')
    .height('100%')
  }
}