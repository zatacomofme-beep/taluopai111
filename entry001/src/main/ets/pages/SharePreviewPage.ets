import { router } from '@kit.ArkUI';
import { componentSnapshot } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';
import { abilityAccessCtrl } from '@kit.AbilityKit';
import common from '@ohos.app.ability.common';
import { ImageSaver } from '../common/ImageSaver';
import { ShareHelper } from '../common/ShareHelper';
import { TarotCard } from '../model/TarotData';

interface ShareParams {
  card: TarotCard;
  todayDate: string;
  todayWeek: string;
  goldQuote: string;
  privacyMode: boolean;
}

@Entry
@Component
struct SharePreviewPage {
  @State card: TarotCard | null = null;
  @State todayDate: string = '';
  @State todayWeek: string = '';
  @State goldQuote: string = '';
  @State privacyMode: boolean = false;
  @State shareTheme: string = 'soft'; // soft | minimal | star
  @State isPosterReady: boolean = false;

  private context = getContext(this) as common.UIAbilityContext;
  private POSTER_ID = 'poster_component_id';
  // äºŒç»´ç é“¾æ¥å¸¸é‡
  private QR_CODE_URL = 'https://taluopai.obs.cn-southwest-2.myhuaweicloud.com/tarot_cards/qr_code.png';

  aboutToAppear() {
    const params = router.getParams() as ShareParams;
    if (params) {
      this.card = params.card;
      this.todayDate = params.todayDate;
      this.todayWeek = params.todayWeek;
      this.goldQuote = params.goldQuote;
      this.privacyMode = params.privacyMode;
    }
    // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹æ˜¾ç¤ºæµ·æŠ¥ï¼Œç»™è½¬åœºåŠ¨ç”»ç•™æ—¶é—´
    setTimeout(() => {
      this.isPosterReady = true;
    }, 300);
  }

  // æ™ºèƒ½å›¾ç‰‡æºå¤„ç†
  getCardImageSource(url: string): ResourceStr {
    if (url.startsWith('http')) {
      return url;
    }
    return $rawfile(url);
  }

  getThemeBgColor(): ResourceColor {
    if (this.shareTheme === 'minimal') return '#F7F7F7';
    if (this.shareTheme === 'star') return '#1A1A2E';
    return Color.White; // soft
  }

  getThemePrimaryTextColor(): string {
    return this.shareTheme === 'star' ? '#EEEEEE' : '#333333';
  }

  getThemeSecondaryTextColor(): string {
    return this.shareTheme === 'star' ? '#BBBBBB' : '#888888';
  }

  async executeSave() {
    try {
      const ok = await this.ensureAlbumPermissions();
      if (!ok) { promptAction.showToast({ message: 'éœ€è¦ç›¸å†Œæƒé™', duration: 2500 }); return; }
      const pixelMap = await componentSnapshot.get(this.POSTER_ID);
      await ImageSaver.saveToAlbum(this.context, pixelMap);
    } catch (err) {
      promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥', duration: 2000 });
    }
  }

  async handleSystemShare() {
    try {
      promptAction.showToast({ message: 'æ­£åœ¨ç”Ÿæˆ...', duration: 1000 });
      await ShareHelper.snapshotAndShare(this.context, this.POSTER_ID);
    } catch (err) {
      promptAction.showToast({ message: 'åˆ†äº«å¤±è´¥', duration: 2000 });
    }
  }

  async ensureAlbumPermissions(): Promise<boolean> {
    try {
      const atManager = abilityAccessCtrl.createAtManager();
      const result = await atManager.requestPermissionsFromUser(this.context, ['ohos.permission.READ_IMAGEVIDEO', 'ohos.permission.WRITE_IMAGEVIDEO']);
      return Array.isArray(result.authResults) ? result.authResults.every(v => v === 0) : true;
    } catch { return false; }
  }

  @Builder
  ThemeButton(themeKey: string, label: string) {
    Button(label)
      .onClick(() => { this.shareTheme = themeKey; })
      .backgroundColor(this.shareTheme === themeKey ? '#333' : '#EEE')
      .fontColor(this.shareTheme === themeKey ? '#FFF' : '#000')
      .height(32)
      .fontSize(12)
      .borderRadius(16)
      .animation({ duration: 200 })
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle, stateEffect: true }) {
          Text('âœ•').fontSize(18).fontColor('#333')
        }
        .width(40).height(40).backgroundColor('rgba(0,0,0,0.05)')
        .onClick(() => router.back())

        Text('åˆ†äº«é¢„è§ˆ').fontSize(18).fontWeight(FontWeight.Bold).layoutWeight(1).textAlign(TextAlign.Center).margin({ right: 40 })
      }
      .width('100%').height(56).padding({ left: 16, right: 16 }).backgroundColor(Color.White)

      // 2. ä¸»é¢˜åˆ‡æ¢æ 
      Row({ space: 12 }) {
        this.ThemeButton('soft', 'è½»æŸ”')
        this.ThemeButton('minimal', 'æç®€')
        this.ThemeButton('star', 'æ˜Ÿç©º')
      }
      .width('100%').justifyContent(FlexAlign.Center).padding({ top: 10, bottom: 10 }).backgroundColor(Color.White)

      // 3. æµ·æŠ¥é¢„è§ˆåŒºåŸŸ (å¯æ»šåŠ¨)
      Scroll() {
        Column() {
          if (this.card) {
            // --- æµ·æŠ¥å®¹å™¨ ---
            Column() {
              // å¤´éƒ¨æ—¥æœŸ
              Row() {
                Column() {
                  Text(this.todayDate).fontSize(18).fontWeight(FontWeight.Bold).fontColor(this.getThemePrimaryTextColor())
                  Text(this.todayWeek).fontSize(12).fontColor(this.getThemeSecondaryTextColor())
                }.alignItems(HorizontalAlign.Start)
                Blank()
                Text("æ²»æ„ˆä¹‹ä¹¦").fontSize(14).fontColor('#FF69B4').fontWeight(FontWeight.Medium)
              }.width('100%').padding({ left: 20, right: 20, top: 24 })

              // å¡ç‰Œå¤§å›¾
              Image(this.getCardImageSource(this.card.image))
                .width('100%').aspectRatio(2/3).borderRadius(12).margin({ top: 16 })
                .shadow({ radius: 10, color: 'rgba(0,0,0,0.1)', offsetY: 5 })
                .alt($rawfile('card_back.png'))

              // æ–‡å­—è§£è¯»
              Column() {
                Text(this.card.name).fontSize(24).fontWeight(FontWeight.Bold).fontColor(this.getThemePrimaryTextColor()).margin({ top: 20 })
                Text(this.card.meaning).fontSize(14).fontColor(this.getThemeSecondaryTextColor()).margin({ top: 6, bottom: 16 })

                if (!this.privacyMode) {
                  Text(this.card.desc).fontSize(15).fontColor(this.getThemePrimaryTextColor()).opacity(0.9).textAlign(TextAlign.Center).lineHeight(24)
                  if (this.goldQuote) {
                    Text(`â€œ ${this.goldQuote} â€`).fontSize(14).fontColor('#FF69B4').fontStyle(FontStyle.Italic).margin({ top: 16 })
                  }
                } else {
                  Text("ğŸ”’ ç§å¯†æ¨¡å¼").fontSize(12).fontColor(this.getThemeSecondaryTextColor()).margin({ top: 10 })
                }
              }.padding(20)

              // åº•éƒ¨äºŒç»´ç 
              Row() {
                Text("æ‰«ç è·å–ä½ çš„æ²»æ„ˆå¡ç‰‡").fontSize(10).fontColor(this.getThemeSecondaryTextColor())
                Blank()
                Image(this.QR_CODE_URL).width(48).height(48).opacity(0.8).alt($rawfile('qr_code.png'))
              }.width('100%').padding({ left: 20, right: 20, bottom: 24 })

            }
            .width('90%') // æµ·æŠ¥å®½åº¦å å±å¹• 90%
            .backgroundColor(this.getThemeBgColor())
            .borderRadius(20)
            .shadow({ radius: 30, color: 'rgba(0,0,0,0.15)', offsetY: 10 })
            .margin({ top: 20, bottom: 40 }) // ä¸Šä¸‹ç•™ç™½
            .id(this.POSTER_ID)
            // --- æµ·æŠ¥ç»“æŸ ---
          }
        }.width('100%')
      }
      .layoutWeight(1) // å æ®å‰©ä½™ç©ºé—´
      .backgroundColor('#F5F7FA')
      .scrollBar(BarState.Off)

      // 4. åº•éƒ¨æ“ä½œæ 
      Row({ space: 16 }) {
        Button('ä¿å­˜ç›¸å†Œ')
          .backgroundColor(Color.White)
          .fontColor('#333')
          .border({ width: 1, color: '#E0E0E0' })
          .layoutWeight(1)
          .height(50)
          .borderRadius(25)
          .fontSize(16)
          .onClick(() => this.executeSave())

        Button('å‘é€ç»™å¥½å‹')
          .backgroundColor('#333')
          .fontColor('#FFF')
          .layoutWeight(1)
          .height(50)
          .borderRadius(25)
          .fontSize(16)
          .shadow({ radius: 10, color: 'rgba(0,0,0,0.2)', offsetY: 5 })
          .onClick(() => this.handleSystemShare())
      }
      .width('100%')
      .padding({ left: 24, right: 24, top: 16, bottom: 16 })
      .backgroundColor(Color.White)
      .shadow({ radius: 20, color: 'rgba(0,0,0,0.05)', offsetY: -5 })
    }
    .width('100%')
    .height('100%')
  }
}