import { router, promptAction } from '@kit.ArkUI';
import { FortuneManager } from '../common/FortuneManager';
import { UserManager } from '../common/UserManager';
import common from '@ohos.app.ability.common';

@Entry
@Component
struct SettingsPage {
  @State isPrivacyMode: boolean = false;
  private fortuneManager = FortuneManager.getInstance();
  private userManager = UserManager.getInstance();

  async aboutToAppear() {
    this.isPrivacyMode = await this.fortuneManager.isPrivacyMode();
  }

  async togglePrivacy(isOn: boolean): Promise<void> {
    this.isPrivacyMode = isOn;
    await this.fortuneManager.setPrivacyMode(isOn);
    promptAction.showToast({ message: isOn ? 'üîí ÈöêÁßÅÊ®°ÂºèÂ∑≤ÂºÄÂêØ' : 'üîì ÈöêÁßÅÊ®°ÂºèÂ∑≤ÂÖ≥Èó≠' });
  }

  handleLogout(): void {
    promptAction.showDialog({
      title: 'ÈÄÄÂá∫ÁôªÂΩï',
      message: 'Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÂΩìÂâçË¥¶Âè∑ÂêóÔºü',
      buttons: [
        { text: 'ÂèñÊ∂à', color: '#999999' },
        { text: 'ÈÄÄÂá∫', color: '#FF0000' }
      ]
    }, (err, data) => {
      if (data.index === 1) {
        this.userManager.logout();
        promptAction.showToast({ message: 'Â∑≤ÈÄÄÂá∫' });
        router.back();
      }
    });
  }

  handleAccountCancellation(): void {
    promptAction.showDialog({
      title: '‚ö†Ô∏è Ë¥¶Âè∑Ê≥®ÈîÄ',
      message: 'Ê≥®ÈîÄÂêéÔºåÊÇ®ÁöÑÊâÄÊúâÊï∞ÊçÆÔºàÂåÖÊã¨ÂøÉÂäõ„ÄÅÁâåÈòµËÆ∞ÂΩï„ÄÅ‰ºöÂëòÊùÉÁõäÔºâÂ∞ÜÊ∞∏‰πÖ‰∏¢Â§±‰∏îÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü',
      buttons: [
        { text: 'ÂèñÊ∂à', color: '#333333' },
        { text: 'Á°ÆËÆ§Ê≥®ÈîÄ', color: '#FF0000' }
      ]
    }, (err, data) => {
      if (data.index === 1) {
        // Ê®°ÊãüÊ≥®ÈîÄÈÄªËæë
        this.userManager.logout();
        promptAction.showToast({ message: 'Ë¥¶Âè∑Â∑≤Ê≥®ÈîÄ' });
        router.back();
      }
    });
  }

  handleFeedback(): void {
    // ÂÆûÈôÖÈ°πÁõÆ‰∏≠ÂèØ‰ª•Ë∑≥ËΩ¨Âà∞ÂèçÈ¶àÈ°µÈù¢ÊàñÊâìÂºÄÂÆ¢Êúç‰ºöËØù
    promptAction.showToast({ message: 'ËØ∑ÂèëÈÄÅÈÇÆ‰ª∂Ëá≥ alizabos@163.com ÂèçÈ¶àÈóÆÈ¢ò' });
  }

  handleShareApp(): void {
    // ÁÆÄÂçïÁöÑÂàÜ‰∫´ÊèêÁ§∫ÔºåÂÆûÈôÖÂèØË∞ÉÁî®Á≥ªÁªüÂàÜ‰∫´
    promptAction.showToast({ message: 'ÊÑüË∞¢ÂàÜ‰∫´ÔºÅÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø' });
  }

  @Builder
  InfoItem(icon: string, label: string, onClick?: () => void, showArrow: boolean = true, value: string = '') {
    Row() {
      Row() {
        Text(icon).fontSize(20).margin({ right: 12 })
        Text(label).fontSize(16).fontColor('#333')
      }
      Blank()
      Row() {
        if (value) {
          Text(value).fontSize(14).fontColor('#999').margin({ right: 4 })
        }
        if (showArrow) {
          Text('‚Ä∫').fontSize(18).fontColor('#CCC').margin({ bottom: 2 })
        }
      }
    }
    .width('100%')
    .height(56)
    .backgroundColor(Color.White)
    .padding({ left: 20, right: 20 })
    .borderRadius(16)
    .margin({ bottom: 12 })
    .onClick(() => {
      if (onClick) onClick();
    })
  }

  build() {
    Column() {
      // Ê†áÈ¢òÊ†è
      Row() {
        Button({ type: ButtonType.Normal, stateEffect: true }) {
          Text('<')
            .fontSize(24)
            .fontColor('#333')
            .fontWeight(FontWeight.Medium)
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          router.back();
        })
        
        Text('ËÆæÁΩÆ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .margin({ left: 16 })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(Color.White)

      Scroll() {
        Column() {
          // 1. ÈöêÁßÅËÆæÁΩÆ
          Text('ÈöêÁßÅ').fontSize(14).fontColor('#888').margin({ left: 8, top: 20, bottom: 8 }).width('100%')
          
          Row() {
            Row() {
              Text('üîí').fontSize(20).margin({ right: 12 })
              Column() {
                Text('ÈöêÁßÅ‰øùÊä§Ê®°Âºè').fontSize(16).fontColor('#333')
                Text('ÈöêËóèÈ¶ñÈ°µÊñáÂ≠óÂíåÂàÜ‰∫´ÂÜÖÂÆπ').fontSize(12).fontColor('#AAA').margin({ top: 2 })
              }.alignItems(HorizontalAlign.Start)
            }
            Toggle({ type: ToggleType.Switch, isOn: this.isPrivacyMode })
              .selectedColor('#FF69B4')
              .onChange((isOn: boolean) => this.togglePrivacy(isOn))
          }
          .width('100%')
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(16)
          .margin({ bottom: 12 })

          // 2. ÈÄöÁî®
          Text('ÈÄöÁî®').fontSize(14).fontColor('#888').margin({ left: 8, top: 20, bottom: 8 }).width('100%')
          this.InfoItem('üí¨', 'ÈóÆÈ¢òÂèçÈ¶à', () => this.handleFeedback())
          this.InfoItem('üîó', 'ÂàÜ‰∫´ App', () => this.handleShareApp())

          // 3. Ë¥¶Âè∑
          Text('Ë¥¶Âè∑').fontSize(14).fontColor('#888').margin({ left: 8, top: 20, bottom: 8 }).width('100%')
          this.InfoItem('‚ö†Ô∏è', 'Ë¥¶Âè∑Ê≥®ÈîÄ', () => this.handleAccountCancellation())
          
          Button('ÈÄÄÂá∫ÁôªÂΩï')
            .backgroundColor('#FFF0F5')
            .fontColor('#FF69B4')
            .width('100%')
            .height(50)
            .borderRadius(16)
            .margin({ top: 20 })
            .onClick(() => this.handleLogout())

        }
        .padding(20)
        .width('100%')
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F7F8FA')
  }
}
