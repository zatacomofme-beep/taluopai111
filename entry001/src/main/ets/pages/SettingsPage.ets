import { router, promptAction } from '@kit.ArkUI';
import { FortuneManager } from '../common/FortuneManager';
import { UserManager } from '../common/UserManager';
import common from '@ohos.app.ability.common';

@Entry
@Component
struct SettingsPage {
  @State isPrivacyMode: boolean = false;
  private fortuneManager = FortuneManager.getInstance();
  private userManager = UserManager.getInstance();

  async aboutToAppear() {
    this.isPrivacyMode = await this.fortuneManager.isPrivacyMode();
  }

  async togglePrivacy(isOn: boolean): Promise<void> {
    this.isPrivacyMode = isOn;
    await this.fortuneManager.setPrivacyMode(isOn);
    promptAction.showToast({ message: isOn ? 'ðŸ”’ éšç§æ¨¡å¼å·²å¼€å¯' : 'ðŸ”“ éšç§æ¨¡å¼å·²å…³é—­' });
  }

  handleLogout(): void {
    promptAction.showDialog({
      title: 'é€€å‡ºç™»å½•',
      message: 'ç¡®å®šè¦é€€å‡ºå½“å‰è´¦å·å—ï¼Ÿ',
      buttons: [
        { text: 'å–æ¶ˆ', color: '#999999' },
        { text: 'é€€å‡º', color: '#FF0000' }
      ]
    }, (err, data) => {
      if (data.index === 1) {
        this.userManager.logout();
        promptAction.showToast({ message: 'å·²é€€å‡º' });
        router.back();
      }
    });
  }

  handleAccountCancellation(): void {
    promptAction.showDialog({
      title: 'âš ï¸ è´¦å·æ³¨é”€',
      message: 'æ³¨é”€åŽï¼Œæ‚¨çš„æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬å¿ƒåŠ›ã€ç‰Œé˜µè®°å½•ã€ä¼šå‘˜æƒç›Šï¼‰å°†æ°¸ä¹…ä¸¢å¤±ä¸”æ— æ³•æ¢å¤ã€‚\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
      buttons: [
        { text: 'å–æ¶ˆ', color: '#333333' },
        { text: 'ç¡®è®¤æ³¨é”€', color: '#FF0000' }
      ]
    }, (err, data) => {
      if (data.index === 1) {
        // æ¨¡æ‹Ÿæ³¨é”€é€»è¾‘
        this.userManager.logout();
        promptAction.showToast({ message: 'è´¦å·å·²æ³¨é”€' });
        router.back();
      }
    });
  }

  handleFeedback(): void {
    // å®žé™…é¡¹ç›®ä¸­å¯ä»¥è·³è½¬åˆ°åé¦ˆé¡µé¢æˆ–æ‰“å¼€å®¢æœä¼šè¯
    promptAction.showToast({ message: 'è¯·å‘é€é‚®ä»¶è‡³ alizabos@163.com åé¦ˆé—®é¢˜' });
  }

  handleShareApp(): void {
    // ç®€å•çš„åˆ†äº«æç¤ºï¼Œå®žé™…å¯è°ƒç”¨ç³»ç»Ÿåˆ†äº«
    promptAction.showToast({ message: 'æ„Ÿè°¢åˆ†äº«ï¼é“¾æŽ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿' });
  }

  @Builder
  InfoItem(icon: string, label: string, onClick?: () => void, showArrow: boolean = true, value: string = '') {
    Row() {
      Row() {
        Text(icon).fontSize(20).margin({ right: 12 })
        Text(label).fontSize(16).fontColor('#333')
      }
      Blank()
      Row() {
        if (value) {
          Text(value).fontSize(14).fontColor('#999').margin({ right: 4 })
        }
        if (showArrow) {
          Text('â€º').fontSize(18).fontColor('#CCC').margin({ bottom: 2 })
        }
      }
    }
    .width('100%')
    .height(56)
    .backgroundColor(Color.White)
    .padding({ left: 20, right: 20 })
    .borderRadius(16)
    .margin({ bottom: 12 })
    .onClick(() => {
      if (onClick) onClick();
    })
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Image($r('app.media.ic_public_back')) // å‡è®¾æœ‰è¿™ä¸ªèµ„æºï¼Œæˆ–è€…ç”¨ Text æ›¿ä»£
          .width(24)
          .height(24)
          .onClick(() => router.back())
        
        Text('è®¾ç½®')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .margin({ left: 16 })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(Color.White)

      Scroll() {
        Column() {
          // 1. éšç§è®¾ç½®
          Text('éšç§').fontSize(14).fontColor('#888').margin({ left: 8, top: 20, bottom: 8 }).width('100%')
          
          Row() {
            Row() {
              Text('ðŸ”’').fontSize(20).margin({ right: 12 })
              Column() {
                Text('éšç§ä¿æŠ¤æ¨¡å¼').fontSize(16).fontColor('#333')
                Text('éšè—é¦–é¡µæ–‡å­—å’Œåˆ†äº«å†…å®¹').fontSize(12).fontColor('#AAA').margin({ top: 2 })
              }.alignItems(HorizontalAlign.Start)
            }
            Toggle({ type: ToggleType.Switch, isOn: this.isPrivacyMode })
              .selectedColor('#FF69B4')
              .onChange((isOn: boolean) => this.togglePrivacy(isOn))
          }
          .width('100%')
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(16)
          .margin({ bottom: 12 })

          // 2. é€šç”¨
          Text('é€šç”¨').fontSize(14).fontColor('#888').margin({ left: 8, top: 20, bottom: 8 }).width('100%')
          this.InfoItem('ðŸ’¬', 'é—®é¢˜åé¦ˆ', () => this.handleFeedback())
          this.InfoItem('ðŸ”—', 'åˆ†äº« App', () => this.handleShareApp())

          // 3. è´¦å·
          Text('è´¦å·').fontSize(14).fontColor('#888').margin({ left: 8, top: 20, bottom: 8 }).width('100%')
          this.InfoItem('âš ï¸', 'è´¦å·æ³¨é”€', () => this.handleAccountCancellation())
          
          Button('é€€å‡ºç™»å½•')
            .backgroundColor('#FFF0F5')
            .fontColor('#FF69B4')
            .width('100%')
            .height(50)
            .borderRadius(16)
            .margin({ top: 20 })
            .onClick(() => this.handleLogout())

        }
        .padding(20)
        .width('100%')
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F7F8FA')
  }
}
